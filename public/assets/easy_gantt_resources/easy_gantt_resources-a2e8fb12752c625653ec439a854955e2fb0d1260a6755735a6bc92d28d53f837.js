window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.resource=ysy.pro.resource||{},EasyGem.extend(ysy.pro.resource,{name:"Resource",doNotCloseToolPanel:!0,features:{},patch:function(){var e=ysy.pro.resource;for(var t in ysy.proManager.register("close",this.close),ysy.proManager.register("ganttConfig",this.ganttConfig),ysy.proManager.register("extendGanttTask",this.extendGanttTask),ysy.data.assignees=(new ysy.data.Array).init({_name:"AssigneeArray"}),ysy.data.allocations=(new ysy.data.Array).init({_name:"AllocationArray"}),this.classPatch(),this.renderer_patch(),this.features)if(this.features.hasOwnProperty(t)){var s=this[this.features[t]];s&&s.patch&&s.patch()}if(this.global_patch)this.global_patch();else{ysy.data.loader.register(function(){ysy.settings.resource.open&&this.loader.load()},this);var r=ysy.data.loader.loadSubEntity;ysy.data.loader.loadSubEntity=function(e,t){ysy.pro.resource.loader.loaded=!1,r.call(ysy.data.loader,e,t)}}this.decimalAllocation=ysy.settings.decimalAllocation,ysy.settings.resource_on&&EASY.schedule.late(()=>{this.open()}),$.extend(ysy.view.AllButtons.prototype.extendees,{resource:{bind:function(){this.model=ysy.settings.resource},func:function(){ysy.proManager.closeAll(e),ysy.settings.resource.open?e.close():e.open()},isOn:function(){return ysy.settings.resource.open!==ysy.settings.resource_on}}});var a=ysy.data.saver.afterSaveSuccess;ysy.data.saver.afterSaveSuccess=function(){ysy.settings.resource.open?e.saver.save(a,ysy.data.saver.afterSaveFail):a()};var o=ysy.view.GanttTasks.prototype._selectChildren;ysy.view.GanttTasks.prototype._selectChildren=function(){if(ysy.settings.resource.open){var e=this.model.getArray().slice(0);e.sort(function(e,t){return e._start_date-t._start_date});var t=ysy.data.assignees.getArray();return ysy.settings.reservationEnabled&&(t=t.concat(ysy.pro.resource.reservations.getRows())),ysy.settings.global&&ysy.settings.resource.buttons.withProjects&&(t=t.concat(ysy.data.resourceProjects.array)),t.concat(e)}return o.call(this)},gantt._tasks_dnd._handlers[gantt.config.drag_mode.move]=function(e,t,s){if(gantt._tasks_dnd._move(e,t,s),ysy.settings.resource.open&&"task"===gantt._get_safe_type(e.type)&&!e.readonly){var r=gantt.config.row_height;e.pos_y=Math.round(t.y/r)}};var n=gantt.allowedParent,i=function(e,t){if(!t||!ysy.settings.resource.open||!ysy.settings.global)return!0;if("task"!==gantt._get_safe_type(e.type)||"assignee"!==gantt._get_safe_type(t.type))return!1;if(!e.widget||!t.widget)return!1;var s=t.widget.model.id;if("unassigned"===s)return!0;var r=e.widget.model,a=ysy.data.projects.getByID(r.project_id);return!(!a||!a.members)&&a.members.indexOf(s)>=0};gantt.allowedParent=function(e,t){return!1!==i(e,t)&&n(e,t)},gantt.attachEvent("onBeforeTaskChanged",function(e,t){if(t===gantt.config.drag_mode.move){var s=gantt.getTask(e),r=s.pos_y;if(r){var a=gantt._order;s.pos_y=0;var o=gantt.getGlobalTaskIndex(e)+r;if(!(o<0||o>=a.length)){for(var n=gantt.getTask(a[o]),l=n.id;n&&"assignee"!==n.type;)l=n.parent,n=gantt._pull[l];if(n){var u=s.widget&&ysy.data.projects.getByID(s.widget.model.project_id);if(!i(s,n)){var c=ysy.settings.labels.errors2.assignToNonMember.replace("%{issue}",'"'+s.text+'"').replace("%{assignee}",'"'+n.text+'"');return u&&(c=c.replace("%{project}",'"'+u.name+'"')),void dhtmlx.message(c,"error")}if(l!==s.parent){var y="p"+u.id+n.id;gantt._pull[y]?gantt.open(y):ysy.data.limits.openings[y]=!0,gantt.open(l),gantt.moveTask(s.id,-1,l)}}}}}});var l=ysy.view.GanttTask.prototype._constructParentUpdate;ysy.view.GanttTask.prototype._constructParentUpdate=function(e){var t=l(e);return ysy.settings.resource.open?ysy.main.startsWith(e,"a")?"aunassigned"===e?{assigned_to_id:null}:{assigned_to_id:parseInt(e.substring(1))}:{}:t}},open:function(){var e=ysy.settings.resource;e.setSilent("open",!0)&&($("#easy_gantt").toggleClass("resource_management",!0).toggleClass("gantt",!1),this.bindRenderers(),ysy.proManager.fireEvent("ganttConfig",gantt.config),ysy.data.loader.loaded&&!this.loader.loaded&&this.loader.load(),e._fireChanges(this,"open"),$("#easy_gantt_type").val("rm"),ysy.data.loader.setHeading(!1))},close:function(e){if(e!==ysy.pro.toolPanel){var t=ysy.settings.resource;t.reservations&&(t.buttons.newReservation=!1,ysy.pro.resource.reservations.toggle()),t.setSilent("open",!1)&&($("#easy_gantt").toggleClass("resource_management",!1).toggleClass("gantt",!0),ysy.pro.resource.removeRenderers(),ysy.proManager.fireEvent("ganttConfig",gantt.config),t._fireChanges(this,"close"),$("#easy_gantt_type").val(""),ysy.data.loader.setHeading(!0))}},ganttConfig:function(e){ysy.settings.resource.open&&$.extend(e,{allowedParent_task:["assignee"],allowedParent_task_global:["assignee"]})},extendGanttTask:function(e,t){e.isIssue&&(t.spent=e.spent),e.isAssignee&&e.is_group&&(t.subtype="group"),"unassigned"===e.id&&(t.subtype="unassigned")}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.resource=ysy.pro.resource||{},EasyGem.extend(ysy.pro.resource,{classPatch:function(){if(ysy.data.Assignee=function(){ysy.data.Data.call(this),this.resources_sums={},this.dateHours={},this.events={}},ysy.main.extender(ysy.data.Data,ysy.data.Assignee,{_name:"Assignee",ganttType:"assignee",isAssignee:!0,dateHours:{},estimated_ratio:1,group_ids:null,user_ids:null,week_hours:ysy.settings.hoursOnWeek,_postInit:function(){var e=this.events;for(var t in e)e.hasOwnProperty(t)&&this.applyResourceEvents(t,e[t])},applyResourceEvents:function(e,t){for(var s=ysy.view.bars,r=0;r<t.length;r++){var a=t[r];switch(a.type){case"meeting":case"nonworking_attendance":case"easy_holiday_event":if(a.hours===undefined)this.dateHours[e]=0,a.hours=this.week_hours[(s.getFromDateCache(e).day()+6)%7];else{var o=this.week_hours[(s.getFromDateCache(e).day()+6)%7];this.dateHours[e]!==undefined&&(o=this.dateHours[e]),this.dateHours[e]=Math.max(o-a.hours,0)}this.resources_sums[e]=this.resources_sums[e]||0}}},getID:function(){return"a"+this.id},getParent:function(){return!1},pushFollowers:function(){},isOpened:function(){var e=ysy.data.limits.openings[this.getID()];return e===undefined?!ysy.settings.global:e},getProblems:function(){return!1},getEvents:function(e){return this.events[e]},getMaxHours:function(e,t){return this.dateHours[e]!==undefined?this.dateHours[e]:(t||(t=ysy.view.bars.getFromDateCache(e)),this.week_hours[(t.day()+6)%7])},getMaxHoursInterval:function(e,t,s){t=t||e;for(var r=moment(t).add(1,s+"s"),a=moment(t),o=0;a.isBefore(r);)o+=this.getMaxHours(a.format("YYYY-MM-DD"),a),a.add(1,"days");return o}}),ysy.data.IssueAllocations=function(){this.resources=null,this.allocPack=null,this.changesLock=!1,ysy.data.Data.call(this)},ysy.main.extender(ysy.data.Data,ysy.data.IssueAllocations,{_name:"IssueAllocation",init:function(e,t){this.resources=e.resources,this.issue=e.issue,this.id=e.id,this.allocator=e.allocator,this.allocPack=ysy.pro.resource.resourcesToAllocations(this),this._parent=t,this._postInit()},_postInit:function(){this.issue._changed&&this.recalculate(),this.issue.register(function(e){if(ysy.log.debug(this.issue.name+"._fireChanges("+e+")","allocate"),"set"===e||"revert"===e){if(this.changesLock)return;this.recalculate();var t=this.getAssignee(this.issue);if(t&&t.group_ids)for(var s=ysy.data.assignees,r=0;r<t.group_ids.length;r++){var a=s.getByID(t.group_ids[r]);a&&a._fireChanges(this,e)}}},this)},allocatable:function(){return!this.issue.closed},recalculate:function(e){if(this.allocatable()){var t=ysy.pro.resource.calculateAllocations(this,{});if(!this._compareAllocPacks(t,this.allocPack)){if(ysy.log.debug("recalculate for "+this.issue.name,"allocate"),e)var s={allocPack:this.allocPack,resources:this.resources,_changed:this._changed};this.allocPack=t,this.resources=ysy.pro.resource.allocationsToFixedResources(this.allocPack),this._changed=!0,this.changesLock=!0,this._fireChanges(this,"recalculate"),this.changesLock=!1,e&&ysy.history.add(s,this)}}},getAssignee:function(e){return(e=e||this.issue)?ysy.data.assignees.getByID(e.assigned_to_id):null},getLimitResourceDates:function(){var e=Object.getOwnPropertyNames(this.resources).sort();return e.length?{start_date:moment(e[0]),end_date:moment(e[e.length-1])}:null},_fireChanges:function(e,t){ysy.log.debug(this.issue.name+"Alloc._fireChanges("+t+")","allocate"),this.__proto__.__proto__._fireChanges.call(this,e,t),this.changesLock||"revert"===t||this.recalculate();var s=this.issue;this.changesLock=!0,s&&s._fireChanges(e,t),this.changesLock=!1},_compareAllocPacks:function(e,t){if(!e||!t)return!1;for(var s=["allocations","types"],r=0;r<s.length;r++){var a=e[s[r]],o=t[s[r]];if(a||o){if(!a||!o)return!1;var n=Object.getOwnPropertyNames(a).filter(function(e){return a[e]}).sort(),i=Object.getOwnPropertyNames(o).filter(function(e){return o[e]}).sort();if(n.length!==i.length)return!1;for(var l=0;l<n.length;l++){if(n[l]!==i[l])return!1;var u=i[l];if(a[u]!==o[u])return!1}}}return!0}}),$.extend(!0,ysy.data.Issue.prototype,{getAllocations:function(){if(this.closed)return null;var e=ysy.data.allocations.getByID(this.id);return e?e.allocPack:null},getAllocationInstance:function(){var e=ysy.data.allocations.getByID(this.id);if(!e){var t=ysy.data.allocations;(e=new ysy.data.IssueAllocations).init({id:this.id,resources:{},issue:this,allocator:this.custom_resource_allocator_name},t),t.pushSilent(e),t._fireChanges(this,"init for new")}return e},_oldGetParent:ysy.data.Issue.prototype.getParent,getParent:function(){if(ysy.settings.resource.open){var e=this.assigned_to_id||"unassigned";if(ysy.settings.global&&ysy.settings.resource.buttons.withProjects){var t=this.project_id+"a"+e;if(ysy.data.resourceProjects.getByID(t))return"p"+t}return ysy.data.assignees.getByID(e)?"a"+e:null}return this._oldGetParent()},getRestEstimated:function(){var e=ysy.data.assignees.getByID(this.assigned_to_id);return e&&1!==e.estimated_ratio?(this.estimated_hours||0)*e.estimated_ratio-(this.spent||0):(this.estimated_hours||0)-(this.spent||0)},problems:{checkEstimated:function(){var e=this.getRestEstimated();if(e<0)return ysy.settings.labels.problems.underEstimated.replace("%{over}",(-e).toFixed(2).toString());var t=this.getAllocations();if(t){var s=t.types;for(var r in s)if(s.hasOwnProperty(r)&&s[r]&&"fixed"!==s[r])return ysy.settings.labels.problems[s[r]].replace("%{date}",moment(r).format(gantt.config.date_format))}}},_dateSetHelper:function(e){var t=ysy.settings.resource.open;return e.start_date&&(!t&&e.start_date.isSame(this._start_date)?delete e.start_date:e._start_date=e.start_date),e.end_date&&(!t&&e.end_date.isSame(this._end_date)?delete e.end_date:e._end_date=e.end_date),e},getAllocator:function(){var e=ysy.data.projects.getByID(this.project_id);return e&&e.allocator?e.allocator:"from_end"}}),ysy.view.Legend){var e=ysy.view.Legend.prototype.out,t=ysy.view.Legend.prototype._postInit;$.extend(ysy.view.Legend.prototype,{_postInit:function(){var e=ysy.view.getTemplate(this.templateName);this.template=ysy.view.templates.resourceLegend.replace("{{nonResourceLegend}}",e),t.call(this),this._register(ysy.settings.resource),this._register(ysy.settings.zoom),ysy.settings.labels.legend_symbols.length===undefined&&(ysy.settings.labels.legend_symbols=s(ysy.settings.labels.legend_symbols),ysy.settings.labels.legend_colors=s(ysy.settings.labels.legend_colors))},out:function(){if(ysy.settings.resource.open){var t={resources:!0};if("day"!==ysy.settings.zoom.zoom){t.backColors=ysy.settings.labels.legend_colors.slice();for(var s=0;s<t.backColors.length;s++){var r=t.backColors[s];if(!r.color){var a=ysy.pro.resource.renderStyles[r.colorName];a&&(r.color=a)}}}for(t.symbols=ysy.settings.labels.legend_symbols.slice(),s=0;s<t.symbols.length;s++){var o=t.symbols[s];o.color||(a=ysy.pro.resource.renderStyles[o.colorName])&&(o.color=a)}return ysy.proManager.fireEvent("RmLegendOut",t),t}return e.call(this)}})}ysy.data.ResourceProject=function(){ysy.data.Project.call(this),this.allocPack=null},ysy.main.extender(ysy.data.Project,ysy.data.ResourceProject,{_name:"ResourceProject",_postInit:function(){this.assigned_to_id=this.assigned_to_id||"unassigned",this.real_id=this.id,this.id=this.id+"a"+this.assigned_to_id,this.__proto__.__proto__._postInit()},getParent:function(){return!!ysy.data.assignees.getByID(this.assigned_to_id)&&"a"+this.assigned_to_id},getAllocations:function(){return null},getProgress:function(){var e=ysy.data.issues.getArray();if(0===e.length)return 0;for(var t,s=0,r=0,a=0;a<e.length;a++){var o=e[a];o.project_id===this.real_id&&(s+=t=o.estimated_hours?o.estimated_hours:o.getDuration("hours"),r+=t*o.done_ratio/100)}return r/s}});var s=function(e){for(var t=[],s=Object.getOwnPropertyNames(e).sort(),r=0;r<s.length;r++)t.push(e[s[r]]);return t}}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.resource=ysy.pro.resource||{},EasyGem.extend(ysy.pro.resource,{MARGIN:.05,renderStyles:{},compiledStyles:{},renderer_patch:function(){$.extend(gantt.templates,{grid_bullet_assignee:function(e){return e&&e.widget&&e.widget.model&&e.widget.model.avatar?'<div class="gantt_tree_icon gantt-assignee-avatar-bullet">'+e.widget.model.avatar+"</div>":"<div class='gantt_tree_icon gantt-assignee-bullet'></div>"},superitem_after_assignee:function(e){var t=e.widget&&e.widget.model;if(t._unassigned)return"";for(var s=[],r=0;r<7;r++)if(t.week_hours[r]!==t.__proto__.week_hours[r]){s.push(ysy.settings.labels.maxHours+": "+JSON.stringify(t.week_hours));break}return 1!==t.estimated_ratio&&s.push(ysy.settings.labels.estimatedRatio+": "+t.estimated_ratio),0===s.length?"":'<span class="gantt-superitem-after">('+s.join(", ")+")</span>"}}),this.compileStyles()},compileStyles:function(){this.renderStyles=ysy.settings.styles.resource,this.compiledStyles.wrong={fontStyle:this.renderStyles.fontBold,textColor:this.renderStyles.wrong},this.compiledStyles.fixed={fontStyle:this.renderStyles.fontBold,textColor:this.renderStyles.fixed},this.compiledStyles.normal={fontStyle:this.renderStyles.fontNormal,textColor:this.renderStyles.normal}},bindRenderers:function(){ysy.view.bars.registerRenderer("assignee",this.assignee_canvas_renderer),ysy.view.bars.registerRenderer("project",this.projectRenderer),ysy.view.bars.registerRenderer("task",this.taskRenderer),ysy.view.bars.registerRenderer("reservation",this.taskRenderer)},removeRenderers:function(){ysy.view.bars.removeRenderer("assignee",this.assignee_canvas_renderer),ysy.view.bars.removeRenderer("project",this.projectRenderer),ysy.view.bars.removeRenderer("task",this.taskRenderer),ysy.view.bars.removeRenderer("reservation",this.taskRenderer)},taskRenderer:function(e,t){var s=t().call(this,e,t);$(s).removeClass("gantt_parent_task-subtype");var r=ysy.pro.resource,a=$.proxy(r.issue_canvas_renderer,gantt)(e);if(a&&ysy.view.bars.insertCanvas(a,s),e.pos_y&&(s.style.transform="translate(0,"+(e.pos_y*gantt.config.row_height||0)+"px)"),ysy.settings.resource.withMilestones){var o=$.proxy(r.milestones.milestone_renderer,gantt)(e);o&&s.appendChild(o)}return s},projectRenderer:function(e,t){var s=t().call(this,e,t),r=$.proxy(ysy.pro.resource.project_canvas_renderer,gantt)(e);return r&&ysy.view.bars.insertCanvas(r,s),s},issue_canvas_renderer:function(e){var t=ysy.pro.resource;if(e.widget){var s=e.widget.model.getAllocations();if(null!==s){var r=ysy.view.bars.canvasListBuilder();r.build(e,this),"day"!==ysy.settings.zoom.zoom?$.proxy(t.issue_week_renderer,this)(e,s,r):$.proxy(t.issue_day_renderer,this)(e,s,r);var a=r.getElement(),o=null;return a.onclick=function(e){e.stopPropagation();var t=new MouseEvent(e.type,e);o||(o=setTimeout(function(){o=null,a.parentNode.dispatchEvent(t)},300))},e.widget.model.isEditable()&&(a.ondblclick=function(e){o&&(clearTimeout(o),o=null),$.proxy(t.allocationChange,a)(e,s.allocations)}),(a=r.getElement()).className+=" gantt-task-tooltip-area",a}}},project_canvas_renderer:function(e){var t=ysy.pro.resource,s=t.countSubAllocations(this,e.widget.model),r=ysy.view.bars.canvasListBuilder();r.build(e,this),"day"!==ysy.settings.zoom.zoom?$.proxy(t.issue_week_renderer,this)(e,s,r):$.proxy(t.issue_day_renderer,this)(e,s,r);var a=r.getElement();return a.className+=" project",a},issue_day_renderer:function(e,t,s){var r=ysy.pro.resource,a=t.allocations,o=r.compiledStyles;for(var n in a)if(a.hasOwnProperty(n)){var i=moment(n);if(!(i.isBefore(e.start_date)||e.end_date.diff(i,"days")<-1)){var l=a[n];if(l!==undefined){if(!s.inRange(n))return;if(t.types[n])if("fixed"===t.types[n])var u=o.fixed;else u=o.wrong;else{if(!l)continue;u=o.normal}var c=r.roundTo1(l);s.fillTextAt(n,c,u)}}}},issue_week_renderer:function(e,t,s){var r=ysy.pro.resource,a=ysy.settings.zoom.zoom,o=r._weekAllocationSummer(t,a,e.start_date,e.end_date),n=o.allocations,i=r.compiledStyles;for(var l in n)if(n.hasOwnProperty(l)&&s.inRange(l)){var u=n[l];if(0!==u){if(o.types[l])if("fixed"===o.types[l])var c=i.fixed;else c=i.wrong;else c=i.normal;var y=r.roundTo1(u);s.fillTextAt(l,y,c)}}},assignee_canvas_renderer:function(e){var t=ysy.pro.resource;if(e.widget&&!e.widget.model._unassigned){var s=e.widget.model,r=s.resources_sums,a=t.countSubAllocations(this,e.widget.model),o=a.allocations;for(var n in r)r.hasOwnProperty(n)&&(o[n]=(o[n]||0)+r[n]);ysy.settings.resource.buttons.hidePlanned&&t.planned.subtractPlanned(o,s);var i=ysy.view.bars.canvasListBuilder();i.build(e,this,this._min_date,this._max_date),ysy.settings.resource.freeCapacity?"day"!==ysy.settings.zoom.zoom?$.proxy(t.freeCapacity.assignee_week_renderer,this)(e,s,a,i):$.proxy(t.freeCapacity.assignee_day_renderer,this)(e,s,a,i):"day"!==ysy.settings.zoom.zoom?$.proxy(t.assignee_week_renderer,this)(e,s,a,i):$.proxy(t.assignee_day_renderer,this)(e,s,a,i);var l=i.getElement();return l.className+=" assignee",l.onmousedown=$.proxy(t.events.onMouseDown,l),l.onclick=function(e){$.proxy(t.events.onClick,l)(e,s)},l}},assignee_day_renderer:function(e,t,s,r){var a=ysy.pro.resource,o=this._min_date.valueOf(),n=moment(this._max_date).add(1,"days").valueOf(),i=s.allocations;for(var l in i)if(i.hasOwnProperty(l)){var u=moment(l);+u<o||+u>n||a.assignee_one_day_renderer.call(this,l,u,t,i[l],t.getEvents(l),s.types[l],r)}},assignee_one_day_renderer:function(e,t,s,r,a,o,n){var i=ysy.pro.resource;if(!(r<i.MARGIN&&r>-i.MARGIN)||a&&a.length){var l=null;if(a&&a.length>0){l={};for(var u=0;u<a.length;u++){var c=a[u];l[c.type]===undefined&&(l[c.type]=0),l[c.type]+=c.hours}}if(n.inRange(e)){if(ysy.settings.resource.freeCapacity)var y=r<0;else{var d=s.getMaxHours(e,t);y=d<r}var g=i.compiledStyles;if(y||o&&"fixed"!==o)var h=g.wrong;else h="fixed"===o?g.fixed:g.normal;i.renderTextIn(e,r,l,n,d,h)}}},assignee_week_renderer:function(e,t,s,r){var a=ysy.pro.resource,o=a._weekAllocationSummer(s,ysy.settings.zoom.zoom,this._min_date,this._max_date,t),n=o.allocations,i=o.types,l=o.events;for(var u in n)n.hasOwnProperty(u)&&a.assignee_one_week_renderer.call(this,u,null,t,n[u],l[u],i[u],r)},assignee_one_week_renderer:function(e,t,s,r,a,o,n){var i=ysy.pro.resource;if((!(r<i.MARGIN&&r>-i.MARGIN)||a)&&n.inRange(e)){var l=i.renderStyles;if(ysy.settings.resource.freeCapacity)var u=s,c=1-r/(s||.001);else c=r/((u=s.getMaxHoursInterval(e,t,ysy.settings.zoom.zoom))||.001);var y={};0!==c&&(y.backgroundColor=i.occupationToColor(c),y.shrink=!0),o?(y.fontStyle=l.fontBold,y.textColor="fixed"===o?l.fixed:l.wrong):(y.fontStyle=l.fontNormal,y.textColor=l.normal),i.renderTextIn(e,r,a,n,u,y)}},roundTo1:function(e){if(!e)return"";var t=(e=parseFloat(e))%1;return t<0&&(t+=1),t<this.MARGIN||t>1-this.MARGIN?e.toFixed():e.toFixed(1)},occupationToColor:function(e){if(0!==e){var t=ysy.pro.resource.renderStyles;return e>1?t.overAllocations:e>.7?t.fullAllocations:t.someAllocations}},renderTextIn:function(e,t,s,r,a,o){var n=r.columnWidth;if(s){const e=ysy.settings.labels.eventTypes.symbols;var i={easy_holiday_event:e.easy_holiday_event_short,meeting:e.meeting_short,nonworking_attendance:e.nonworking_attendance_short,unapproved_nonworking_attendance:e.unapproved_nonworking_attendance_short},l=[],u="meeting";s[u]&&l.push(i[u]+this.roundTo1(s[u])),s[u="nonworking_attendance"]&&l.push(i[u]+this.roundTo1(s[u])),s[u="unapproved_nonworking_attendance"]&&l.push(i[u]+this.roundTo1(s[u])),s[u="easy_holiday_event"]!=undefined&&l.push(i[u]+(s.isWeek?this.roundTo1(s[u]):""))}var c=l&&l.length;if(t>this.MARGIN||t<-this.MARGIN)if(a===undefined||n<40)var y=this.roundTo1(t);else{var d=" / ";n<55&&(d="/"),y=this.roundTo1(t)+d+this.roundTo1(a)}if(c)var g=l.join(",");r.fillTwoTextAt(e,g,y,o)},countSubAllocations:function(e,t){var s={},r={};t.isAssignee&&t.is_group&&t.user_ids&&this._groupAllocationSummer(t.user_ids,s);for(var a=ysy.data.issues.getArray(),o=0;o<a.length;o++){var n=a[o];if(t.isProject){if(n.project_id!==t.real_id||n.assigned_to_id!==t.assigned_to_id)continue}else if(n.assigned_to_id!==t.id)continue;var i=n.getAllocations();if(null!==i){var l=i.allocations,u=i.types;for(var c in l)l.hasOwnProperty(c)&&(u[c]&&(r[c]!==undefined&&"fixed"!==r[c]||(r[c]=u[c])),l[c]<=0||(s[c]===undefined?s[c]=l[c]:s[c]+=l[c]))}}return{allocations:s,types:r}},_groupAllocationSummer:function(e,t){for(var s=0;s<e.length;s++){var r=ysy.data.assignees.getByID(e[s]);if(r){var a=this.countSubAllocations(this,r).allocations;for(var o in a)a.hasOwnProperty(o)&&(t[o]===undefined?t[o]=a[o]:t[o]+=a[o])}}},_weekAllocationSummer:function(e,t,s,r,a){var o=ysy.view.bars,n=s.valueOf(),i=moment(r).add(1,"days").valueOf(),l=(ysy.pro.resource.MARGIN,{}),u={},c=e.allocations,y=e.types,d={};for(var g in c)if(c.hasOwnProperty(g)){var h=o.getFromDateCache(g);if(!(+h<n||+h>i)){var f=c[g],p=moment(h).startOf("week"===t?"isoWeek":t).toISOString();if(a){a.getMaxHours(g,h)<f&&(u[p]="wrong");var _=a.getEvents(g);if(_&&_.length>0){var v=d[p];v||(v={isWeek:!0},d[p]=v);for(var m=0;m<_.length;m++){var w=_[m];v[w.type]===undefined&&(v[w.type]=0),v[w.type]+=w.hours}}}l[p]===undefined?l[p]=f:l[p]+=f,y[g]&&(u[p]!==undefined&&"fixed"!==u[p]||(u[p]=y[g]))}}return{allocations:l,types:u,events:d}}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.resource=ysy.pro.resource||{},ysy.pro.resource.loader=ysy.pro.resource.loader||{},EasyGem.extend(ysy.pro.resource.loader,{_name:"Resource Loader",loaded:!1,inited:!1,_onChange:[],load:function(){if(ysy.settings.resource.buttons=ysy.settings.resource.buttons||{},this.buttons=ysy.settings.resource.buttons,this.loading)return;this.loaded=!1,this.loading=!0,ysy.log.debug("load()","load");for(var e,t,s=ysy.data.issues.getArray(),r=ysy.data.projects.getArray(),a=[],o=[],n=0;n<s.length;n++){var i=s[n];i._start_date&&i._end_date?(i.id<1e12&&a.push(i.id),e&&!i._start_date.isBefore(e)||(e=i._start_date),t&&!i._end_date.isAfter(t)||(t=i._end_date)):ysy.log.warning("issue "+i.name+" have missing"+(i._start_date?"":" _start_date")+(i._end_date?"":" _end_date"))}if(0!==r.length)for(n=0;n<r.length;n++){var l=r[n];l.needLoad||o.push(l.id),l.start_date&&l.end_date&&(e&&!l.start_date.isBefore(e)||(e=l.start_date),t&&!l.end_date.isAfter(t)||(t=l.end_date))}e=moment(e).subtract(1,"months"),t=moment(t).add(1,"months");const u=(this.buttons.onlyTask?"onlyTask":this.buttons.onlyReservation&&"onlyReservation")||"allData";ysy.gateway.polymorficPostJSON(ysy.settings.paths.projectResourceUrl.replace(":projectID",ysy.settings.projectID).replace(":start",e.format("YYYY-MM-DD")).replace(":end",t.format("YYYY-MM-DD")),{variant:u,issue_ids:a,project_ids:o},$.proxy(this._handleResourceData,this),function(){ysy.log.error("Error: Unable to load data"),ysy.pro.resource.loader.loading=!1})},_handleResourceData:function(e){if(e.easy_resource_data){var t=e.easy_resource_data;ysy.log.debug("_handleResourceData()","load"),this._loadResourceLimits(t),ysy.data.assignees.clear(),ysy.data.allocations.clear(),ysy.data.resourceReservations&&ysy.data.resourceReservations.clear(),this._loadAssignees(t.users),this._enhanceProjects(t.projects),this._loadRMIssues(t.issues),ysy.data.relations._fireChanges(this,"resources loaded"),this._loadReservations&&this._loadReservations(t.reservations),this._removeProjectAllocationsFromSums(),ysy.log.debug("resource data loaded","load"),ysy.log.message("resource JSON loaded"),this._fireChanges(),this.loading=!1,this.loaded=!0}},loadAssignee:function(e){var t=ysy.data.limits.start_date,s=ysy.data.limits.end_date;ysy.gateway.polymorficGetJSON(ysy.settings.paths.globalResourceUrl,{assigned_to_id:e,resources_start_date:t?moment(t).format("YYYY-MM-DD"):undefined,resources_end_date:s?moment(s).format("YYYY-MM-DD"):undefined},$.proxy(this._handleAssigneeData,this),function(){ysy.log.error("Error: Unable to load data")})},_handleAssigneeData:function(e){if(e.easy_resource_data){var t=e.easy_resource_data,s="unassigned";t.issues.length?s=t.issues[0].assigned_to_id:t.reservations&&t.reservations.length&&(s=t.reservations[0].assigned_to_id),this._loadRMProjects&&this._loadRMProjects(t.projects,s),this._loadReservations&&this._loadReservations(t.reservations),ysy.data.loader._loadIssues(t.issues,s),ysy.data.loader._loadMilestones(t.versions);var r=this._loadRMIssues(t.issues);this._removeAllocationsFromSums(r),ysy.pro.resource.planned&&ysy.pro.resource.planned.assigneeAfterLoad(s),ysy.log.debug("minor data loaded","load")}},register:function(e,t){this._onChange.push({func:e,ctx:t})},_fireChanges:function(){for(var e=0;e<this._onChange.length;e++){var t=this._onChange[e].ctx;t&&!t.deleted?(ysy.log.log("-- changes to "+t.name+" widget"),$.proxy(this._onChange[e].func,t)()):this._onChange.splice(e,1)}},_loadAssignees:function(e){var t=ysy.data.assignees,s=new ysy.data.Assignee;ysy.settings.withoutUnassigned||(s.init({id:"unassigned",name:ysy.settings.labels.titles.unassigned,_unassigned:!0},t),t.pushSilent(s));for(var r=0;r<e.length;r++){var a=e[r];ysy.main._resourcesStringToFloat(a.resources_sums),(s=new ysy.data.Assignee).init(a,t),t.pushSilent(s)}t._fireChanges(this,"load")},_loadRMIssues:function(e){if(e){for(var t=ysy.data.issues,s=ysy.data.allocations,r=[],a=0;a<e.length;a++){var o=e[a],n=t.getByID(o.id);if(n&&(this._enhanceIssue(n,o),!o.closed)){o.issue=n;var i=new ysy.data.IssueAllocations;if(ysy.main._resourcesObjectToFloat(o.resources),i.init(o,s),s.pushSilent(i),r.push(i),!n.start_date||!n.end_date)var l=i.getLimitResourceDates();l&&(!n.start_date&&l.start_date.isBefore(n._start_date)&&(n._start_date=l.start_date),!n.end_date&&l.end_date.isAfter(n._end_date)&&(n._end_date=l.end_date)),n._fireChanges(this,"load spent")}}return s._fireChanges(this,"load"),r}},_enhanceIssue:function(e,t){e.spent=t.spent,t.permissions&&$.extend(e.permissions,t.permissions)},_enhanceProjects:function(e){if(e)for(var t=ysy.data.projects,s=0;s<e.length;s++){var r=t.getByID(e[s].id);r&&(r.setSilent(e[s]),r._fireChanges(this,"project RM enhance"))}},_removeProjectAllocationsFromSums:function(){var e=ysy.data.allocations.getArray();this._removeAllocationsFromSums(e)},_removeAllocationsFromSums:function(e){for(var t=0;t<e.length;t++){var s=e[t],r=s.getAssignee();if(r){var a=this._getGroupsOfUser(r);if(a){var o=s.allocPack.allocations;for(var n in o)if(o.hasOwnProperty(n)&&r.resources_sums[n]){var i=o[n];if(!(i<=0)){r.resources_sums[n]-=i;for(var l=0;l<a.length;l++){a[l].resources_sums[n]-=i}}}}else for(n in o=s.allocPack.allocations)o.hasOwnProperty(n)&&r.resources_sums[n]&&(o[n]<=0||(r.resources_sums[n]-=o[n]))}}},_getGroupsOfUser:function(e){var t=e.group_ids;if(!t)return null;for(var s=[],r=0;r<t.length;r++){var a=ysy.data.assignees.getByID(t[r]);a&&s.push(a)}return s},_loadResourceLimits:function(e){var t=moment(e.resources_end_date,"YYYY-MM-DD");t._isEndDate=!0,ysy.data.limits.setSilent({start_date:moment(e.resources_start_date,"YYYY-MM-DD"),end_date:t})&&ysy.data.limits._fireChanges(this,"resourceLimits")}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.resource=ysy.pro.resource||{},ysy.pro.resource.saver=ysy.pro.resource.saver||{},EasyGem.extend(ysy.pro.resource.saver,{temp:{},save:function(e,t){var s=this;this.temp={successCallback:e,failCallback:t,fails:0,failMessages:[],successes:0,requests:0};for(var r=ysy.data.allocations.getArray(),a=ysy.data.issues,o=[],n=[],i=0;i<r.length;i++){var l=r[i],u=a.getByID(l.id);if(u&&((u.start_date||u.end_date)&&l._changed&&l.allocatable())){l._oldAllocator&&(n.push({issue_id:u.id,allocator:l.allocator}),l._oldAllocator=null);var c=l.allocPack,y=c.allocations,d=c.types;for(var g in y)if(y.hasOwnProperty(g)){var h={issue_id:u.id,user_id:u.assigned_to_id,hours:y[g],date:g,custom:"fixed"===d[g]};o.push(h)}}}return ysy.settings.reservationEnabled&&ysy.pro.resource.reservations.save(),(o.length>0||n.length>0)&&(this.temp.requests++,ysy.gateway.polymorficPut(ysy.settings.paths.updateResourceUrl,null,{resources:o,allocators:n},this.onSuccess,function(e){var r=[];try{var o=JSON.parse(e.responseText)}catch(b){return""===e.responseText?t([e.statusText]):t([e.responseText])}var n=o.errors;if(!n)return t([e.responseText]);if(1===n.length&&403===e.status)return t([n[0]]);for(var i={},l=0;l<n.length;l++){var u=n[l];u&&(i[u.issue_id]||(i[u.issue_id]=[]),i[u.issue_id].push(u))}var c=Object.getOwnPropertyNames(i),y=ysy.view.templates.resourceSaveErrors,d=ysy.data.assignees;for(l=0;l<c.length;l++){for(var g=i[c[l]],h=[],f=g[0],p=f.reason||"Unknown reason",_=d.getByID(f.user_id),v=a.getByID(f.issue_id),m=0;m<Math.min(g.length,11);m++)h.push(g[m].hours);g.length>11&&h.push("...");var w=Mustache.render(y,{name:v?v.name:"#"+f.issue_id,allocations:h,assignee:_?_.name:"Unassigned",reason:p});r.push(w)}s.onFail(r)})),this.finishSaving()},startRequest:function(){ysy.pro.resource.saver.temp.requests++},onSuccess:function(){ysy.pro.resource.saver.temp.successes++,ysy.pro.resource.saver.finishSaving()},onFail:function(e){var t=ysy.pro.resource.saver.temp;t.fails++,t.failMessages=t.failMessages.concat(e),ysy.pro.resource.saver.finishSaving()},finishSaving:function(){var e=ysy.pro.resource.saver.temp;if(e.successes+e.fails===e.requests)return e.fails>0?e.failCallback(e.failMessages):e.successCallback()}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.resource=ysy.pro.resource||{},EasyGem.extend(ysy.pro.resource,{bogusAssignee:{getMaxHours:function(e,t){return ysy.data.Assignee.prototype.getMaxHours(e,t)}},calculateAllocations:function(e,t){var s,r,a={},o=[],n=[],i={},l=0,u={},c=this.MARGIN,y=t.issue||e.issue,d="number"==typeof t.estimated?t.estimated:y.getRestEstimated(),g=t.start_date||y._start_date||y.start_date,h=t.end_date||y._end_date||y.end_date,f=t.assignee||e.getAssignee(y)||this.bogusAssignee,p=t.allocator||e.allocator||y.getAllocator(),_=t.resources||e.resources||{};if(!g.isValid()||!h.isValid()||h.isBefore(g))return null;if("future_"===p.substring(0,7)){p=p.substring(7);var v=t.today?moment(t.today):moment().startOf("day");g.isBefore(v)?v.isAfter(h)&&(v=moment(h)):v=moment(g)}else v=moment(g);for(var m=Object.getOwnPropertyNames(_),w=g.format("YYYY-MM-DD"),b=h.format("YYYY-MM-DD"),k=0;k<m.length;k++)if(!((D=m[k])<w||D>b)){o.push(D);var A=_[D];A&&A.custom&&(a[D]=A.hours,d-=A.hours,u[D]="fixed")}for(;!v.isAfter(h);){var D=v.format("YYYY-MM-DD");o.push(D),(A=_[D])&&A.custom?v.add(1,"days"):(s=f.getMaxHours(D,v),i[D]=s,l+=s,0!==s&&n.push(D),a[D]=0,v.add(1,"days"))}if(m.length&&o.sort(),d<=c)return{allocations:a,types:u};if(d>=l){d=this._fullAllocator(d,n,a,i);var x=this._getOverflowDate(o,u,i);return x||(delete u[x=o[o.length-1]],i[x]=f.getMaxHours(D)),a[x]=(a[x]||0)+d,this.addAllocationTypes(o,a,u,i)}if("evenly"===p)(d=this._firstAllocator(d,n,a,i))>n.length&&(d=this._secondAllocator(d,n,a,i)),0!==d&&this._thirdAllocator(d,n,a,i);else{var M="from_start"===p;0===l?(delete u[r=n[M?0:n.length-1]],a[r]+=d):(d=this._gradualAllocator(d,n,a,i,M))>0&&(a[n[M?0:n.length-1]]+=d)}return this.addAllocationTypes(o,a,u,i)},_fullAllocator:function(e,t,s,r){for(var a=t.length-1;a>=0;a--)e-=s[t[a]]=r[t[a]];return e},_firstAllocator:function(e,t,s,r){var a,o,n;for(o=this.decimalAllocation?Math.floor(e/t.length*10)/10:Math.floor(e/t.length),a=t.length-1;a>=0;a--)r[n=t[a]]<o?s[n]=r[n]:s[n]=o,e-=s[n];return e},_secondAllocator:function(e,t,s,r){var a,o;if(this.decimalAllocation)var n=Math.floor(e/t.length*10)/10;else n=Math.floor(e/t.length);if(0===n)return e;for(a=0;a<t.length;a++)r[o=t[a]]<=s[o]||(s[o]+=n,e-=n);return e},_thirdAllocator:function(e,t,s,r){for(var a,o,n=this.MARGIN,i=this.decimalAllocation?.1:1;e>n;)for(a=t.length-1;a>=0;a--){if(i>e&&(i=e),r[o=t[a]]<=s[o]+i){var l=s[o];s[o]=r[o],e-=r[o]-l}else s[o]+=i,e-=i;if(0===e)return}},_gradualAllocator:function(e,t,s,r,a){var o,n,i=t.length;for(o=0;o<i;o++){if(!(r[n=t[a?o:i-o-1]]<e))return s[n]=e,0;s[n]=r[n],e-=s[n]}return e},_getOverflowDate:function(e,t,s){for(var r=e.length-1;r>=0;r--)if("fixed"!==t[e[r]]&&0!==s[e[r]])return e[r]},addAllocationTypes:function(e,t,s,r){for(var a=0;a<e.length;a++){var o=e[a];s[o]||(r[o]<t[o]?s[o]="overAllocation":t[o]<0&&(s[o]="negativeAllocation"))}return{
allocations:t,types:s}},allocationsToFixedResources:function(e){var t={},s=e.allocations,r=e.types;for(var a in r)if(r.hasOwnProperty(a)&&"fixed"===r[a]&&s[a]!==undefined){var o=s[a];t[a]={hours:o,custom:"fixed"}}return t},resourcesToAllocations:function(e){for(var t={},s={},r=e.getAssignee(),a=e.issue.getRestEstimated(),o=e.resources,n=Object.getOwnPropertyNames(o),i=0;i<n.length;i++){var l=n[i],u=o[l];t[l]=u.hours,a-=u.hours,u.custom?s[l]="fixed":r&&r.getMaxHours(l)<u.hours&&(s[l]="overAllocation")}if(a>0){var c=e.issue._end_date.format("YYYY-MM-DD");t[c]===undefined?t[c]=a:t[c]+=a,"fixed"===s[c]||r&&r.getMaxHours(l)<t[c]&&(s[c]="overAllocation")}return{allocations:t,types:s}},pseudoEvenHours:function(e,t){var s,r=[],a={},o=t.issue||e.issue,n=t.estimated||o.getRestEstimated(),i=t.start_date||o._start_date,l=t.end_date||o._end_date,u=t.assignee||e.getAssignee(o),c=t.maxHoursPerDay||u&&u.hours||8,y=e.resources||{};if(i.isValid()&&l.isValid()&&+l-i>=0){for(var d,g,h=moment(i);+h-l<=0;){var f=h.format("YYYY-MM-DD");r.push(f);var p=y[f];p!==undefined&&p.custom||((s=u.getMaxHours(f,h))>c&&(s=c),0!==s&&(a[s]?a[s]++:a[s]=1)),h.add(1,"days")}var _=Object.getOwnPropertyNames(a).map(parseFloat);if(0===_.length)return c;for(_.sort(),g=_.length-2;g>=0;g--)a[_[g]]+=a[_[g+1]];for(g=0;g<_.length;g++){if(0===(n-=(d=_[g])*a[d]))return d;if(n<0)break}return Math.min(d+n/a[d],c)}return c}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.resource=ysy.pro.resource||{},EasyGem.extend(ysy.pro.resource,{responsiveInput:function(e,t,s){var r=$("<input "+e+">");return r.blur(t),r.click(t),r.keypress(function(e){if(13==e.which)return t(e),!1}).mousedown(function(e){return e.stopPropagation(),!1}),r[0].oninput=function(){r.toggleClass("wrong",!s(r.val()))},r},allocationChange:function(e,t){e.stopPropagation(),ysy.log.debug("click on allocation","resource");var s,r,a=$(this),o=ysy.pro.resource,n=parseInt(a.closest(".gantt_task_line").attr("task_id")),i=gantt._pull[n];if(i&&i.widget&&i.widget.model){var l=i.widget.model,u=ysy.data.allocations.getByID(l.id);if(u){var c=a.closest(".gantt_bars_area").offset(),y=ysy.settings.zoom.zoom,d="day"===ysy.settings.zoom.zoom,g=gantt.date[y+"_start"](moment(gantt.dateFromPos2(e.pageX-c.left)));if(!d){var h=moment(g).add(1,y);if(i.end_date.isBefore(h)&&(h=moment(i.end_date)).add(1,"day"),g.isBefore(i.start_date)&&(g=moment(i.start_date)),h.isBefore(g))return}var f=d?24:h.diff(g,"hours"),p=g.format("YYYY-MM-DD"),_=ysy.data.assignees.getByID(l.assigned_to_id);_&&_.is_group&&(f=Infinity);for(var v=l.getRestEstimated(),m=u.resources,w=Object.getOwnPropertyNames(m),b=0;b<w.length;b++){var k=w[b];k!==p&&(m[k].custom&&(v-=m[k].hours))}f>v&&(f=v<0?0:v);var A=function(e){e.stopPropagation(),s.off(),gantt.refreshTask(n);var t=s.val();if(""===t)var a=!0;else if(t=Math.round(10*parseFloat(t))/10,isNaN(t)||t<0||t>f)return!1;if(!a&&d&&m[p]&&m[p].custom&&t+o.MARGIN>r&&t-o.MARGIN<r)return!1;var i={};for(var c in m)m.hasOwnProperty(c)&&(i[c]=m[c]);if(d)a?delete m[p]:m[p]={hours:t,custom:!0};else if(a)for(;g<h;)delete m[g.format("YYYY-MM-DD")],g.add(1,"day");else{var y=u.getAssignee(l),_=o.calculateAllocations({},{estimated:t,start_date:g,issue:l,end_date:h.subtract(1,"day"),assignee:y,allocator:"evenly"});if(null===_)return!1;var v=_.allocations;for(var w in v)v.hasOwnProperty(w)&&(m[w]={hours:v[w],custom:!0})}var b=ysy.history;return b.openBrack(),l.set({start_date:l._start_date,end_date:l._end_date}),b.add({resources:i,_changed:u._changed},u),u._changed=!0,u._fireChanges({_name:"Allocator"},"allocation set"),b.closeBrack(),!1};s=o.responsiveInput('class="gantt-rm-allocation-input" type="text"',A,function(e){if(""===e)return!0;var t=parseFloat(e);return!(isNaN(t)||t<0||t>f)});var D=gantt.posFromDate(g)-gantt.posFromDate(i.start_date);if(d)var x=gantt._tasks.col_width;else x=gantt.posFromDate(h)-gantt.posFromDate(g);return s.css({left:D-1+"px",width:Math.max(x,30)+"px"}),r=d?t[p]:o._simpleWeekSummer(t,g,h),s.val(o.roundTo1(r)),a.parent().append(s),s.focus(),!1}}},_simpleWeekSummer:function(e,t,s){t=moment(t);for(var r=0;t<s;){var a=e[t.format("YYYY-MM-DD")];a&&(r+=a),t.add(1,"day")}return r}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.resource=ysy.pro.resource||{},ysy.pro.resource.features=EasyGem.extend(ysy.pro.resource.features,{estimatedLeft:"estimated"}),ysy.pro.resource.estimated=EasyGem.extend(ysy.pro.resource.estimated,{patch:function(){var e=ysy.settings.resource,t=ysy.pro.resource;gantt.templates.leftside_text=function(s,r,a){if(!e.open)return null;var o=0,n=0;if("project"===a.type){var i=a.widget&&a.widget.model;if(i&&i.id===ysy.settings.projectID)for(var l=ysy.data.issues.getArray(),u=0;u<l.length;u++)o+=l[u].estimated_hours||0,n+=l[u].spent||0;else gantt.eachTask(function(e){o+=e.estimated,n+=e.spent},a.id)}else n=a.spent,o=a.estimated;return Mustache.render(ysy.view.templates.resourceLeftText,{estimated:t.roundTo1(o)||0,spent:t.roundTo1(n),withSpent:n>0,withEvents:"project"!==a.type})}},estimatedChange:function(e){e.stopPropagation();var t,s=$(e.target),r=s.closest(".gantt_task_line").attr("task_id"),a=gantt._pull[r];if(a&&a.widget&&a.widget.model){var o=a.widget.model,n=function(){e.stopPropagation(),t.off(),gantt.refreshTask(a.id);var s=parseFloat(t.val());if(isNaN(s)||s<0||s<o.spent)return!1;o.set({estimated_hours:s,start_date:o._start_date,end_date:o._end_date})},i=function(e){var t=parseFloat(e);return!(isNaN(t)||t<0||t<o.spent)};return(t=ysy.pro.resource.responsiveInput('class="gantt-rm-estimated-input" type="text" size="4"',n,i)).val(ysy.pro.resource.roundTo1(a.estimated)),s.empty().append(t),t.focus(),!1}}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.resource=ysy.pro.resource||{},ysy.pro.resource.events=ysy.pro.resource.events||{},EasyGem.extend(ysy.pro.resource.events,{$target:null,template:null,clickPack:null,lastPos:{x:0,y:0},lastOut:null,show:function(e,t,s,r){var a={days:t,resource_sum:s,working_hours:r};this.lastOut=a,this.$target=ysy.view.tooltip.show("gantt-event-tooltip",e,ysy.view.templates.assigneeTooltip,a)},updateTooltip:function(e,t){var s=this.lastOut;if(s){s.otherAllocations||(s.otherAllocations=[]),s.otherReservations||(s.otherReservations=[]);for(var r=s.otherAllocations.concat(e),a=s.otherReservations.concat(t),o=0,n=0,i=0;i<r.length;i++){const e=r[i];o+=+e.hours,e.name&&(e.subject=e.name),e.subject=e.project_name?`${e.project_name} / ${e.subject}`:`${e.subject}`}for(i=0;i<a.length;i++){const e=a[i];n+=e.hours,e.name=e.project_name?`${e.project_name} / ${e.name}`:`${e.name}`}$.extend(s,{sum:parseFloat(ysy.pro.resource.roundTo1(o+n)),allocationSum:parseFloat(ysy.pro.resource.roundTo1(o)),reservationSum:parseFloat(ysy.pro.resource.roundTo1(n)),otherAllocations:r,otherReservations:a}),this.$target=ysy.view.tooltip.show(null,null,null,s)}},onMouseDown:function(e){e.stopPropagation();var t=ysy.pro.resource.events;t.clickPack&&(t.clickPack.prevented=!0,t.clickPack=null),t.lastPos={x:e.clientX,y:e.clientY},t.fireThrough(e)},onClick:function(e,t){ysy.log.debug("onClick({left:"+e.pageX+",top:"+e.pageY+","+t.name+")","resource");var s=ysy.pro.resource.events,r=s.lastPos;if(Math.abs(e.clientX-r.x)>2)return;if(Math.abs(e.clientY-r.y)>2)return;var a,o=$(this).closest(".gantt_bars_area").offset(),n=ysy.settings.zoom.zoom,i=moment(gantt.dateFromPos2(e.pageX-o.left)).startOf("week"===n?"isoWeek":n),l=moment(i).add(1,n),u=s.eventWeekSummer(t,i,l),c=i.format("YYYY-MM-DD"),y=l.format("YYYY-MM-DD"),d=s.loadedAssignedAllocation(t.id,ysy.data.allocations,n,c,y),g=s.loadedAssignedAllocation(t.id,ysy.data.resourceReservations,n,c,y),h=d.length+g.length;const f=t.getMaxHoursInterval(c,null,n);if("day"===n?t.resources_sums[c]>0&&(a=!0):a=s.resourcesAnyInInterval(t.resources_sums,i,l),u||a||h){s.clickPack={events:u},a&&s.loadOtherAllocations(t,i,l,s.clickPack);var p=$(e.target).offset(),_={clientX:e.clientX,clientY:e.clientY,top:p.top+gantt.config.row_height};s.show(_,u,a,f),h&&s.updateTooltip(d,g)}else s.fireThrough(e)},fireThrough:function(e){this.$background||(this.$background=$("#gantt_cont").find(".gantt_task_bg"));var t=new MouseEvent(e.type,e);this.$background[0].dispatchEvent(t)},loadOtherAllocations:function(e,t,s,r){for(var a=[],o=ysy.data.issues.getArray(),n=0;n<o.length;n++)a.push(o[n].id);ysy.gateway.polymorficPostJSON(ysy.settings.paths.otherAllocations,{except_issue_ids:a,user_id:e.id,from:t.format("YYYY-MM-DD"),to:s.subtract(1,"day").format("YYYY-MM-DD")},function(e){var t=ysy.pro.resource.events;t._handleOtherAllocationsData.call(t,e,r)},function(){ysy.log.error("Error: Unable to load data")})},loadedAssignedAllocation:function(e,t,s,r,a){if(!t)return[];for(var o=[],n=t.getArray(),i=0;i<n.length;i++){var l=n[i],u=l;if(l.issue&&(u=l.issue),u.assigned_to_id===e)if("day"===s){if(l.allocPack.allocations[r]){var c=l.allocPack.allocations[r];c>0&&o.push({id:u.id,name:u.name,hours:parseFloat(ysy.pro.resource.roundTo1(c))})}}else{var y=0;for(var d in l.allocPack.allocations)d>=r&&d<a&&(y+=l.allocPack.allocations[d]);y>0&&o.push({id:u.id,name:u.name,hours:parseFloat(ysy.pro.resource.roundTo1(y))})}}return o},_handleOtherAllocationsData:function(e,t){if(!t.prevented){var s=e.easy_resources_allocations,r=e.easy_reservations_allocations;e&&s&&this.updateTooltip(s,r)}},constructEventData:function(e,t){for(var s=[],r=ysy.settings.labels.eventTypes,a=0;a<t.length;a++){var o=t[a],n={name:o.name,type:r[o.type]||r.genericEvent,hours:o.hours===undefined?undefined:ysy.pro.resource.roundTo1(o.hours),user:o.original_user_name};s.push(n)}return{date:e.format(gantt.config.date_format),events:s}},constructEventMergie:function(e){var t=ysy.settings.labels.eventTypes;$.extend(e,{date:e.from.format(gantt.config.date_format)+" - "+e.to.format(gantt.config.date_format),events:[{name:e.name,type:t[e.type]||t.genericEvent,hours:e.hours===undefined?undefined:ysy.pro.resource.roundTo1(e.hours),user:e.original_user_name}]})},eventWeekSummerSimple:function(e,t,s){if("day"===ysy.settings.zoom.zoom){var r=t.format("YYYY-MM-DD"),a=e.getEvents(r);return a?[this.constructEventData(t,a)]:null}for(var o=[],n=moment(t);n.isBefore(s);)r=n.format("YYYY-MM-DD"),(a=e.getEvents(r))&&o.push(this.constructEventData(n,a)),n.add(1,"day");return o},eventWeekSummer:function(e,t,s){if("day"===ysy.settings.zoom.zoom){var r=t.format("YYYY-MM-DD"),a=e.getEvents(r);return a?[this.constructEventData(t,a)]:null}for(var o=[],n=moment(t);n.isBefore(s);)r=n.format("YYYY-MM-DD"),(a=e.getEvents(r))&&o.push({date:moment(n),events:a}),n.add(1,"day");return 0===(o=this.mergeAndConstructEvents(o)).length?null:o},mergeAndConstructEvents:function(e){for(var t,s=[],r={},a=[],o=0;o<e.length;o++){var n=e[o];if(n.events){for(var i=[],l=0;l<n.events.length;l++){var u=n.events[l],c=u.name+"_"+u.type+"_"+u.hours;if(u.original_user_name&&(c+="_"+u.original_user_name),r[c]){var y=r[c];y.to=n.date,y.hours+=u.hours}else{var d=!1;if(t&&-1===t.diff(n.date,"days"))for(var g=0;g<a.length;g++){var h=a[g];c===h.name+"_"+h.type+"_"+h.hours&&(a.splice(g,1),g--,y={from:t,to:n.date,name:u.name,type:u.type,hours:u.hours+h.hours,user:u.original_user_name},r[c]=y,d=!0)}d?s.push(y):i.push(u)}}a&&a.length&&t&&s.push(this.constructEventData(t,a)),a=i,t=n.date}}for(var f in a&&a.length&&s.push(this.constructEventData(t,a)),r)r.hasOwnProperty(f)&&this.constructEventMergie(r[f]);return s},resourcesAnyInInterval:function(e,t,s){for(var r=moment(t);r.isBefore(s);){if(e[r.format("YYYY-MM-DD")])return!0;r.add(1,"day")}return!1}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.resource=ysy.pro.resource||{},ysy.pro.resource.features=EasyGem.extend(ysy.pro.resource.features,{withMilestones:"milestones"}),ysy.pro.resource.milestones=ysy.pro.resource.milestones||{},EasyGem.extend(ysy.pro.resource.milestones,{patch:function(){var e=ysy.pro.resource;ysy.settings.resource.buttons=ysy.settings.resource.buttons||{},ysy.settings.resource.buttons.withMilestones=JSON.parse(ysy.data.storage.getPersistentData("withMilestones")),ysy.pro.toolPanel.registerButton({id:"resource_with_milestones",bind:function(){this.model=ysy.settings.resource,this.buttons=this.model.buttons,this.buttons.withMilestones&&(ysy.settings.resource.setSilent("withMilestones",this.buttons.withMilestones),ysy.settings.resource._fireChanges(this,"button"))},func:function(){this.buttons.withMilestones=!this.buttons.withMilestones,ysy.proManager.closeAll(e),ysy.data.storage.savePersistentData("withMilestones",this.buttons.withMilestones),ysy.settings.resource.setSilent("withMilestones",this.buttons.withMilestones),ysy.settings.resource._fireChanges(this,"button")},isOn:function(){return this.buttons.withMilestones},isHidden:function(){return!this.model.open}})},milestone_renderer:function(e){if(e.widget){var t=e.widget.model,s=ysy.data.milestones.getByID(t.fixed_version_id);if(s){var r=this.posFromDate(moment(s.start_date).add(1,"day"))-this.posFromDate(e.start_date)-gantt._get_milestone_width()/2;return $(ysy.view.templates.milestoneBlocker.replace("{{milestoneName}}",s.name).replace("{{pos_x}}",r.toString()))[0]}}}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.resource=ysy.pro.resource||{},ysy.pro.resource.features=EasyGem.extend(ysy.pro.resource.features,{contextualMenu:"contextual"}),ysy.pro.resource.contextual={patch:function(){var e=ysy.pro.resource.contextual;$("#gantt_cont").on("contextmenu",".gantt-task-bar-line",function(t){var s=$(this).parent().attr("task_id"),r=gantt._pull[s];if(s){var a=r.widget.model;if(a)return e.show(a,r.type||"task"),t.preventDefault(),t.stopPropagation(),!1}}),this.$target=$("#ajax-modal")},show:function(e,t){if("project"!==t){var s=this.$target,r=e.getAllocationInstance(),a=!e.permissions.editable||!ysy.settings.enableAllocatorChange,o={disabled:a,name:e.name,isReservation:"reservation"===t};if("reservation"===t){var n={name:e.name,assigned_to_id:e.assigned_to_id,due_date:moment(e.end_date).format("YYYY-MM-DD"),estimated_hours:e.estimated_hours,start_date:moment(e.start_date).format("YYYY-MM-DD"),description:e.description,allocator:e.allocator,project_id:e.project_id};ysy.pro.resource.reservations.openModal(n,r,e)}else o["selected_"+r.allocator]="selected",s.html(Mustache.render(ysy.view.templates.resourceContextual,o)),showModal("ajax-modal",500),a||this.bindEvents(s,e,r)}},hide:function(){this.$target.dialog("close")},bindEvents:function(e,t,s){var r=ysy.pro.resource.contextual;e.find("#submit_allocator").click(function(){r.hide();var t=e.find("#select_allocator").val();""===t&&(t=null),s.set({allocator:t,_oldAllocator:s.allocator})}),e.find("#reset_allocator").click(function(){r.hide(),s.set({allocator:null,_oldAllocator:s.allocator})}),e.find("#delete_button").click(function(){r.hide(),t.remove()})}},window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.resource=ysy.pro.resource||{},ysy.pro.resource.features=EasyGem.extend(ysy.pro.resource.features,{reallocateButton:"reallocate"}),ysy.pro.resource.reallocate=ysy.pro.resource.reallocate||{},EasyGem.extend(ysy.pro.resource.reallocate,{patch:function(){ysy.pro.toolPanel.registerButton({id:"rm_reallocate",_name:"ReallocateButton",bind:function(){this.model=ysy.settings.resource},func:function(){var e=ysy.data.issues.getArray();ysy.history.openBrack();for(var t=0;t<e.length;t++)e[t].getAllocationInstance().recalculate(!0);ysy.history.closeBrack()},isHidden:function(){return!this.model.open}})}}),ysy.pro.resource.reservations=ysy.pro.resource.reservations||{},ysy.pro.resource.features.reservations="reservations",EasyGem.extend(ysy.pro.resource.reservations,{patch:function(){ysy.settings.resource.buttons=ysy.settings.resource.buttons||{};const e=ysy.settings.resource.buttons;if(e.onlyTask=JSON.parse(ysy.data.storage.getPersistentData("onlyTask")),e.onlyReservation=JSON.parse(ysy.data.storage.getPersistentData("onlyReservation")),e.newReservation=JSON.parse(ysy.data.storage.getPersistentData("newReservation")),ysy.settings.reservationEnabled){ysy.pro.toolPanel.registerButton({id:"resource_reservations",bind:function(){this.model=ysy.settings.resource,this.buttons=this.model.buttons,this.buttons.onlyTask||(this.buttons.newReservation=!0,ysy.settings.resource.setSilent("reservations",!this.model.reservations),t.toggle(),ysy.settings.resource._fireChanges(this,"button")),ysy.settings.resource_on||(this.buttons.newReservation=!1,t.toggle())},func:function(){this.buttons.newReservation=!this.model.reservations,ysy.proManager.closeAll(s),ysy.settings.resource.setSilent("reservations",!this.model.reservations),ysy.data.storage.savePersistentData("newReservation",this.buttons.newReservation),t.toggle(),this.buttons.onlyTask=!this.model.reservations,ysy.data.storage.savePersistentData("onlyTask",this.buttons.onlyTask),ysy.pro.resource.reservations.updateRegistration(this.buttons.onlyTask),this.buttons.onlyTask?(this.model.hasOwnProperty("hidePlanned")&&(this.buttons.hidePlanned=!1,ysy.data.storage.savePersistentData("hidePlanned",this.buttons.hidePlanned)),this.buttons.onlyReservation=!1,ysy.data.storage.savePersistentData("onlyReservation",this.buttons.onlyReservation),ysy.pro.resource.reservations.loadReservationSums("onlyTask")):this.buttons.onlyReservation||(ysy.pro.resource.reservations.loadReservationSums("allData"),ysy.data.resourceReservations.array.length||ysy.pro.resource.loader.load()),ysy.settings.resource._fireChanges(this,"button")},isOn:function(){return this.model.reservations},isHidden:function(){return!this.model.open}}),ysy.pro.toolPanel.registerButton({id:"hide_tasks",_name:"HideTasks",bind:function(){this.model=ysy.settings.resource,this.buttons=this.model.buttons,this.buttons.onlyTask||(this.buttons.onlyTask=!1,ysy.settings.resource.setSilent("onlyTask",!this.buttons.onlyReservation),this.model._fireChanges(this,"click"))},func:function(){this.buttons.onlyReservation=!this.buttons.onlyReservation,ysy.pro.resource.reservations.updateRegistration(this.buttons.onlyReservation),ysy.data.storage.savePersistentData("onlyReservation",this.buttons.onlyReservation),this.buttons.onlyReservation?(this.model.hasOwnProperty("hidePlanned")&&(this.buttons.hidePlanned=!1,ysy.data.storage.savePersistentData("hidePlanned",this.buttons.hidePlanned)),this.buttons.onlyTask=!1,this.buttons.newReservation=!0,ysy.settings.resource.setSilent("reservations",!0),ysy.data.storage.savePersistentData("onlyTask",this.buttons.onlyTask),ysy.pro.resource.reservations.loadReservationSums("onlyReservation"),ysy.data.storage.savePersistentData("newReservation",this.buttons.newReservation),t.toggle()):this.buttons.onlyTask||(ysy.pro.resource.reservations.loadReservationSums("allData"),ysy.data.issues.array.length||ysy.gateway.loadGanttdata($.proxy(ysy.data.loader._handleMainGantt,ysy.data.loader),function(){ysy.log.error("Error: Unable to load data")})),this.model._fireChanges(this,"click")},isOn:function(){return!this.buttons.onlyReservation},isHidden:function(){return!this.model.open}});var t=this,s=ysy.pro.resource;ysy.data.resourceReservations=(new ysy.data.Array).init({_name:"ResourceReservationArray"}),ysy.proManager.register("extendGanttTask",this.extendGanttTask),EasyGem.extend(gantt.config,{controls_reservation:{show_progress:!1,resize:!0},allowedParent_reservation:["assignee"]}),ysy.proManager.register("RmLegendOut",function(e){e.backColors||(e.backColors=[]),e.backColors.push({label:ysy.settings.labels.eventTypes.reservation,colorName:"reservation"})}),ysy.data.Reservation=function(){ysy.data.Data.call(this)},ysy.main.extender(ysy.data.Data,ysy.data.Reservation,{_name:"Reservation",isReservation:!0,ganttType:"reservation",allocator:"evenly",estimated_hours:0,permissions:{editable:!0},allocPack:null,_postInit:function(){this.start_date=moment(this.start_date),this.end_date=moment(this.due_date),this.end_date._isEndDate=!0,delete this.due_date,this.resources&&this.resources.length?this.allocPack=this.allocPackFromResources(this.resources):this.allocPack=ysy.pro.resource.calculateAllocations(this,{issue:this}),delete this.resources,this.register(function(){this.allocPack=ysy.pro.resource.calculateAllocations(this,{issue:this})},this)},getID:function(){return"rr"+this.id},getParent:function(){var e=this.assigned_to_id||"unassigned";if(ysy.settings.global&&ysy.settings.resource.buttons.withProjects){var t=this.project_id+"a"+e;if(ysy.data.resourceProjects.getByID(t))return"p"+t}return!!ysy.data.assignees.getByID(e)&&"a"+e},getAllocator:function(){var e=ysy.data.projects.getByID(this.project_id);return e&&e.allocator?e.allocator:ysy.settings.defaultAllocator||"from_end"},pushFollowers:function(){},isOpened:function(){return!0},getRestEstimated:function(){return this.estimated_hours},getAssignee:function(){return ysy.data.assignees.getByID(this.assigned_to_id)},getProblems:function(){return!1},getAllocations:function(){return this.allocPack},getAllocationInstance:function(){return this},allocPackFromResources:function(e){for(var t={},s=0;s<e.length;s++){var r=e[s];t[r.date]=r.hours}return{allocations:t,types:{}}}}),this.apiPatch(),gantt.templates.grid_bullet_reservation=function(){return"<div class='gantt_tree_icon'><div class='gantt_drag_handle gantt_subtask_arrow'></div></div>"},this.oldCountSubAllocations=ysy.pro.resource.countSubAllocations,ysy.pro.resource.countSubAllocations=this.countSubAllocations}},toggle:function(){ysy.settings.resource.reservations&&ysy.settings.resource.buttons.newReservation?(ysy.proManager.register("onDragStart",this.onDragStart),ysy.proManager.register("onDragMove",this.onDragMove),ysy.proManager.register("onDragEnd",this.onDragEnd)):(ysy.proManager.unregister("onDragStart",this.onDragStart),ysy.proManager.unregister("onDragMove",this.onDragMove),ysy.proManager.unregister("onDragEnd",this.onDragEnd))},extendGanttTask:function(e,t){e.isReservation&&(t.end_date=moment(e.end_date),t.end_date._isEndDate=!0,t.estimated=e.estimated_hours)},getRows:function(){return ysy.data.resourceReservations.getArray()},onDragStart:function(e,t){return e.addReservation=ysy.settings.resource.reservations,!!e.addReservation&&(e.startDate=gantt.dateFromPos(t.getRelativePos().x),e.lastScroll=gantt.getCachedScroll(),!0)},onDragMove:function(e,t){return!!e.addReservation&&(e.endDate=gantt.dateFromPos(t.getRelativePos().x),e.line=ysy.pro.addTask.modifyIssueMarker(t.config.marker,{start_date:moment(e.startDate),end_date:moment(e.endDate),type:"reservation"},t.config.offset,e.lastScroll),!0)},onDragEnd:function(e,t){if(!e.addReservation)return!1;if(t.config.started){ysy.log.debug("start: "+e.startDate.toString()+" end: "+e.endDate.toString(),"taskModal");var s={start_date:moment(e.startDate),end_date:moment(e.endDate)};ysy.pro.addTask.roundDates(s,"milestone"!==e.addType),e.addType="reservation";var r=ysy.pro.addTask.getParentByLine(e.line,e.addType);if(!r)return null;const t=/[a](\d+)/gm,i=/[p](\d+)/gm,l=r.id;matchAssignee=t.exec(l),matchProject=i.exec(l);var a=matchAssignee?matchAssignee[1]:r.real_id;if(ysy.settings.project)var o=ysy.settings.project.id;else o=matchProject?matchProject[1]:"";var n={start_date:s.start_date.format("YYYY-MM-DD"),due_date:s.end_date.format("YYYY-MM-DD"),assigned_to_id:a,project_id:o,estimated_hours:5};if(ysy.log.debug("line="+e.line,"taskModal"),a.includes("unassigned"))return void showFlashMessage("warning",ysy.settings.labels.warnings.reservation_for_unassignee);ysy.pro.resource.reservations.openModal(n)}return!0},openModal:function(e,t,s){var r=this,a=ysy.main.getModal("form-modal","90%"),o={reservation:e};ysy.settings.project&&(o.fixed_project=!0),t&&(o.show_delete=!0),$.ajax(`${window.urlPrefix}/easy_gantt_reservations/new`,{data:o}).done(function(e){a.html(e),showModal("form-modal"),a.find("form").on("submit",function(){window.fillFormTextAreaFromCKEditor&&window.fillFormTextAreaFromCKEditor("easy_gantt_reservation_description");var e=$(this).serializeArray(),o=ysy.main.formToJson(e).easy_gantt_reservation||{};const n=[];return Object.keys(gantt._pull).forEach(e=>{e.startsWith(`p${o.project_id}`)&&n.push(e)}),n.length||!o.project_id||ysy.settings.project?t?r.updateReservation(o,t,s):r.createReservation(e):$.ajax(`${window.urlPrefix}/easy_gantt_reservations/unpersisted_reservation_info.json`,{data:{reservation:o}}).done(function(a){const{project:n}=a.easy_reservation_data,i=+o.assigned_to_id;ysy.pro.resource.loader._loadRMProjects([n],i),t?r.updateReservation(o,t,s):r.createReservation(e)}),a.dialog("close"),!1}),r.$target=a,r.assignee=ysy.data.assignees.getByID(parseInt(a.find("#easy_gantt_reservation_assigned_to_id").val())),delete r.defaultEstimater,delete r.startDate,delete r.dueDate,delete r.maxAllocation,r.percentConvert("estimated_hours",r),a.find("#easy_gantt_reservation_start_date").on("change",function(){r.percentConvert("start_date",r)}),a.find("#easy_gantt_reservation_due_date").on("change",function(){r.percentConvert("due_date",r)}),a.find("#easy_gantt_reservation_estimated_hours").on("keyup change",function(){r.percentConvert("estimated_hours",r)}),a.find("#easy_gantt_reservation_estimated_percent").on("keyup change",function(){r.percentConvert("estimated_percent",r)}),a.find(".reservation_close").on("click",function(){a.dialog("close")}),a.find(".reservation_delete").on("click",function(){a.dialog("close"),s.remove()})})},percentConvert:function(e,t){const s=t.$target.find("#easy_gantt_reservation_start_date").val(),r=t.$target.find("#easy_gantt_reservation_due_date").val();let a=!1;if(t.startDate&&"start_date"!==e&&t.startDate===s||(t.startDate=s,a=!0),t.dueDate&&"due_date"!==e&&t.dueDate===r||(t.dueDate=r,a=!0),a||!t.maxAllocation){var o=moment(t.startDate);t.maxAllocation=0;let e=moment(t.dueDate);for(;!o.isAfter(e);){const e=o.format("YYYY-MM-DD"),s=t.assignee.getMaxHours(e,o);t.maxAllocation+=s,o.add(1,"days")}t.$target.find("#easy_gantt_reservation_max_allocation").text(t.maxAllocation)}"estimated_hours"===e?t.changeByTime(t):"estimated_percent"===e?t.changeByPercent(t):"estimated_hours"===t.defaultEstimater?t.changeByTime(t):t.changeByPercent(t)},changeByTime:function(e){let t=parseInt(e.$target.find("#easy_gantt_reservation_estimated_hours").val());e.defaultEstimater="estimated_hours",isNaN(t)&&(t=0);let s=t/(e.maxAllocation/100);s=s.toFixed(0),e.$target.find("#easy_gantt_reservation_estimated_percent").val(s)},changeByPercent:function(e){let t=parseInt(e.$target.find("#easy_gantt_reservation_estimated_percent").val());e.defaultEstimater="estimated_percent",isNaN(t)&&(t=0);let s=e.maxAllocation*(t/100);s=s.toFixed(0),e.$target.find("#easy_gantt_reservation_estimated_hours").val(s)},createReservation:function(e){var t=ysy.main.formToJson(e).easy_gantt_reservation||{};t.id=(new Date).valueOf().toString(),t.estimated_hours=parseFloat(t.estimated_hours),t.assigned_to_id=parseInt(t.assigned_to_id),e.forEach(e=>{if(e.name.includes("description"))return t.description=e.value});var s=new ysy.data.Reservation;s.init(t),ysy.data.resourceReservations.push(s);var r=gantt._pull["a"+(t.assigned_to_id||"unassigned")];r&&gantt.open(r.id)},updateReservation:function(e,t,s){e&&(ysy.history.openBrack(),t.set({allocator:e.allocator,_oldAllocator:t.allocator}),s.set({estimated_hours:Number(e.estimated_hours),description:e.description,name:e.name,start_date:moment(e.start_date),end_date:moment(e.due_date),project_id:e.project_id}),ysy.history.closeBrack())},countSubAllocations:function(e,t){var s={};const r=/[a](\d+)/gm,a=t.realProject;if(s.allocations={},s.types={},ysy.settings.resource.buttons.onlyReservation||(s=ysy.pro.resource.reservations.oldCountSubAllocations.call(ysy.pro.resource,e,t)),ysy.settings.resource.buttons.onlyTask)return s;var o=s.allocations,n=ysy.data.resourceReservations.getArray(),i=r.exec(t.id);i=i?+i[1]:t.id;for(var l=0;l<n.length;l++){var u=n[l];if((!a||u.project_id&&u.project_id===a.id)&&u.assigned_to_id===i){var c=u.allocPack.allocations;for(var y in c)c.hasOwnProperty(y)&&c[y]&&(o[y]?o[y]+=c[y]:o[y]=c[y])}}return s},updateRegistration:function(e){e?ysy.proManager.register("filterTask",this.filterTask):ysy.proManager.unregister("filterTask",this.filterTask)},filterTask:function(e,t){return("task"!==t.type||!ysy.settings.resource.buttons.onlyReservation)&&("reservation"!==t.type||!ysy.settings.resource.buttons.onlyTask)}}),ysy.pro.resource.reservations=ysy.pro.resource.reservations||{},EasyGem.extend(ysy.pro.resource.reservations,{apiPatch:function(){ysy.pro.resource.loader._loadReservations=this.load},load:function(e){if(e){for(var t=ysy.data.resourceReservations,s=[],r=0;r<e.length;r++){ysy.main._resourcesObjectToFloat(e[r].resources);var a=new ysy.data.Reservation;a.init(e[r]),t.pushSilent(a),s.push(a)}this._removeAllocationsFromSums(s),t._fireChanges(this,"load")}},save:function(){for(var e=ysy.data.resourceReservations.array,t=ysy.pro.resource.saver,s=[],r=[],a=0;a<e.length;a++){var o=e[a];if(o._changed)if(o._deleted)o._created||s.push(o.id);else{var n=this.preparePack(o);n&&r.push(n)}}s.length>0&&(t.startRequest(),$.ajax({url:ysy.settings.paths.reservationBulkDestroyUrl,method:"DELETE",contentType:"application/json",dataType:"text",data:JSON.stringify({reservation_ids:s})}).done(t.onSuccess).fail(function(e){t.onFail(["Destroy reservations with ids "+s+" failed:"+e.status+" "+e.statusText])})),r.length>0&&(t.startRequest(),$.ajax({url:ysy.settings.paths.reservationUpdateOrCreateUrl,method:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({reservations:r})}).done(function(e){if(e.unsaved&&e.unsaved.length){var s=[];e.unsaved.forEach(function(e){var t="Update reservation "+((o=ysy.data.resourceReservations.getByID(e.id))?o.name+" ":"")+"failed";if(e.errors)for(var r in t+=": ",e.errors)e.errors.hasOwnProperty(r)&&(t+=r+" "+e.errors[r]);s.push(t)}),t.onFail(s)}else t.onSuccess()}).fail(function(e){var s=r.map(function(e){return e.name});t.onFail(["Update reservations "+s+" failed: "+e.status+" "+e.statusText])}))},allowedAttributes:["allocator","assigned_to_id","end_date","estimated_hours","name","start_date","project_id","description"],preparePack:function(e){for(var t={},s=Object.keys(e),r=0;r<s.length;r++){var a=s[r];-1!==this.allowedAttributes.indexOf(a)&&(t[a]=e[a])}if(t.start_date&&(t.start_date=t.start_date.format("YYYY-MM-DD")),t.end_date&&(t.due_date=t.end_date.format("YYYY-MM-DD"),delete t.end_date),!e._created){if(!(t=e.getDiff(t)))return t;t.id=e.id}return t.resources=this.prepareResources(e.allocPack),t},prepareResources:function(e){for(var t=[],s=e.allocations,r=Object.keys(s),a=0;a<r.length;a++){var o=r[a];t.push({date:o,hours:s[o]})}return t},loadReservationSums:function(e,t){var s=[];this.type=e;var r="onlyReservation"===e?"reservationSums":"taskSums";if(t===undefined)for(var a=ysy.data.assignees.getArray(),o=0;o<a.length;o++)s.push(a[o].id),delete a[o][r];else{s.push(t);var n=ysy.data.assignees.getByID(t);n&&delete n[r]}var i=[],l=[],u=ysy.data.issues.getArray(),c=ysy.data.resourceReservations.getArray();for(o=0;o<u.length;o++)t&&t!==u[o].assigned_to_id||u[o].id>1e12||i.push(u[o].id);for(o=0;o<c.length;o++)t&&t!==c[o].assigned_to_id||c[o].id>1e12||l.push(c[o].id);var y=ysy.data.limits.start_date,d=ysy.data.limits.end_date;ysy.gateway.polymorficPostJSON(ysy.settings.paths.usersSumsUrl.replace(":projectID",ysy.settings.projectID).replace(":variant",this.type).replace(":start",y.format("YYYY-MM-DD")).replace(":end",d.format("YYYY-MM-DD")),{user_ids:s,except_issue_ids:i,except_reservation_ids:l},$.proxy(this._handleReservationSumsData,this),function(){ysy.log.error("Error: Unable to load data")})},_handleReservationSumsData:function(e){var t=e.easy_resource_data;this._loadReservationSums(t.users),ysy.settings.resource._fireChanges(this,"reservation loaded")},_loadReservationSums:function(e){if(e){this.type;for(var t=ysy.data.assignees,s=0;s<e.length;s++){var r=e[s];ysy.main._resourcesStringToFloat(r.resources_sums);var a=t.getByID(r.id);a&&(a.resources_sums=r.resources_sums)}}}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.resource=ysy.pro.resource||{},ysy.pro.resource.features=EasyGem.extend(ysy.pro.resource.features,{allocationSumRow:"sumRow"}),ysy.pro.resource.sumRow=EasyGem.extend(ysy.pro.resource.sumRow,{opened:!1,patch:function(){!ysy.settings.showTotalProjectAllocations||ysy.settings.isResourceManagement&&ysy.settings.global||(ysy.pro.sumRow.summers.allocations={day:function(e,t){if(t._start_date.isAfter(e))return 0;if(t._end_date.isBefore(e))return 0;var s=t.getAllocations();if(!s||!s.allocations)return 0;var r=s.allocations[e.format("YYYY-MM-DD")];return r>0?parseFloat(r.toFixed(0)):0},week:function(e,t,s){if(s._start_date.isAfter(t))return 0;if(s._end_date.isBefore(e))return 0;var r=s.getAllocations();if(!r||!r.allocations)return 0;for(var a=0,o=moment(e);o.isBefore(t);){var n=r.allocations[o.format("YYYY-MM-DD")];n>0&&(a+=n),
o.add(1,"day")}return parseFloat(a.toFixed(0))},unit:"h",title:"Allocations"},ysy.settings.resource.register(function(){this.opened!==ysy.settings.resource.open&&(this.opened=ysy.settings.resource.open,this.opened?ysy.settings.sumRow.setSummer("allocations"):ysy.settings.sumRow.removeSummer("allocations"))},this))}}),ysy.pro.resource.balance=ysy.pro.resource.balance||{},ysy.pro.resource.features.balance="balance",EasyGem.extend(ysy.pro.resource.balance,{patch:function(){const e=this;ysy.settings.resource.buttons=ysy.settings.resource.buttons||{},ysy.settings.priorities=ysy.settings.priorities||[],ysy.pro.toolPanel.registerButton({id:"rm_balance",bind:function(){this.model=ysy.settings.resource,this.buttons=this.model.buttons},func:function(){this.buttons.balance=!this.model.balance,ysy.settings.resource._fireChanges(this,"button"),e.balanceTasks()},isOn:function(){return this.model.balance},isHidden:function(){return!this.model.open}})},balanceTasks:async function(){const e=ysy.data.allocations.array,t=this;if(!e)return;let s,r=0;await this.getPriorities(),ysy.data.assignees.array.filter(e=>{const t=gantt._pull[`a${e.id}`];if(t)return t.$open}).forEach(a=>{const o=a.week_hours,n=a.events;let i=[];const l=ysy.settings.priorities;let u={};const c=e;let y=[],d={};(i=t.allocationSort(c,y,l,a))&&i.length&&i.forEach(e=>{t.setAllocatorToFutureEvenly(e),ysy.history.clear(),t.addToHistory(e.issue),r=0;let i,l=e.allocPack.allocations;if(!Object.keys(l).length)return;const c={localAllocations:l,dayWorkHours:u,weekWorkingHours:o,allocSum:d,overage:s,allocationStash:r,lastDay:i,events:n};if(t.countAllocationsHours(c),r=c.allocationStash,i=c.lastDay,r){const e={localAllocations:l,dayWorkHours:u,weekWorkingHours:o,allocSum:d,allocationStash:r,lastDay:i};t.spreadTheStashedHours(e),l=e.localAllocations,d=e.allocSum,r=e.allocationStash}const g={localAllocations:l,current:e,sortedAllocations:y,lastDay:i,assignee:a};t.saveIssueChanges(g),e=g.current,y=g.sortedAllocations,ysy.history.openBrack(),e._changed=!0,e.balanced=!0,ysy.history.closeBrack(),gantt.refreshTask(e.id)})})},addToHistory:function(e){let t={balanced:e.balanced,_changed:e._changed};ysy.history.add(t,e)},setAllocatorToFutureEvenly:function(e){"future_evenly"!==e.allocator&&(e.resources&&Object.keys(e.resources).length&&Object.keys(e.resources).forEach(t=>{e.resources[t].custom=!1}),e.set({allocator:"future_evenly",_oldAllocator:e.allocator}),ysy.settings.resource._fireChanges(e,"set"))},getPriorities:async function(){if(ysy.settings.priorities.length>0)return;let e=[];const t=new Request(`${window.urlPrefix}/easy_autocompletes/issue_priorities`),s=await fetch(t);let r=await s.json();await r.forEach(t=>{e.push(t.text)}),ysy.settings.priorities=e.reverse()},assigneeFilter:function(e){const t=gantt._pull[`a${this.id}`],s=gantt._pull[`p${this.id}`];return!(t&&!t.$open||s&&s.$open)&&(!(!e.issue||e.issue.assigned_to_id!==this.id)||void 0)},allocationSort:function(e,t,s,r){let a=[];if(e.filter(this.assigneeFilter,r).forEach(e=>{t.push(e)}),ysy.settings.resource.buttons.hidePlanned&&(t=t.filter(e=>!e.issue.is_planned)),t.length>0&&s.length>0)return t[0].issue.columns.priority?this.prioritySort(t,s,a):a=t,a=a.filter(e=>e.issue.end_date>=(new Date).setHours(0,0,0,0))},countAllocationsHours:function(e){Object.keys(e.localAllocations).sort().forEach(t=>{this.countWorkingHours(e,t),!e.allocSum[t]&&e.localAllocations[t]<=e.dayWorkHours[t]?e.allocSum[t]=e.localAllocations[t]:(e.allocSum[t]=e.allocSum[t]?e.allocSum[t]:0,e.overage=e.allocSum[t]+e.localAllocations[t]-e.dayWorkHours[t],e.overage=e.overage>e.localAllocations[t]?e.localAllocations[t]:e.overage,e.allocSum[t]+=e.localAllocations[t],e.allocSum[t]>=e.dayWorkHours[t]&&(e.allocationStash+=e.overage,e.localAllocations[t]=e.dayWorkHours[t]-(e.allocSum[t]-e.localAllocations[t]),e.localAllocations[t]=e.localAllocations[t]<0?0:e.localAllocations[t])),0!==e.dayWorkHours[t]&&(e.lastDay=t)})},spreadTheStashedHours:function(e){let t={};Object.keys(e.allocSum).sort().forEach(s=>{if(e.allocSum[s]<e.dayWorkHours[s]&&e.localAllocations[s]!=undefined)t[s]=e.allocSum[s];else{if(e.allocSum[s]&&e.allocSum[s]>=e.dayWorkHours[s]&&s!==e.lastDay)return;if(s===e.lastDay&&!Object.keys(t).length)return e.localAllocations[e.lastDay]+=e.allocationStash,void(e.allocationStash=0)}}),Object.keys(t).forEach(t=>{if(e.localAllocations[t]<e.dayWorkHours[t]){let s=e.dayWorkHours[t]-e.allocSum[t];e.allocationStash>=s&&(e.allocationStash-=s,e.localAllocations[t]+=s,e.allocSum[t]+=s)}}),e.allocationStash&&e.allocationStash>0&&(e.localAllocations[e.lastDay]+=e.allocationStash)},prioritySort:function(e,t,s){const r=e.filter(e=>e.issue);t.forEach(e=>{r.forEach(t=>{t.issue.columns.priority&&t.issue.columns.priority===e&&s.push(t)})})},saveIssueChanges:function(e){e.sortedAllocations.filter(t=>t.issue&&t.issue.assigned_to_id===e.assignee.id).sort((e,t)=>e.issue.name>t.issue.name).forEach(t=>{t.issue.name===e.current.issue.name&&(Object.keys(e.localAllocations).forEach(s=>{t.issue.resources||(t.issue.resources=JSON.parse(JSON.stringify(t.resources))),t.resources[s]||(t.resources[s]={},t.issue.resources[s]={}),t.allocPack.types||(t.allocPack.types={}),t.allocPack.types[s]="fixed",t.issue.resources[s].hours=e.localAllocations[s],t.issue.resources[s].custom=!0,t.resources[e.lastDay]===t.issue.resources[s]&&(t.resources[e.lastDay].custom=!1,t.issue.resources[s].custom=!1,delete t.allocPack.types[e.lastDay])}),e.current.issue.balanced=!0,e.current.issue._changed=!0)})},countWorkingHours:function(e,t){const s=new Date(t),{events:r,weekWorkingHours:a,dayWorkHours:o}=e,n=r&&r[t]?r[t]:[{hours:0}];const i=a[0===s.getDay()?6:s.getDay()-1];let l=0;r&&n&&n.forEach(e=>{l+=e.hours});const u=i-l;o[t]=u<0?0:u}});