window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.resource=ysy.pro.resource||{},ysy.pro.resource.features=EasyGem.extend(ysy.pro.resource.features,{hidePlanned:"planned"}),ysy.pro.resource.planned=ysy.pro.resource.planned||{},EasyGem.extend(ysy.pro.resource.planned,{loaded:!1,patch:function(){ysy.settings.resource.buttons=ysy.settings.resource.buttons||{},ysy.settings.resource.buttons.hidePlanned=JSON.parse(ysy.data.storage.getPersistentData("hidePlanned")),ysy.proManager.register("extendGanttTask",this.extendGanttTask),ysy.pro.toolPanel.registerButton({id:"hide_planned_tasks",_name:"HidePlannedButton",bind:function(){this.model=ysy.settings.resource,this.buttons=this.model.buttons,this.model.setSilent("hidePlanned",this.buttons.hidePlanned),ysy.pro.resource.loader.register(function(){this.loaded=!1,this.buttons.hidePlanned&&ysy.pro.resource.planned.loadPlannedSums()},this)},func:function(){this.buttons.hidePlanned=!this.buttons.hidePlanned,this.model.setSilent("hidePlanned",this.buttons.hidePlanned),ysy.data.storage.savePersistentData("hidePlanned",this.buttons.hidePlanned),this.buttons.hidePlanned&&(ysy.settings.reservationEnabled&&(this.buttons.onlyReservation=!1,this.buttons.newReservation=!0,this.buttons.onlyTask=!1,ysy.settings.resource.setSilent("reservations",this.buttons.newReservation),ysy.data.storage.savePersistentData("newReservation",this.buttons.newReservation),ysy.data.storage.savePersistentData("onlyTask",this.buttons.onlyTask),ysy.pro.resource.reservations.loadReservationSums("allData")),ysy.pro.resource.planned.countPresentPlannedSums(),ysy.pro.resource.planned.loadIfNotLoaded()),this.model._fireChanges(this,"click")},isOn:function(){return!this.buttons.hidePlanned},isHidden:function(){return!this.model.open}})},extendGanttTask:function(e,s){ysy.settings.resource.buttons.hidePlanned&&e.is_planned&&(s.$ignore=!0)},loadPlannedSums:function(e){var s=[];if(e===undefined)for(var n=ysy.data.assignees.getArray(),t=0;t<n.length;t++)s.push(n[t].id),delete n[t].plannedSums;else{s.push(e);var a=ysy.data.assignees.getByID(e);a&&delete a.plannedSums}var r=[],o=ysy.data.issues.getArray();for(t=0;t<o.length;t++){o[t].is_planned&&(e&&e!==o[t].assigned_to_id||r.push(o[t].id))}var d=ysy.data.limits.start_date,i=ysy.data.limits.end_date;ysy.gateway.polymorficPostJSON(ysy.settings.paths.usersSumsUrl.replace(":projectID",ysy.settings.projectID).replace(":variant","planned").replace(":start",d.format("YYYY-MM-DD")).replace(":end",i.format("YYYY-MM-DD")),{user_ids:s,except_issue_ids:r},$.proxy(this._handlePlannedSumsData,this),function(){ysy.log.error("Error: Unable to load data")})},_handlePlannedSumsData:function(e){this.loaded=!0;var s=e.easy_resource_data;this._loadPlannedSums(s.users),this.countPresentPlannedSums(),ysy.settings.resource._fireChanges(this,"plannedSums loaded")},_loadPlannedSums:function(e){if(e)for(var s=ysy.data.assignees,n=0;n<e.length;n++){var t=e[n],a=s.getByID(t.id);a&&(a.plannedSums=t.resources_sums)}},loadIfNotLoaded:function(){this.loaded||this.loadPlannedSums()},subtractPlanned:function(e,s){var n=s.plannedSums,t=s.presentPlannedSums;if(n)for(var a in n)n.hasOwnProperty(a)&&(e[a]===undefined&&(e[a]=0),e[a]-=n[a]);if(t)for(a in t)t.hasOwnProperty(a)&&(e[a]===undefined&&(e[a]=0),e[a]-=t[a])},assigneeAfterLoad:function(e){this.loaded=!1,ysy.settings.resource.buttons.hidePlanned&&this.loadPlannedSums(e)},countPresentPlannedSums:function(){for(var e=ysy.data.assignees,s=ysy.data.assignees.getArray(),n=ysy.data.issues.getArray(),t=0;t<s.length;t++)s[t].presentPlannedSums={};for(t=0;t<n.length;t++){var a=n[t];if(a.is_planned){var r=e.getByID(a.assigned_to_id||"unassigned"),o=a.getAllocations();if(o)for(var d=Object.getOwnPropertyNames(o.allocations),i=0;i<d.length;i++){var l=d[i];r.presentPlannedSums[l]===undefined&&(r.presentPlannedSums[l]=0),r.presentPlannedSums[l]+=o.allocations[l]}}}}});