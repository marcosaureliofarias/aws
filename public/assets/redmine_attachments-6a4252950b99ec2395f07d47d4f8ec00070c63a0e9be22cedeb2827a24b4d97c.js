function addFile(e,a,t){var n,i=$(e);n="multiple"===i.attr("multiple")?"undefined"==typeof window.ATTACHMENT_LIMIT?10:window.ATTACHMENT_LIMIT:1;var o=i.closest(".attachments-container"),r=o.find("#attachments_fields"),l=o.find(".add_attachment"),d=o.attr("data-tag-name");if(r.children(".attachment").length<n){var s=addFile.nextAttachmentId++,p=$("<span>",{id:"attachments_"+s});p.append($("<input>",{type:"text","class":"filename readonly "+(i.data("description-is")?"half":"full"),name:d+"["+s+"][filename]",readonly:"readonly"}).val(a.name)),i.data("description-is")&&p.append($("<input>",{type:"text","class":"description",name:d+"["+s+"][description]",maxlength:255,placeholder:i.data("description-placeholder"),required:i.data("description-is-required")}).toggle(!t)),p.append($("<a>&nbsp</a>").attr({href:"#","class":"remove-upload icon icon-delete"}).click(removeFile).toggle(!t));var c=$(e).data("custom-version-for-attachment-id");return c&&p.append($("<input>",{type:"hidden",value:c,name:d+"["+s+"][custom_version_for_attachment_id]"})),p.appendTo(r),t&&ajaxUpload(a,s,p,e),l.toggle(r.children(".attachment").length<n),s}return null}function ajaxUpload(e,a,t,n){function i(){t.removeClass("ajax-waiting"),t.addClass("ajax-loading"),$("input:submit",$(this).parents("form")).attr("disabled","disabled")}function o(e){e.lengthComputable&&this.progressbar("value",100*e.loaded/e.total)}function r(e,a,t,n){ajaxUpload.uploading++,uploadBlob(e,$(n).data("upload-path"),a,{loadstartEventHandler:i.bind(l),progressEventHandler:o.bind(l)}).done(function(){addInlineAttachmentMarkup(e),l.progressbar("value",100).remove(),t.find("input.description, a").css("display","inline-block")}).fail(function(e){l.text(e.statusText)}).always(function(){ajaxUpload.uploading--,t.removeClass("ajax-loading");var e=t.parents("form");0==e.queue("upload").length&&0==ajaxUpload.uploading&&$("input:submit",e).removeAttr("disabled"),e.dequeue("upload")})}var l=$("<div>").insertAfter(t.find("input.filename"));l.progressbar(),t.addClass("ajax-waiting");var d=$(n).data("max-concurrent-uploads");null==d||d<=0||ajaxUpload.uploading<d?r(e,a,t,n):$(n).parents("form").queue("upload",r.bind(this,e,a,t,n))}function removeFile(){var e=$(this);return e.closest(".attachments-container").find(".add_attachment").show(),e.parent("span").remove(),!1}function uploadBlob(e,a,t,n){var i=$("#attachments_"+t).closest(".attachments-container").attr("data-tag-name"),o='input[name="attachments[dummy][file]"]',r=null;$("div.modal").is(":visible")?r=parseInt($("div.modal").find(o).attr("data-custom-version-for-attachment-id")):$(o).is(":visible")&&(r=parseInt($(o).attr("data-custom-version-for-attachment-id")));var l=$.extend({loadstartEventHandler:$.noop,progressEventHandler:$.noop},n);return a=a+"?attachment_id="+t,e instanceof window.File&&(a+="&filename="+encodeURIComponent(e.name),i&&(a+="&tag_name="+i),r&&(a+="&custom_version_for_attachment_id="+r)),$.ajax(a,{type:"POST",contentType:"application/octet-stream",beforeSend:function(a,t){a.setRequestHeader("Accept","application/js"),t.data=e},xhr:function(){var e=$.ajaxSettings.xhr();return e.upload.onloadstart=l.loadstartEventHandler,e.upload.onprogress=l.progressEventHandler,e},data:e,cache:!1,processData:!1})}function addInputFiles(e){var a=$(e),t=a.clone().val(""),n=a.closest(".attachments-container");if($.ajaxSettings.xhr().upload&&e.files)uploadAndAttachFiles(e.files,e),a.remove();else{var i,o=e.value.split(/\/|\\/);(i=addFile(e,{name:o[o.length-1]},!1))&&a.attr({name:"attachments["+i+"][file]",style:"display:none;"}).appendTo("#attachments_"+i)}const r=n.children(".add_attachment");r.prepend(t),"true"===e.dataset.onlyOneFile&&r.hide()}function uploadAndAttachFiles(e,a){var t=$(a).data("max-file-size"),n=$(a).data("max-file-size-message"),i=!1;return $.each(e,function(){this.size&&null!=t&&this.size>parseInt(t)&&(i=!0)}),i?window.alert(n):$.each(e,function(){addFile(a,this,!0)}),i}function handleFileDropEvent(e){var a;if(void 0!==(a=e.originalEvent.dataTransfer)){var t=$(this);t.removeClass("fileover"),blockEventPropagation(e);var n=t.find("input:file.filedrop.file_selector");0===n.length&&(n=t.closest(".attachments-container").find("input:file.filedrop.file_selector")),$.inArray("Files",a.types)>-1&&uploadAndAttachFiles(a.files,n)}}function dragOverHandler(e){$(this).addClass("fileover"),blockEventPropagation(e),e.dataTransfer.dropEffect="copy"}function dragOutHandler(e){$(this).removeClass("fileover"),blockEventPropagation(e)}function setupFileDrop(){window.File&&window.FileList&&window.ProgressEvent&&window.FormData&&window.FileReader&&($.event.addProp("dataTransfer"),$("form").has("input:file.filedrop").each(function(){var e=$(this);e.data().fileDropsInitialized||(e.on({dragover:dragOverHandler,dragleave:dragOutHandler,drop:handleFileDropEvent}),e.data().fileDropsInitialized=!0)}))}function addInlineAttachmentMarkup(e){if($(handleFileDropEvent.target).hasClass("wiki-edit")&&$.inArray(e.type,window.wikiImageMimeTypes)>-1){var a=$(handleFileDropEvent.target),t=a.prop("selectionStart"),n=a.val(),i=e.name.replace(/[\/\?\%\*\:\|\"\'<>\n\r]+/,"_"),o=encodeURIComponent(i).replace(/[!()]/g,function(e){return"%"+e.charCodeAt(0).toString(16)}),r=!0,l=!0;(0===t||n.substr(t-1,1).match(/\r|\n/))&&(r=!1),n.substr(t,1).match(/\r|\n/)&&(l=!1),a.val(n.substring(0,t)+(r?"\n":"")+o+(l?"\n":"")+n.substring(t,n.length)),a.prop({selectionStart:t+r,selectionEnd:t+o.length+r}),a.parents(".jstBlock").find(".jstb_img").click(),t=a.prop("selectionStart"),a.prop({selectionStart:t+1,selectionEnd:t+1})}}function copyImageFromClipboard(e){if($(e.target).hasClass("wiki-edit")){var a=e.clipboardData||e.originalEvent.clipboardData;if(a&&!a.types.some(function(e){return/^text/.test(e)}))for(var t=a.items,n=0;n<t.length;n++){var i=t[n];if(-1!=i.type.indexOf("image")){var o=i.getAsFile(),r=new Date,l="clipboard-"+r.getFullYear()+("0"+(r.getMonth()+1)).slice(-2)+("0"+r.getDate()).slice(-2)+("0"+r.getHours()).slice(-2)+("0"+r.getMinutes()).slice(-2)+"-"+randomKey(5).toLocaleLowerCase()+"."+o.name.split(".").pop(),d=new Blob([o],{type:o.type});d.name=l;var s=$("input:file.filedrop").first();handleFileDropEvent.target=e.target,addFile(s,d,!0)}}}}function unbindSetupFileDrop(){$("form div.box").each(function(){$(this).off("dragover").off("dragleave").off("drop")})}addFile.nextAttachmentId=1,ajaxUpload.uploading=0,handleFileDropEvent.target="",EASY.schedule.late(function(){unbindSetupFileDrop(),setupFileDrop()});