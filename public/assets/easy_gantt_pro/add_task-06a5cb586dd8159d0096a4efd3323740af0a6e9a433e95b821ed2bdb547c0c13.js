window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.addTask={_name:"AddTask",initToolbar:function(e){var t=new ysy.view.AddTaskPanel;t.init(ysy.settings.addTask),e.children.push(t)},patch:function(){ysy.proManager.register("initToolbar",this.initToolbar),ysy.proManager.register("close",this.close);var e=ysy.proManager,t=ysy.pro.addTask;ysy.view.AllButtons.prototype.extendees.add_task={bind:function(){if(this.model=ysy.settings.addTask,this._register(ysy.settings.resource),this.isOn()){e.closeAll(t);var a=ysy.settings.addTask;a.setSilent("open",!a.open),a._fireChanges(this,"toggle")}},func:function(){e.closeAll(t);var a=ysy.settings.addTask;a.setSilent("open",!a.open),ysy.settings.critical.open=!1,ysy.settings.cashflow&&(ysy.settings.cashflow.active=!1,ysy.data.storage.savePersistentData("cashflow",ysy.settings.cashflow.active)),ysy.data.storage.savePersistentData("criticalType",ysy.settings.critical.open),ysy.data.storage.savePersistentData("addTask",a.open),a._fireChanges(this,"toggle")},isOn:function(){return ysy.main.checkForStorageValue("addTask",ysy.settings.addTask.open)},isHidden:function(){return ysy.settings.resource.open}},ysy.proManager.register("onDragStart",function(e,t){return e.addTask=ysy.settings.addTask.open,!!e.addTask&&(e.addType=ysy.settings.addTask.type,e.startDate=gantt.dateFromPos(t.getRelativePos().x),e.lastScroll=gantt.getCachedScroll(),!0)}),ysy.proManager.register("onDragMove",function(e,a){return!!e.addTask&&(e.endDate=gantt.dateFromPos(a.getRelativePos().x),"milestone"===e.addType?e.line=t.modifyMileMarker(a.config.marker,{start_date:moment(e.endDate)},a.config.offset,e.lastScroll):e.line=t.modifyIssueMarker(a.config.marker,{start_date:moment(e.startDate),end_date:moment(e.endDate),type:e.addType},a.config.offset,e.lastScroll),!0)}),ysy.proManager.register("onDragEnd",function(e,a){if(!e.addTask)return!1;if(a.config.started){ysy.log.debug("start: "+e.startDate.toString()+" end: "+e.endDate.toString(),"taskModal");var s={start_date:moment(e.startDate),end_date:moment(e.endDate)};t.roundDates(s,"milestone"!==e.addType);var n={start_date:s.start_date.format("YYYY-MM-DD"),due_date:s.end_date.format("YYYY-MM-DD"),project_id:ysy.settings.projectID};ysy.log.debug("line="+e.line,"taskModal");var i=t.getParentByLine(e.line,e.addType);n.parent={id:i.real_id,type:i.type,project_id:i.widget.model.project_id,fixed_version_id:i.widget.model.fixed_version_id},t.openModal(e.addType,n)}return!0})},close:function(){var e=ysy.settings.addTask;e.setSilent("open",!1)&&e._fireChanges(this,"close")}},ysy.view.AddTaskPanel=function(){ysy.view.Widget.call(this)},ysy.main.extender(ysy.view.Widget,ysy.view.AddTaskPanel,{name:"AddTaskPanelWidget",templateName:"AddTaskPanel",buttons:["issue","milestone"],_repaintCore:function(){var e=ysy.settings.addTask,t=this.$target;e.open?(t.show(),t.find(".add_task_type").removeClass("active"),t.find("#add_task_"+e.type).addClass("active"),this.tideFunctionality()):t.hide()},tideFunctionality:function(){for(var e=this.buttons,t=this.$target,a=this.model,s=this,n=function(e){t.find("#add_task_"+e).off("click").on("click",function(){a.type===e?ysy.pro.addTask.openModal(e):(a.setSilent("type",e),a._fireChanges(s,"toggle"))})},i=0;i<e.length;i++)n(e[i])}}),EasyGem.extend(ysy.pro.addTask,{openModal:function(e,t){if(t===undefined&&(t={project_id:ysy.settings.projectID}),"milestone"===e&&(t.due_date=moment(t.due_date).add(1,"days").format("YYYY-MM-DD")),t.parent){var a=t.parent;if(a.id>1e12)return void dhtmlx.message(ysy.settings.labels.errors2.unsaved_parent,"error");t.project_id=a.project_id,t.fixed_version_id="milestone"===a.type?a.id:a.fixed_version_id,"task"===a.type&&(t.parent_issue_id=a.id),delete t.parent}var s=ysy.main.getModal("form-modal","90%"),n=function(){var t=ysy.pro.addTask;if(window.fillFormTextAreaFromCKEditor&&(window.fillFormTextAreaFromCKEditor("issue_description"),window.fillFormTextAreaFromCKEditor("version_description")),$(this).is("form"))var a=$(this).serializeArray();else a=s.find("form").serializeArray();var n=t.collectErrors(s,a);if(n.length)return dhtmlx.message(n.join("<br>"),"error"),$("#content").find(".flash").appendTo("body"),!1;var i=t.transformData(a,e);return"milestone"===e?t.createMilestone(i):t.createIssue(i),s.dialog("close"),!1};"milestone"===e?ysy.gateway.polymorficGet(ysy.settings.paths.newMilestonePath.replace(":projectID",t.project_id),{version:t},function(e){var t=$(e).find("#content");t.length?s.html(t.html()):s.html(e);var a=s.find("#version_project_id").val(),i=s.find("h2");if(i.replaceWith($("<h3 class='title'></h3>").html(i.html())),showModal("form-modal"),s.find("input[type=submit], .form-actions").hide(),s.find("#new_version").submit(n),s.dialog({buttons:[{id:"add_milestone_modal_submit","class":"button-1 button-positive",text:ysy.settings.labels.buttons.create,click:n}]}),s.find("#version_name").focus(),ysy.settings.easyRedmine){window.initEasyAutocomplete();var r=s.find("#version_project_id_autocomplete");r.val(r.attr("value")),s.find("#version_project_id").val(a)}}):ysy.gateway.polymorficGet(ysy.settings.paths.newIssuePath,{issue:t},function(e){s.html(e);var a=s.find("h2");a.replaceWith($("<h3 class='title'></h3>").html(a.html())),showModal("form-modal"),s.find("input[type=submit], .form-actions").hide(),s.dialog({buttons:[{id:"add_issue_modal_submit","class":"button-1 button-positive",text:ysy.settings.labels.buttons.create,click:n}]});const i=$("#form-modal #issue-form");i.length&&i.on("new-issue-attribute-reloaded",ysy.pro.addTask.setRequiredFields.bind(null,s)),ysy.pro.addTask.setRequiredFields(s),s.find("#issue-form").submit(n),0===s.find("#project_id").length&&s.find("#issue-form").append($('<input id="project_id" type="hidden" name="issue[project_id]" value="'+t.project_id+'" />')),window.initEasyAutocomplete(),s.find("#issue_subject").focus()})},setRequiredFields:function(e){const t=e[0],a=document.createElement("span");a.classList.add("required"),a.innerHTML=" *";const s=t.querySelector("#start_date_area > label");s&&(s.classList.add("required"),s.appendChild(a),s.required=!0);const n=t.querySelector("#due_date_area > label");n&&(n.classList.add("required"),n.appendChild(a),n.required=!0)},collectErrors:function(e,t){var a=[],s={};for(var n in ysy.settings.easyRedmine&&(e.find("label.required").each(function(){var e=$(this),t=e.next(),a=t.filter("[name]");0===a.length&&(a=t.find("[name]"));var n=e.text();"*"===n.charAt(n.length-1)&&(n=n.substring(0,n.length-2)),s[a.attr("name")]=n}),e.find("input[required],textarea[required],select[required]").each(function(){var e=$(this);s[e.attr("name")]=e.attr("placeholder")})),e.find("label > span.required").each(function(){var e=$(this).parent("label"),t=e.parent().find("#"+e.attr("for")),a=e.text(),n=t.attr("name");n&&(s[n]=a.substring(0,a.length-2))}),s)if(s.hasOwnProperty(n)){for(var i=!1,r=0;r<t.length;r++)if(t[r].name===n){""!==t[r].value&&(i=!0);break}i||a.push(s[n]+" "+ysy.view.getLabel("addTask","error_blank"))}return a},transformData:function(e,t){var a=ysy.main.formToJson(e);if("issue"==t)var s=a.issue;else s="milestone"==t?a.version:{};for(var n={project_id:ysy.settings.project?ysy.settings.project.id:null},i=function(e){return""===e?null:parseInt(e)},r={is_private:i,tracker_id:i,status_id:i,priority_id:i,project_id:i,assigned_to_id:i,fixed_version_id:i,easy_version_category_id:i,old_fixed_version_id:i,parent_issue_id:i,effective_date:function(e){return n.start_date=e,null},estimated_hours:function(e){return""===e?null:parseFloat(e)},done_ratio:i,activity_id:i},o=Object.getOwnPropertyNames(s),d=0;d<o.length;d++){var l=o[d];if(r.hasOwnProperty(l))var y=r[l](s[l],l);else y=s[l];n[l]=y}return n},roundDates:function(e,t){if(e.end_date){if(t&&e.end_date<e.start_date){e.end_date.add(12,"hours");var a=e.end_date;e.end_date=e.start_date,e.start_date=a}else e.end_date.add(-12,"hours");e.end_date._isEndDate=!0,gantt.date.date_part(e.end_date)}gantt.date.date_part(e.start_date)},createIssue:function(e){ysy.log.debug("creating issue "+JSON.stringify(e),"taskModal"),$.extend(e,{id:dhtmlx.uid(),name:e.subject,columns:{subject:e.subject},permissions:{editable:!0},css:"fresh"});var t=new ysy.data.Issue;t.init(e),ysy.data.issues.push(t),gantt._selected_task=t.getID()},createMilestone:function(e){ysy.log.debug("creating milestone "+JSON.stringify(e),"taskModal"),$.extend(e,{id:dhtmlx.uid(),permissions:{editable:!0},css:"fresh"});var t=new ysy.data.Milestone;t.init(e),ysy.data.milestones.push(t),gantt._selected_task=t.getID()},modifyIssueMarker:function(e,t,a,s){this.roundDates(t,!0);var n=gantt.posFromDate(t.start_date),i=gantt.config,r=gantt._get_task_height(),o=i.row_height,d=Math.floor((o-r)/2),l=parseFloat(e.style.top)-a.top;l=Math.max(l,s.y);var y=Math.floor(l/o),c=Math.min(Math.max(y,0),gantt._order.length-1)*o+d,u=gantt.posFromDate(t.end_date)-n;e.className="gantt_task_line planned gantt_"+t.type+"-type",e.innerHTML='<div class="gantt_task_content"></div>';var g=["left:"+(n+a.left)+"px","top:"+(c+a.top)+"px","height:"+r+"px","width:"+u+"px"];return e.style.cssText=g.join(";"),y},modifyMileMarker:function(e,t,a,s){gantt._working_time_helper.round_date(t.start_date);var n=gantt.posFromDate(t.start_date),i=gantt.config.row_height,r=gantt._get_task_height(),o=Math.floor((i-r)/2),d=parseFloat(e.style.top)-a.top;d=Math.max(d,s.y);var l=Math.floor(d/i),y=Math.min(Math.max(l,0),gantt._order.length-1)*i+o;e.className="gantt_task_line planned gantt_milestone-type",e.innerHTML='<div class="gantt_task_content"></div>';var c=["left:"+(n+a.left-Math.floor(r/2)-1)+"px","top:"+(y+a.top)+"px","height:"+r+"px","line-height:"+r+"px","width:"+r+"px"];return e.style.cssText=c.join(";"),l},allowedParent:{issue:["task","milestone","project"],milestone:["project"],reservation:["assignee","project"]},getParentByLine:function(e,t){var a=this.allowedParent[t],s=gantt._order;if(e<0||e>=s.length)return ysy.log.debug("wrong line number","taskModal"),null;var n=s[e],i=gantt.getTask(n);if(!i)return ysy.log.debug("task not found","taskModal"),null;for(var r=0;r<a.length;r++)if(gantt._get_safe_type(i.type)===a[r])return i;return this.getParentByLine(e-1,t)}});