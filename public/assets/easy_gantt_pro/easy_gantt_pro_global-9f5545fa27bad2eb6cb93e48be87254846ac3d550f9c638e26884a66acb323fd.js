window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.common=ysy.pro.common||{},EasyGem.extend(ysy.pro.common,{patch:function(){ysy.proManager.register("ganttConfig",this.ganttConfig),gantt.attachEvent("onGanttReady",function(){$(gantt.$grid_data).on("click",".easy-gantt__project_issues",function(){ysy.data.loader.openIssuesOfProject($(this).data("project_id"))})}),ysy.view.columnBuilders=ysy.view.columnBuilders||{},ysy.view.columnBuilders.name=function(e){var t=parseInt(e.real_id);if(isNaN(t)||t>1e12)return e.text;if("project"===e.type){const s=ysy.settings.paths.rootPath+"projects/",a=ysy.main.escapeText(e.text);return"<a class='gantt-grid-row-project' href='"+s+t+"' title='"+a+"' target='_blank'>"+a+"</a>"}},$.extend(ysy.data.loader,{loadProject:function(e){var t=this;return ysy.gateway.polymorficGetJSON(ysy.settings.paths.subprojectGantt.replace(new RegExp("(:|%3A)projectID","g"),e),null,function(s){t._handleProjectData(s,e)},function(){ysy.log.error("Error: Unable to load data")}),!0},_handleProjectData:function(e,t){var s=e.easy_gantt_data;this._loadProjects(s.projects),this._loadIssues(s.issues,t),this._loadRelations(s.relations),this._loadMilestones(s.versions),ysy.log.debug("minor data loaded","load"),this._fireChanges()},loadProjectIssues:function(e){return ysy.gateway.polymorficGetJSON(ysy.settings.paths.projectOpenedIssues.replace(new RegExp("(:|%3A)projectID","g"),e),null,$.proxy(this._handleProjectData,this),function(){ysy.log.error("Error: Unable to load data")}),!0},openIssuesOfProject:function(e){var t=ysy.data.projects.getByID(e);t&&(ysy.data.limits.openings["s"+e]=!0,t.issues_count&&(delete t.issues_count,gantt.open(t.getID()),this.loadProjectIssues(e)))}})},ganttConfig:function(e){$.extend(e,{allowedParent_task:["project","milestone","task","empty"],allowedParent_task_global:["project","milestone","task"]})}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.sorting=EasyGem.extend(ysy.pro.sorting,{name:"Sorter",patch:function(){var e=new ysy.data.Data;e.init({_name:"Sorting",sortBy:null}),ysy.settings.sorting=e,gantt.attachEvent("onGanttReady",$.proxy(this.bindClick,gantt))},columnCompares:{start_date:function(e,t){return(e._start_date||e.start_date)-(t._start_date||t.start_date)},due_date:function(e,t){return(e._end_date||e.end_date)-(t._end_date||t.end_date)},subject:function(e,t){return e.text.localeCompare(t.text)},priority:function(e,t){return e.priority_position-t.priority_position}},defaultCompare:function(e){return function(t,s){return+t.columns[e]&&+s.columns[e]?+t.columns[e]-+s.columns[e]:t.columns[e].toString().localeCompare(s.columns[e].toString())}},getCompareFunction:function(e,t){var s=t?-1:1;if(this.columnCompares[e])var a=this.columnCompares[e];else a=this.defaultCompare(e);return function(e,t){var r=ysy.pro.sorting.columnsValidation(e,t);return r===undefined?(0===(r=a(e,t))&&(r=e.order-t.order),s*r):r}},columnsValidation:function(e,t){return e.columns?t.columns?undefined:1:t.columns?-1:e.type===t.type&&e.subtype===t.subtype?e.text.localeCompare(t.text):e.order-t.order},bindClick:function(){this._click.gantt_grid_head_cell=dhtmlx.bind(function(e,t,s){var a=s.getAttribute("column_id");if(this.callEvent("onGridHeaderClick",[a,e])){if(this._sort&&this._sort.direction&&this._sort.name==a){var r=this._sort.direction;if("desc"===r)return this._sort=null,void this.sort();r="desc"==r?"asc":"desc"}else r="asc";var n=ysy.pro.sorting.getCompareFunction(a,"desc"==r);this._sort={name:a,criteria:n,direction:r},this.sort(n)}},this)}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.silencer=ysy.pro.silencer||{},EasyGem.extend(ysy.pro.silencer,{setting:null,name:"Silencer",patch:function(){ysy.proManager.register("beforeSaveIssue",this.updateSaveData),this.setting=new ysy.data.Data,this.setting.init({name:this.name,turnedOn:!1});var e=$(' <input id="checkbox_silencer" class="gantt-menu-checkbox" type="checkbox" ><label for="checkbox_silencer">'+ysy.settings.labels.silencer.label_disable_notifications+"</label>");$("#button_month_zoom").after(e),ysy.view.AllButtons.prototype.extendees.silencer={widget:ysy.view.CheckBox,bind:function(){this.model=ysy.pro.silencer.setting},func:function(){this.model.turnedOn=this.$target.is(":checked"),this.model._fireChanges(this,"click")},isOn:function(){return this.model.turnedOn}}},updateSaveData:function(e){ysy.pro.silencer.setting.turnedOn&&(e.easy_gantt_suppress_notification=!0)}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.schemes={patch:function(){ysy.proManager.register("extendGanttTask",this.extendGanttTask),ysy.data.schemes=(new ysy.data.Array).init({_name:"IssueSchemeArray"}),ysy.data.projectSchemes=(new ysy.data.Array).init({_name:"ProjectSchemeArray"}),ysy.pro.toolPanel.registerButton({id:"scheme_select",widget:ysy.view.Select,bind:function(){this.model=ysy.settings.scheme},func:function(){var e=this.$target.val();this.model.setSilent("by",e),this.model._fireChanges(this,e+" selected")},modelValue:function(){return this.model.by}}),ysy.data.loader._loadSchemes=function(e){if(ysy.settings.easyRedmine&&(ysy.data.schemes.clear(),ysy.data.projectSchemes.clear(),e)){var t=ysy.data.schemes;e.IssueStatus&&t.push((new ysy.data.Scheme).init(e.IssueStatus,"issue_status")),e.IssuePriority&&t.push((new ysy.data.Scheme).init(e.IssuePriority,"issue_priority")),e.Tracker&&t.push((new ysy.data.Scheme).init(e.Tracker,"tracker")),e.EasyProjectPriority&&ysy.data.projectSchemes.push((new ysy.data.Scheme).init(e.EasyProjectPriority,"project_priority"))}}},extendGanttTask:function(e,t){"project"===t.type&&(t.css+=ysy.pro.schemes.getProjectSchemeOf(e,t)),"task"===t.type&&ysy.data.schemes&&(t.css+=ysy.pro.schemes.getSchemeOf(e,t))},getSchemeOf:function(e){var t=ysy.data.schemes.getByID(ysy.settings.scheme.by);return t?t.getSchemeOf(e):""},getProjectSchemeOf:function(e){if("project_status"===ysy.settings.scheme.by&&e.status_id>1)return" gantt-scheme-project-status-"+e.status_id;var t=ysy.data.projectSchemes.getByID(ysy.settings.scheme.by);return t?t.getSchemeOf(e):""}},ysy.data.Scheme=function(){ysy.data.Data.call(this)},ysy.main.extender(ysy.data.Data,ysy.data.Scheme,{_name:"Scheme",issueMapping:{issue_priority:"priority_id",issue_status:"status_id",tracker:"tracker_id",project_priority:"priority_id"},init:function(e,t){this.id=t;for(var s=0;s<e.length;s++)this[e[s].id]=e[s].scheme;return this},getSchemeOf:function(e){if(this.issueMapping[ysy.settings.scheme.by]){var t=e[this.issueMapping[ysy.settings.scheme.by]];return this[t]?" "+this[t]:""}}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.cashflow=ysy.pro.cashflow||{},EasyGem.extend(ysy.pro.cashflow,{name:"CashFlow",styles:{positive:{textColor:"#484848",fontStyle:"12px Courier"},negative:{textColor:"#ff0000",fontStyle:"12px Courier"}},doNotCloseToolPanel:!0,registeredOnLoader:!1,buttonExtendee:{id:"cashflow",bind:function(){window.EASY&&EASY.getSassData&&(ysy.pro.cashflow.styles={positive:{textColor:EASY.getSassData("resource-color-text","#484848",!1),fontStyle:"12px Courier"},negative:{textColor:EASY.getSassData("resource-color-text-over-allocations","#ff0000",!1),fontStyle:"12px Courier"}}),this.model=ysy.settings.cashflow,this._register(ysy.settings.resource),this.isOn()&&ysy.pro.cashflow.open()},func:function(){this.isOn()?ysy.pro.cashflow.close():ysy.pro.cashflow.open(),ysy.data.storage.savePersistentData("cashflow",ysy.settings.cashflow.active)},isOn:function(){return ysy.main.checkForStorageValue("cashflow",ysy.settings.cashflow.active)},isHidden:function(){return ysy.settings.resource.open}},patch:function(){$("#easy_gantt_menu").find("#button_cashflow").length?(ysy.view.Toolbars.prototype.childTargets.CashFlowPanelWidget="#cashflow_panel",ysy.proManager.register("initToolbar",this.initToolbar),ysy.settings.cashflow=new ysy.data.Data,ysy.settings.cashflow.init({_name:"CashFlow",active:!1,open:!1,activeCashflow:null,realLoaded:!1,plannedLoaded:!1}),ysy.proManager.register("close",this.close),ysy.settings.global?ysy.view.AllButtons.prototype.extendees.cashflow=this.buttonExtendee:ysy.pro.toolPanel.registerButton(this.buttonExtendee),ysy.pro.sumRow.summers.cashflow={day:function(e,t){return t.isProject?t.parent_id?0:t.start_date.isAfter(e)?0:t.end_date.isBefore(e)?0:(t._shift&&(e=moment(e).subtract(t._shift,"days")),ysy.pro.cashflow.cashRenderer(t)[e.format("YYYY-MM-DD")]||0):0},week:function(e,t,s){if(!s.isProject)return 0;if(s.parent_id)return 0;if(s.start_date.isAfter(t))return 0;if(s.end_date.isBefore(e))return 0;var a=0,r=moment(e),n=ysy.pro.cashflow.cashRenderer(s);for(s._shift&&(r.subtract(s._shift,"days"),t=moment(t).subtract(s._shift,"days"));r.isBefore(t);){var o=n[r.format("YYYY-MM-DD")];o&&(a+=o),r.add(1,"day")}return a},formatter:ysy.pro.cashflow.formatter,entities:["projects"],title:"CashFlow"}):ysy.pro.cashflow=null},open:function(){var e=ysy.settings.cashflow;if(e.setSilent("active",!0)){var t=ysy.pro.cashflow;t.showCashflow("real"),ysy.view.bars.registerRenderer("project",this.outerRenderer),ysy.settings.sumRow.setSummer("cashflow"),t.eventId=gantt.attachEvent("onTaskClick",t.showTooltip),ysy.proManager.closeAll(this),this.registeredOnLoader||(this.registeredOnLoader=!0,ysy.data.loader.register(function(){var t=e.activeCashflow;e.active&&(this._resetProjects(),this.showCashflow(t))},this)),ysy.settings.critical.open=!1,ysy.settings.addTask.open=!1,ysy.data.storage.savePersistentData("criticalType",ysy.settings.critical.open),ysy.data.storage.savePersistentData("addTask",ysy.settings.addTask.open),e._fireChanges(this,"toggle")}},close:function(){var e=ysy.settings.cashflow;e.setSilent("active",!1)&&(ysy.view.bars.removeRenderer("project",ysy.pro.cashflow.outerRenderer),ysy.pro.cashflow.setProjectDateBack(),e.setSilent("activeCashflow","nothing"),e.setSilent("open",!1),ysy.settings.sumRow.removeSummer("cashflow"),gantt.detachEvent(ysy.pro.cashflow.eventId),e._fireChanges(this,"toggle"))},setProjectDateBack:function(){let e=ysy.data.projects.array;for(array in e){if(!e.hasOwnProperty(array))continue;let t=e[array];if(!t.cashflow)continue;let s=t.cashflow;s.originStartDate&&t.start_date.isBefore(s.originStartDate)&&t.start_date===s.cashflowStartDate&&t.setSilent("start_date",s.originStartDate),s.originEndDate&&t.end_date.isAfter(s.originEndDate)&&t.end_date===s.cashflowEndDate&&t.setSilent("end_date",s.originEndDate)}},showTooltip:function(e,t){var s=ysy.settings,a=$(t.target);if(!a.hasClass("gantt-task-bar-canvas"))return!0;var r=gantt._pull[e];if(!r)return!0;var n=a.closest(".gantt_bars_area").offset(),o=s.zoom.zoom,i=moment(gantt.dateFromPos2(t.pageX-n.left)).startOf("week"===o?"isoWeek":o),l=ysy.pro.cashflow.tooltipOut(r.widget.model,i,o);if("difference"===s.cashflow.activeCashflow){if(!l.difference)return!0;ysy.view.tooltip.show("gantt-tooltip-cashflow",t,ysy.view.templates.differenceCashflowTooltip,l)}else if("month"===o){if(0===l.weeks.length)return!0;ysy.view.tooltip.show("gantt-tooltip-cashflow",t,ysy.view.templates.monthCashflowTooltip,l)}else{if(0===l.dates.length)return!0;ysy.view.tooltip.show("gantt-tooltip-cashflow",t,ysy.view.templates.CashflowTooltip,l)}return $("#gantt_tooltip").off("click").on("click","h4",function(){$(this).parent().children("div").toggleClass("hidden")}),!1},noHtmlFormatter:function(e,t){return ysy.pro.cashflow.formatter(e,t,!0)},formatter:function(e,t,s){if(0===e)return"0";var a=["","k","M","G","T","P","E","Z","Y"],r=e<0;e=Math.abs(e);var n,o=1;t<50&&(o=.1);for(var i=1,l=0;l<a.length;l++){if(e/i<1e3){if(0===l){n=ysy.pro.cashflow.roundTo(e,10*o);break}n=ysy.pro.cashflow.roundTo(e/i,o)+a[l];break}if(l===a.length-1){n=ysy.pro.cashflow.roundTo(e/i,o)+a[l];break}i*=1e3}return t>35&&r&&(n="-"+n),s?n:r?'<span title="-'+e+'" class="gantt-sum-row-negative">'+n+"</span>":'<span title="'+e+'">'+n+"</span>"},roundTo:function(e,t){return e%1<.05?Math.round(e).toString():e>=100*t?Math.round(e).toString():e.toFixed(1)},outerRenderer:function(e,t){var s=t().call(this,e,t),a=ysy.pro.cashflow._projectRenderer.call(gantt,e);return ysy.view.bars.insertCanvas(a,s),s},cashRenderer:function(e,t){var s=t||ysy.settings.cashflow,a={},r=-1,n="nothing",o=null,i=null,l=0;if("planned"===s.activeCashflow)var y=["_planned_expenses","_planned_revenues"];else y="real"===s.activeCashflow?["_real_expenses","_real_revenues"]:["_planned_expenses","_planned_revenues","_real_expenses","_real_revenues"];if("timeflow"===s.activeCashflow){var d=moment().format("YYYY-MM-DD");for(l=0;l<y.length;l++){for(i in o=e[n=y[l]])o.hasOwnProperty(i)&&(a[i]||(a[i]=0),"_planned_expenses"!==n&&"_planned_revenues"!==n||i>=d&&(a[i]+=o[i]*r),"_real_expenses"!==n&&"_real_revenues"!==n||i<d&&(a[i]+=o[i]*r));r*=-1}}else if("difference"===s.activeCashflow)for(l=0;l<y.length;l++){for(i in o=e[n=y[l]])o.hasOwnProperty(i)&&(a[i]||(a[i]=0),"_real_expenses"!==n&&"_real_revenues"!==n||(a[i]+=o[i]*r),"_planned_expenses"!==n&&"_planned_revenues"!==n||(a[i]-=o[i]*r));r*=-1}else for(l=0;l<y.length;l++){for(i in o=e[n=y[l]])o.hasOwnProperty(i)&&(a[i]||(a[i]=0),a[i]+=o[i]*r);r*=-1}return a},_projectRenderer:function(e){var t=ysy.pro.cashflow,s=e.widget&&e.widget.model,a=ysy.view.bars.canvasListBuilder();a.build(e,this);var r=ysy.pro.cashflow.cashRenderer(s);"day"!==ysy.settings.zoom.zoom?$.proxy(t._projectWeekRenderer,this)(e,r,a,s._shift):$.proxy(t._projectDayRenderer,this)(e,r,a,s._shift);var n=a.getElement();return n.className+=" project",n},_projectDayRenderer:function(e,t,s,a){var r=ysy.pro.cashflow;for(var n in t)if(t.hasOwnProperty(n)&&t[n]){var o=t[n];if(a){var i=moment(n).add(a,"days");if(!s.inRange(i))continue;n=i.format("YYYY-MM-DD")}else if(!s.inRange(n))continue;s.fillFormattedTextAt(n,r.noHtmlFormatter,o,o<0?r.styles.negative:r.styles.positive)}},_projectWeekRenderer:function(e,t,s,a){var r=ysy.pro.cashflow,n=r.weekCashSummer(t,ysy.settings.zoom.zoom,e.start_date,e.end_date,a);for(var o in n)if(n.hasOwnProperty(o)){var i=n[o];s.fillFormattedTextAt(o,r.noHtmlFormatter,i,i<0?r.styles.negative:r.styles.positive)}},weekCashSummer:function(e,t,s,a,r){var n=ysy.view.bars,o=s.valueOf(),i=moment(a).add(1,"days").valueOf(),l={};for(var y in e)if(e.hasOwnProperty(y)){var d=n.getFromDateCache(y),c=e[y];if(r&&(y=(d=moment(d).add(r,"days")).format("YYYY-MM-DD")),!(+d<o)&&!(+d>i)&&c){var f=moment(d).startOf("week"===t?"isoWeek":t).toISOString();l[f]===undefined?l[f]=c:l[f]+=c}}return l},initToolbar:function(e){var t=new ysy.view.CashFlowPanel;t.init(ysy.settings.cashflow),e.children.push(t)},tooltipOut:function(e,t,s,a,r){r=r||moment().format("YYYY-MM-DD");a=a||ysy.settings.cashflow;var n=ysy.pro.cashflow.cashRenderer(e,a),o={},i={};"planned"===a.activeCashflow&&(o=e._planned_expenses,i=e._planned_revenues),"real"===a.activeCashflow&&(o=e._real_expenses,i=e._real_revenues);var l=[],y=[],d=e._shift;d&&t.add(d,"days");for(var c=0,f=0,h=0,u=moment(t).startOf("week"===s?"isoweek":s),p=moment(u).add(1,s);u.isBefore(p);){var g=u.format("YYYY-MM-DD");if(n[g]){var _=0,w=0;"planned"!==a.activeCashflow&&"real"!==a.activeCashflow||(o&&o[g]&&(_+=o[g]),i&&i[g]&&(w+=i[g])),"timeflow"===a.activeCashflow&&(e._planned_expenses[g]&&r<g&&(_+=e._planned_expenses[g]),e._real_expenses[g]&&g<=r&&(_+=e._real_expenses[g]),e._planned_revenues[g]&&r<g&&(w+=e._planned_revenues[g]),e._real_revenues[g]&&g<=r&&(w+=e._real_revenues[g])),"difference"===a.activeCashflow&&(e._planned_expenses[g]&&(h-=e._planned_expenses[g]),e._real_expenses[g]&&(f-=e._real_expenses[g]),e._planned_revenues[g]&&(h+=e._planned_revenues[g]),e._real_revenues[g]&&(f+=e._real_revenues[g]));var m=n[g];if(c+=m,(_||w)&&(l.push({date:u.format("DD MMMM YYYY"),expense:_,revenue:w,fullPrice:m,positiveNegativeClass:m<0?"negative":"positive"}),1===l.length&&(l[0].first=!0)),"difference"===a.activeCashflow){var v=null;"day"===s&&(v=u.format("DD MMMM YYYY")),"week"===s&&(v=u.isoWeek()+" week"),"month"===s&&(v=u.format("MMMM YYYY"))}u.add(1,"day")}else u.add(1,"day")}if("difference"===a.activeCashflow){if(0===f&&0===h)return;return{date:v,realCashflow:f,realPositiveNegativeClass:f<0?"negative":"positive",plannedCashflow:h,plannedPositiveNegativeClass:h<0?"negative":"positive",difference:c,differencePositiveNegativeClass:c<0?"negative":"positive"}}var x={},C={},j={},D={};if("day"===s)return{dates:l};if("week"===s)return{dates:l,total:c};if("month"===s){for(var k=0;k<l.length;k++){var b=l[k],P=moment(b.date,"DD MMMM YYYY").isoWeek();_=b.expense,w=b.revenue,m=b.fullPrice,x[P]||(x[P]=0),_&&(x[P]+=_),C[P]||(C[P]=0),w&&(C[P]+=w),j[P]||(j[P]=0),j[P]+=m,D[P]||(D[P]=[]),D[P].push({date:b.date,expense:_,revenue:w,fullPrice:m,positiveNegativeClass:m<0?"negative":"positive"})}for(P in j)y.push({weekNumber:P,weekExpenses:x[P],weekRevenues:C[P],weekFullPrice:j[P],weekPositiveNegativeClass:j[P]<0?"negative":"positive",dates:D[P]});return{weeks:y,totalPrice:c,totalPositiveNegativeClass:c<0?"negative":"positive"}}}}),ysy.view=ysy.view||{},ysy.view.CashFlowPanel=function(){ysy.view.Widget.call(this)},ysy.main.extender(ysy.view.Widget,ysy.view.CashFlowPanel,{name:"CashFlowPanelWidget",templateName:"CashFlowPanel",_repaintCore:function(){var e=ysy.settings.cashflow,t=this.$target;e.active?t.show():t.hide(),this.toolbar(),this.tideFunctionality()},tideFunctionality:function(){var e=this;this.$target.find("#cashflow_planned").off("click").on("click",function(){ysy.pro.cashflow.showCashflow("planned"),e.toolbar()}),this.$target.find("#cashflow_real").off("click").on("click",function(){ysy.pro.cashflow.showCashflow("real"),e.toolbar()}),this.$target.find("#cashflow_timeflow").off("click").on("click",function(){ysy.pro.cashflow.showCashflow("timeflow"),e.toolbar()}),this.$target.find("#cashflow_difference").off("click").on("click",function(){ysy.pro.cashflow.showCashflow("difference"),e.toolbar()}),this.$target.find("#button_cashflow_help").off("click").on("click",ysy.proManager.showHelp)},toolbar:function(){var e=ysy.settings.cashflow,t=this.$target;"planned"===e.activeCashflow?t.find("#cashflow_planned").addClass("active"):t.find("#cashflow_planned").removeClass("active"),"real"===e.activeCashflow?t.find("#cashflow_real").addClass("active"):t.find("#cashflow_real").removeClass("active"),"timeflow"===e.activeCashflow?t.find("#cashflow_timeflow").addClass("active"):t.find("#cashflow_timeflow").removeClass("active"),"difference"===e.activeCashflow?t.find("#cashflow_difference").addClass("active"):t.find("#cashflow_difference").removeClass("active")}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.cashflow=ysy.pro.cashflow||{},EasyGem.extend(ysy.pro.cashflow,{_resetProjects:function(){for(var e=ysy.settings.cashflow,t=ysy.data.projects.getArray(),s=0;s<t.length;s++)delete t[s]._planned_expenses,delete t[s]._planned_revenues,delete t[s]._real_revenues,delete t[s]._real_revenues;e.setSilent({plannedLoaded:!1,realLoaded:!1,activeCashflow:"nothing"})},showCashflow:function(e){var t=ysy.settings.cashflow,s=!1;if(t.activeCashflow!==e){var a=ysy.data.projects.getArray();t.setSilent("activeCashflow",e),!t.plannedLoaded&&"planned"===t.activeCashflow||!t.realLoaded&&"real"===t.activeCashflow?this._handleCashflow():t.open||(s=!0);for(var r=0;r<a.length;r++){var n=a[r];if(s&&n.cashflow){let e=n.cashflow;e.cashflowStartDate&&n.start_date.isAfter(e.cashflowStartDate)&&n.setSilent("start_date",e.cashflowStartDate),e.originEndDate&&n.end_date.isBefore(e.cashflowEndDate)&&n.setSilent("end_date",e.cashflowEndDate)}n._fireChanges(this,"CashFlow")}t.setSilent("open",!0)}},_handleCashflow:function(){var e=ysy.data.projects.getArray().map(function(e){return e.id});ysy.gateway.polymorficPostJSON(ysy.settings.paths.cashflow,{project_ids:e,include_planned:this._loadDataFor("planned")?1:0,include_real:this._loadDataFor("real")?1:0},$.proxy(this._loadProjects,this),function(){ysy.log.error("Error: Unable to load data")})},_loadDataFor:function(e){var t=null;"planned"===e?t="real":"real"===e&&(t="planned");var s=ysy.settings.cashflow;return!s[e+"Loaded"]&&s.activeCashflow!==t},_loadProjects:function(e){if(e){for(var t=ysy.data.projects,s=ysy.settings.cashflow,a=!1,r=!1,n=Object.getOwnPropertyNames(e),o=0;o<n.length;o++){var i=n[o],l=t.getByID(i),y=e[i],d={startDate:"9999-12-31",endDate:"0000-01-01"};y.planned_expenses&&(l._planned_expenses=y.planned_expenses,this.findLimits(y.planned_expenses,d),a=!0),y.planned_revenues&&(l._planned_revenues=y.planned_revenues,this.findLimits(y.planned_revenues,d),a=!0),y.real_expenses&&(l._real_expenses=y.real_expenses,this.findLimits(y.real_expenses,d),r=!0),y.real_revenues&&(l._real_revenues=y.real_revenues,this.findLimits(y.real_revenues,d),r=!0);var c=moment(d.startDate),f=moment(d.endDate);l.cashflow=l.cashflow||{};var h=l.cashflow;l.start_date.isAfter(c)&&(h.originStartDate||(l.cashflow.originStartDate=l.start_date),h.cashflowStartDate=c,l.setSilent("start_date",c)),l.end_date.isBefore(f)&&(f._isEndDate=!0,h.originEndDate||(l.cashflow.originEndDate=l.end_date),h.cashflowEndDate=f,l.setSilent("end_date",f)),ysy.log.debug("cashflow loaded",s.activeCashflow),l._fireChanges(this,"CashFlow")}a&&s.setSilent("plannedLoaded",!0),r&&s.setSilent("realLoaded",!0)}},findLimits:function(e,t){var s=Object.getOwnPropertyNames(e).sort();t.startDate>s[0]&&(t.startDate=s[0]);var a=s.length-1;t.endDate<s[a]&&(t.endDate=s[a])}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.unfixRelations=ysy.pro.unfixRelations||{},EasyGem.extend(ysy.pro.unfixRelations,{name:"UnfixRelations",buttonExtendee:{id:"unfix_relations",bind(){this.model=ysy.settings.unfixRelations,this._register(ysy.settings.resource),this.isOn()&&ysy.pro.unfixRelations.open()},func(){this.isOn()?ysy.pro.unfixRelations.close():ysy.pro.unfixRelations.open(),ysy.data.storage.savePersistentData("unfixRelations",ysy.settings.unfixRelations.active)},isOn:()=>ysy.main.checkForStorageValue("unfixRelations",ysy.settings.unfixRelations.active)},patch(){$("#easy_gantt_menu").find("#button_unfix_relations").length?(ysy.settings.unfixRelations=new ysy.data.Data,ysy.settings.unfixRelations.init({_name:"UnfixRelations",active:!1}),ysy.pro.toolPanel.registerButton(this.buttonExtendee)):ysy.pro.unfixRelations=null},open(){const e=ysy.settings.unfixRelations;if(e.setSilent("active",!0)){const t=gantt.getLinks();t.length>0&&t.forEach(e=>{this.addUnfix(e)}),e._fireChanges(this,"toggle")}},close(){const e=ysy.settings.unfixRelations;this.removeUnfixRelations(),e.setSilent("active",!1)&&e._fireChanges(this,"toggle")},removeUnfixRelations(){gantt.getLinks().forEach(e=>{this.removeUnfix(e)})},removeUnfix(e){const t=e.widget.model,s=ysy.pro.relations.getMinimizedDelay(t);s>=t._old.delay&&ysy.settings.unfixRelations.active?t.set({delay:t._old.delay,_unlocked:!1,history:!1}):t.set({delay:s,_unlocked:!1})},addUnfix(e){const t=e.widget.model;ysy.settings.unfixRelations.active&&t.set({delay:0,_unlocked:!0,history:!1})}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.projectMove={patch:function(){ysy.proManager.register("extendGanttTask",this.extendGanttTask),ysy.data.Project.prototype._shift=0,gantt.attachEvent("onBeforeTaskOpened",function(e){var t=gantt._pull[e];return!t||!t.widget||("project"!==t.type||(!t.widget.model._shift||(dhtmlx.message(ysy.settings.labels.projectMove.error_opening_unsaved,"error"),!1)))}),gantt.attachEvent("onTaskOpened",function(e){var t=gantt._pull[e];if(!t||!t.widget)return!0;"project"===t.type&&(t.editable=!1)}),ysy.data.saver.sendProjects=function(){var e,t;if(ysy.data.projects){var s=ysy.data.projects.array;for(e=0;e<s.length;e++){var a=s[e];a._changed&&((a.needLoad||a.issues_count||a.has_subprojects)&&(t={days:a._shift},ysy.gateway.sendProject("PUT",a,t,ysy.data.saver.callbackBuilder(a))))}}}},extendGanttTask:function(e,t){"project"===t.type&&(function(e){return e.has_subprojects?e.needLoad:!!e.issues_count===e.hadIssue}(e)&&(t.editable=!0,t.shift=86400*e._shift))}},window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.lowestProgress={patch:function(){ysy.settings.showLowestProgress?(ysy.pro.lowestProgress={name:"LowestProgressIssue",data:{},laggies:{},loaded:!1,setting:null,className:" gantt-issue-lagging",patch:function(){var e=ysy.pro.lowestProgress;this.setting=new ysy.data.Data,this.setting.init({name:this.name,turnedOn:!1}),ysy.pro.toolPanel.registerButton({id:"show_lowest_progress_tasks",bind:function(){this.model=e.setting},func:function(){(this.model.turnedOn=!this.model.turnedOn,this.model._fireChanges(this,"click"),this.model.turnedOn)?e.load()||e.colorizeLaggies():(e.resetLaggies(),e.decolorizeLaggies())},isOn:function(){return this.model.turnedOn}}),gantt.templates.task_text=function(t,s,a){if(!e.setting.turnedOn)return"";if("project"===a.type&&a.widget&&a.widget.model){var r=a.widget.model.id,n=e.data[r];if(n)return Mustache.render(ysy.view.templates.lowestProgressText,n).replace(/,\s+#\$@&/,"")}return""},ysy.data.loader.register(function(){this.setting.turnedOn&&(ysy.data.loader.loaded||this.resetLaggies(),this.load()||this.colorizeLaggies())},this)},load:function(){for(var e=[],t=ysy.data.projects.getArray(),s=0;s<t.length;s++){var a=t[s].id;this.data[a]===undefined&&e.push(a)}return!!e.length&&(ysy.gateway.polymorficPostJSON(ysy.settings.paths.lowestProgressTasks,{project_ids:e},$.proxy(ysy.pro.lowestProgress._loadLaggies,this),ysy.pro.lowestProgress._handleError),!0)},_handleError:function(e){console.error(e)},_loadLaggies:function(e){if(e&&e.easy_gantt_data){for(var t=e.easy_gantt_data.issues,s=0;s<t.length;s++){var a=t[s];this.laggies[a.id]=a;var r=a.project_id;this.data[r]||(this.data[r]={progress_date:a.progress_date,issues:[]}),this.data[r].issues.push(a)}var n=ysy.data.projects.getArray();for(s=0;s<n.length;s++)r=n[s].id,this.data[r]===undefined&&(this.data[r]=!1);this._redrawAllProjects("loaded"),this.colorizeLaggies(),this.loaded=!0}},resetLaggies:function(){this.data={},this.laggies={},this.loaded=!1,this._redrawAllProjects("reset")},_redrawAllProjects:function(e){for(var t=ysy.data.projects.getArray(),s=0;s<t.length;s++)t[s]._fireChanges(this,e)},colorizeLaggies:function(){var e=ysy.data.issues;for(var t in this.laggies)if(this.laggies.hasOwnProperty(t)){var s=this.laggies[t],a=e.getByID(s.id);a&&(a.css&&a.css.indexOf(this.className)>-1||(a.css===undefined&&(a.css=""),a.css+=this.className,a._fireChanges(this,"colorizeLaggies")))}},decolorizeLaggies:function(){for(var e=ysy.data.issues.getArray(),t=0;t<e.length;t++){var s=e[t];s.css&&-1!==s.css.indexOf(this.className)&&(s.css=s.css.replace(this.className,""),s._fireChanges(this,"decolorizeLaggies"))}}},ysy.pro.lowestProgress.patch()):ysy.pro.lowestProgress=null}},window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.delayed_projects={patch:function(){if(ysy.settings.global&&ysy.settings.showProjectProgress){ysy.pro.toolPanel.registerButton({id:"delayed_project_filter",bind:function(){this.model=ysy.data.limits},func:function(){this.model.filter_delayed_projects=!this.model.filter_delayed_projects,ysy.pro.delayed_projects.updateRegistration(this.model.filter_delayed_projects),this.model._fireChanges(this,"click")},isOn:function(){return this.model.filter_delayed_projects},isRemoved:function(){return!ysy.settings.global}});var e=moment();ysy.data.Project.prototype.problems=$.extend(ysy.data.Project.prototype.problems,{overDue:function(){if(100!==this.done_ratio&&this.start_date&&this.end_date){var t=this.start_date+this.done_ratio/100*(this.end_date-this.start_date);return t<e?ysy.settings.labels.problems.progressDateOverdue.replace("%{days}",e.diff(t,"days")):void 0}}})}},updateRegistration:function(e){e?ysy.proManager.register("filterTask",this.filterTask):ysy.proManager.unregister("filterTask",this.filterTask)},filterTask:function(e,t){if("project"===t.type){if(1===t.progress)return!1;if(t.progress>=(moment()-t.start_date)/(t.end_date-t.start_date))return!1}return!0}},window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.projectMilestones={patch:function(){ysy.settings.showProjectMilestones&&ysy.view.bars.registerRenderer("project",function(e,t){var s=t().call(this,e,t);if(e.$open)return s;for(var a,r,n=ysy.data.milestones.array,o=e.real_id,i=0;i<n.length;i++){var l=n[i];if(l.project_id===o&&!l._noDate){a||((a=$("<div class='gantt-project-milestones'>")).css("top",gantt.config.task_height/2-1+"px"),r=gantt.posFromDate(e.start_date)+1);var y=l.start_date.valueOf()+864e5,d=gantt.posFromDate(y),c=l.name+"\n"+l.start_date.format("YYYY-MM-DD");a.append("<div class='gantt-project-milestone' title='"+c+"' style='left:"+(d-r)+"px'></div>")}}return a?($(s).append(a),s):s})}},window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.ggrm={_name:"GGRM",patch:function(){ysy.pro.resource&&ysy.pro.resource.project_canvas_renderer?(ysy.pro.ggrm={_name:"GGRM",patch:function(){ysy.proManager.register("close",this.close);var e=ysy.pro.ggrm;ysy.view.AllButtons.prototype.extendees.ggrm={bind:function(){this.model=ysy.settings.resource},func:function(){ysy.settings.resource.ggrm?e.close():e.open()},isOn:function(){return ysy.settings.resource.ggrm}},ysy.pro.resource.compileStyles(),ysy.pro.sumRow.summers.ggrm={day:function(e,t){if(t.start_date.isAfter(e))return 0;if(t.end_date.isBefore(e))return 0;if(!t._ganttResources)return 0;var s=t._ganttResources[e.format("YYYY-MM-DD")];return s>0?s:0},week:function(e,t,s){if(s.start_date.isAfter(t))return 0;if(s.end_date.isBefore(e))return 0;if(!s._ganttResources)return 0;for(var a=0,r=moment(e);r.isBefore(t);){var n=s._ganttResources[r.format("YYYY-MM-DD")];n>0&&(a+=n),r.add(1,"day")}return a},entities:["projects"],title:"GGRM"}},open:function(){var e=ysy.settings.resource;e.setSilent("ggrm",!0)&&(this.loadResources(),ysy.settings.sumRow.setSummer("ggrm"),ysy.view.bars.registerRenderer("project",this.outerRenderer),ysy.proManager.closeAll(this),e._fireChanges(this,"toggle")),this.registeredOnLoader||(this.registeredOnLoader=!0,ysy.data.loader.register(function(){ysy.settings.resource.ggrm&&this.loadResources()},this))},close:function(){var e=ysy.settings.resource;e.setSilent("ggrm",!1)&&(ysy.settings.sumRow.removeSummer("ggrm"),ysy.view.bars.removeRenderer("project",ysy.pro.ggrm.outerRenderer),e._fireChanges(this,"toggle"))},loadResources:function(e){var t,s,a,r=[];if(e)r.push(e),t=(a=ysy.data.projects.getByID(e)).start_date,s=a.end_date;else for(var n=ysy.data.projects.getArray(),o=0;o<n.length;o++)a=n[o],r.push(a.id),(!t||a.start_date&&a.start_date.isBefore(t))&&(t=a.start_date),(!s||a.end_date&&a.end_date.isAfter(s))&&(s=a.end_date);ysy.gateway.polymorficPostJSON(ysy.settings.paths.globalGanttResources.replace(":start",t.format("YYYY-MM-DD")).replace(":end",s.format("YYYY-MM-DD")),{project_ids:r},$.proxy(this._handleResourcesData,this),function(){ysy.log.error("Error: Unable to load data")})},_handleResourcesData:function(e){var t=e.easy_resource_data;t&&(this._resetProjects(),this._loadProjects(t.projects))},_resetProjects:function(){for(var e=ysy.data.projects.getArray(),t=0;t<e.length;t++)delete e[t]._ganttResources},_loadProjects:function(e){for(var t=ysy.data.projects,s=0;s<e.length;s++){ysy.main._resourcesStringToFloat(e[s].resources_sums);var a=t.getByID(e[s].id);a&&(a._ganttResources=e[s].resources_sums,a._fireChanges(this,"load resources"))}},outerRenderer:function(e,t){var s=t().call(this,e,t),a=ysy.pro.ggrm._projectRenderer.call(gantt,e);return ysy.view.bars.insertCanvas(a,s),s},_projectRenderer:function(e){var t=ysy.pro.resource,s={allocations:(e.widget&&e.widget.model)._ganttResources||{},types:{}},a=ysy.view.bars.canvasListBuilder();a.build(e,this),"day"!==ysy.settings.zoom.zoom?$.proxy(t.issue_week_renderer,this)(e,s,a):$.proxy(t.issue_day_renderer,this)(e,s,a);var r=a.getElement();return r.className+=" project",r}},ysy.pro.ggrm.patch()):ysy.pro.ggrm=null}};