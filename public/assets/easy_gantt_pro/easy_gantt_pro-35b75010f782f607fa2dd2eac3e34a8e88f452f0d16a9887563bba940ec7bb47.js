window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.common=ysy.pro.common||{},EasyGem.extend(ysy.pro.common,{patch:function(){ysy.proManager.register("ganttConfig",this.ganttConfig),gantt.attachEvent("onGanttReady",function(){$(gantt.$grid_data).on("click",".easy-gantt__project_issues",function(){ysy.data.loader.openIssuesOfProject($(this).data("project_id"))})}),ysy.view.columnBuilders=ysy.view.columnBuilders||{},ysy.view.columnBuilders.name=function(e){var t=parseInt(e.real_id);if(isNaN(t)||t>1e12)return e.text;if("project"===e.type){const s=ysy.settings.paths.rootPath+"projects/",a=ysy.main.escapeText(e.text);return"<a class='gantt-grid-row-project' href='"+s+t+"' title='"+a+"' target='_blank'>"+a+"</a>"}},$.extend(ysy.data.loader,{loadProject:function(e){var t=this;return ysy.gateway.polymorficGetJSON(ysy.settings.paths.subprojectGantt.replace(new RegExp("(:|%3A)projectID","g"),e),null,function(s){t._handleProjectData(s,e)},function(){ysy.log.error("Error: Unable to load data")}),!0},_handleProjectData:function(e,t){var s=e.easy_gantt_data;this._loadProjects(s.projects),this._loadIssues(s.issues,t),this._loadRelations(s.relations),this._loadMilestones(s.versions),ysy.log.debug("minor data loaded","load"),this._fireChanges()},loadProjectIssues:function(e){return ysy.gateway.polymorficGetJSON(ysy.settings.paths.projectOpenedIssues.replace(new RegExp("(:|%3A)projectID","g"),e),null,$.proxy(this._handleProjectData,this),function(){ysy.log.error("Error: Unable to load data")}),!0},openIssuesOfProject:function(e){var t=ysy.data.projects.getByID(e);t&&(ysy.data.limits.openings["s"+e]=!0,t.issues_count&&(delete t.issues_count,gantt.open(t.getID()),this.loadProjectIssues(e)))}})},ganttConfig:function(e){$.extend(e,{allowedParent_task:["project","milestone","task","empty"],allowedParent_task_global:["project","milestone","task"]})}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.sorting=EasyGem.extend(ysy.pro.sorting,{name:"Sorter",patch:function(){var e=new ysy.data.Data;e.init({_name:"Sorting",sortBy:null}),ysy.settings.sorting=e,gantt.attachEvent("onGanttReady",$.proxy(this.bindClick,gantt))},columnCompares:{start_date:function(e,t){return(e._start_date||e.start_date)-(t._start_date||t.start_date)},due_date:function(e,t){return(e._end_date||e.end_date)-(t._end_date||t.end_date)},subject:function(e,t){return e.text.localeCompare(t.text)},priority:function(e,t){return e.priority_position-t.priority_position}},defaultCompare:function(e){return function(t,s){return+t.columns[e]&&+s.columns[e]?+t.columns[e]-+s.columns[e]:t.columns[e].toString().localeCompare(s.columns[e].toString())}},getCompareFunction:function(e,t){var s=t?-1:1;if(this.columnCompares[e])var a=this.columnCompares[e];else a=this.defaultCompare(e);return function(e,t){var n=ysy.pro.sorting.columnsValidation(e,t);return n===undefined?(0===(n=a(e,t))&&(n=e.order-t.order),s*n):n}},columnsValidation:function(e,t){return e.columns?t.columns?undefined:1:t.columns?-1:e.type===t.type&&e.subtype===t.subtype?e.text.localeCompare(t.text):e.order-t.order},bindClick:function(){this._click.gantt_grid_head_cell=dhtmlx.bind(function(e,t,s){var a=s.getAttribute("column_id");if(this.callEvent("onGridHeaderClick",[a,e])){if(this._sort&&this._sort.direction&&this._sort.name==a){var n=this._sort.direction;if("desc"===n)return this._sort=null,void this.sort();n="desc"==n?"asc":"desc"}else n="asc";var i=ysy.pro.sorting.getCompareFunction(a,"desc"==n);this._sort={name:a,criteria:i,direction:n},this.sort(i)}},this)}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.silencer=ysy.pro.silencer||{},EasyGem.extend(ysy.pro.silencer,{setting:null,name:"Silencer",patch:function(){ysy.proManager.register("beforeSaveIssue",this.updateSaveData),this.setting=new ysy.data.Data,this.setting.init({name:this.name,turnedOn:!1});var e=$(' <input id="checkbox_silencer" class="gantt-menu-checkbox" type="checkbox" ><label for="checkbox_silencer">'+ysy.settings.labels.silencer.label_disable_notifications+"</label>");$("#button_month_zoom").after(e),ysy.view.AllButtons.prototype.extendees.silencer={widget:ysy.view.CheckBox,bind:function(){this.model=ysy.pro.silencer.setting},func:function(){this.model.turnedOn=this.$target.is(":checked"),this.model._fireChanges(this,"click")},isOn:function(){return this.model.turnedOn}}},updateSaveData:function(e){ysy.pro.silencer.setting.turnedOn&&(e.easy_gantt_suppress_notification=!0)}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.schemes={patch:function(){ysy.proManager.register("extendGanttTask",this.extendGanttTask),ysy.data.schemes=(new ysy.data.Array).init({_name:"IssueSchemeArray"}),ysy.data.projectSchemes=(new ysy.data.Array).init({_name:"ProjectSchemeArray"}),ysy.pro.toolPanel.registerButton({id:"scheme_select",widget:ysy.view.Select,bind:function(){this.model=ysy.settings.scheme},func:function(){var e=this.$target.val();this.model.setSilent("by",e),this.model._fireChanges(this,e+" selected")},modelValue:function(){return this.model.by}}),ysy.data.loader._loadSchemes=function(e){if(ysy.settings.easyRedmine&&(ysy.data.schemes.clear(),ysy.data.projectSchemes.clear(),e)){var t=ysy.data.schemes;e.IssueStatus&&t.push((new ysy.data.Scheme).init(e.IssueStatus,"issue_status")),e.IssuePriority&&t.push((new ysy.data.Scheme).init(e.IssuePriority,"issue_priority")),e.Tracker&&t.push((new ysy.data.Scheme).init(e.Tracker,"tracker")),e.EasyProjectPriority&&ysy.data.projectSchemes.push((new ysy.data.Scheme).init(e.EasyProjectPriority,"project_priority"))}}},extendGanttTask:function(e,t){"project"===t.type&&(t.css+=ysy.pro.schemes.getProjectSchemeOf(e,t)),"task"===t.type&&ysy.data.schemes&&(t.css+=ysy.pro.schemes.getSchemeOf(e,t))},getSchemeOf:function(e){var t=ysy.data.schemes.getByID(ysy.settings.scheme.by);return t?t.getSchemeOf(e):""},getProjectSchemeOf:function(e){if("project_status"===ysy.settings.scheme.by&&e.status_id>1)return" gantt-scheme-project-status-"+e.status_id;var t=ysy.data.projectSchemes.getByID(ysy.settings.scheme.by);return t?t.getSchemeOf(e):""}},ysy.data.Scheme=function(){ysy.data.Data.call(this)},ysy.main.extender(ysy.data.Data,ysy.data.Scheme,{_name:"Scheme",issueMapping:{issue_priority:"priority_id",issue_status:"status_id",tracker:"tracker_id",project_priority:"priority_id"},init:function(e,t){this.id=t;for(var s=0;s<e.length;s++)this[e[s].id]=e[s].scheme;return this},getSchemeOf:function(e){if(this.issueMapping[ysy.settings.scheme.by]){var t=e[this.issueMapping[ysy.settings.scheme.by]];return this[t]?" "+this[t]:""}}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.cashflow=ysy.pro.cashflow||{},EasyGem.extend(ysy.pro.cashflow,{name:"CashFlow",styles:{positive:{textColor:"#484848",fontStyle:"12px Courier"},negative:{textColor:"#ff0000",fontStyle:"12px Courier"}},doNotCloseToolPanel:!0,registeredOnLoader:!1,buttonExtendee:{id:"cashflow",bind:function(){window.EASY&&EASY.getSassData&&(ysy.pro.cashflow.styles={positive:{textColor:EASY.getSassData("resource-color-text","#484848",!1),fontStyle:"12px Courier"},negative:{textColor:EASY.getSassData("resource-color-text-over-allocations","#ff0000",!1),fontStyle:"12px Courier"}}),this.model=ysy.settings.cashflow,this._register(ysy.settings.resource),this.isOn()&&ysy.pro.cashflow.open()},func:function(){this.isOn()?ysy.pro.cashflow.close():ysy.pro.cashflow.open(),ysy.data.storage.savePersistentData("cashflow",ysy.settings.cashflow.active)},isOn:function(){return ysy.main.checkForStorageValue("cashflow",ysy.settings.cashflow.active)},isHidden:function(){return ysy.settings.resource.open}},patch:function(){$("#easy_gantt_menu").find("#button_cashflow").length?(ysy.view.Toolbars.prototype.childTargets.CashFlowPanelWidget="#cashflow_panel",ysy.proManager.register("initToolbar",this.initToolbar),ysy.settings.cashflow=new ysy.data.Data,ysy.settings.cashflow.init({_name:"CashFlow",active:!1,open:!1,activeCashflow:null,realLoaded:!1,plannedLoaded:!1}),ysy.proManager.register("close",this.close),ysy.settings.global?ysy.view.AllButtons.prototype.extendees.cashflow=this.buttonExtendee:ysy.pro.toolPanel.registerButton(this.buttonExtendee),ysy.pro.sumRow.summers.cashflow={day:function(e,t){return t.isProject?t.parent_id?0:t.start_date.isAfter(e)?0:t.end_date.isBefore(e)?0:(t._shift&&(e=moment(e).subtract(t._shift,"days")),ysy.pro.cashflow.cashRenderer(t)[e.format("YYYY-MM-DD")]||0):0},week:function(e,t,s){if(!s.isProject)return 0;if(s.parent_id)return 0;if(s.start_date.isAfter(t))return 0;if(s.end_date.isBefore(e))return 0;var a=0,n=moment(e),i=ysy.pro.cashflow.cashRenderer(s);for(s._shift&&(n.subtract(s._shift,"days"),t=moment(t).subtract(s._shift,"days"));n.isBefore(t);){var r=i[n.format("YYYY-MM-DD")];r&&(a+=r),n.add(1,"day")}return a},formatter:ysy.pro.cashflow.formatter,entities:["projects"],title:"CashFlow"}):ysy.pro.cashflow=null},open:function(){var e=ysy.settings.cashflow;if(e.setSilent("active",!0)){var t=ysy.pro.cashflow;t.showCashflow("real"),ysy.view.bars.registerRenderer("project",this.outerRenderer),ysy.settings.sumRow.setSummer("cashflow"),t.eventId=gantt.attachEvent("onTaskClick",t.showTooltip),ysy.proManager.closeAll(this),this.registeredOnLoader||(this.registeredOnLoader=!0,ysy.data.loader.register(function(){var t=e.activeCashflow;e.active&&(this._resetProjects(),this.showCashflow(t))},this)),ysy.settings.critical.open=!1,ysy.settings.addTask.open=!1,ysy.data.storage.savePersistentData("criticalType",ysy.settings.critical.open),ysy.data.storage.savePersistentData("addTask",ysy.settings.addTask.open),e._fireChanges(this,"toggle")}},close:function(){var e=ysy.settings.cashflow;e.setSilent("active",!1)&&(ysy.view.bars.removeRenderer("project",ysy.pro.cashflow.outerRenderer),ysy.pro.cashflow.setProjectDateBack(),e.setSilent("activeCashflow","nothing"),e.setSilent("open",!1),ysy.settings.sumRow.removeSummer("cashflow"),gantt.detachEvent(ysy.pro.cashflow.eventId),e._fireChanges(this,"toggle"))},setProjectDateBack:function(){let e=ysy.data.projects.array;for(array in e){if(!e.hasOwnProperty(array))continue;let t=e[array];if(!t.cashflow)continue;let s=t.cashflow;s.originStartDate&&t.start_date.isBefore(s.originStartDate)&&t.start_date===s.cashflowStartDate&&t.setSilent("start_date",s.originStartDate),s.originEndDate&&t.end_date.isAfter(s.originEndDate)&&t.end_date===s.cashflowEndDate&&t.setSilent("end_date",s.originEndDate)}},showTooltip:function(e,t){var s=ysy.settings,a=$(t.target);if(!a.hasClass("gantt-task-bar-canvas"))return!0;var n=gantt._pull[e];if(!n)return!0;var i=a.closest(".gantt_bars_area").offset(),r=s.zoom.zoom,o=moment(gantt.dateFromPos2(t.pageX-i.left)).startOf("week"===r?"isoWeek":r),l=ysy.pro.cashflow.tooltipOut(n.widget.model,o,r);if("difference"===s.cashflow.activeCashflow){if(!l.difference)return!0;ysy.view.tooltip.show("gantt-tooltip-cashflow",t,ysy.view.templates.differenceCashflowTooltip,l)}else if("month"===r){if(0===l.weeks.length)return!0;ysy.view.tooltip.show("gantt-tooltip-cashflow",t,ysy.view.templates.monthCashflowTooltip,l)}else{if(0===l.dates.length)return!0;ysy.view.tooltip.show("gantt-tooltip-cashflow",t,ysy.view.templates.CashflowTooltip,l)}return $("#gantt_tooltip").off("click").on("click","h4",function(){$(this).parent().children("div").toggleClass("hidden")}),!1},noHtmlFormatter:function(e,t){return ysy.pro.cashflow.formatter(e,t,!0)},formatter:function(e,t,s){if(0===e)return"0";var a=["","k","M","G","T","P","E","Z","Y"],n=e<0;e=Math.abs(e);var i,r=1;t<50&&(r=.1);for(var o=1,l=0;l<a.length;l++){if(e/o<1e3){if(0===l){i=ysy.pro.cashflow.roundTo(e,10*r);break}i=ysy.pro.cashflow.roundTo(e/o,r)+a[l];break}if(l===a.length-1){i=ysy.pro.cashflow.roundTo(e/o,r)+a[l];break}o*=1e3}return t>35&&n&&(i="-"+i),s?i:n?'<span title="-'+e+'" class="gantt-sum-row-negative">'+i+"</span>":'<span title="'+e+'">'+i+"</span>"},roundTo:function(e,t){return e%1<.05?Math.round(e).toString():e>=100*t?Math.round(e).toString():e.toFixed(1)},outerRenderer:function(e,t){var s=t().call(this,e,t),a=ysy.pro.cashflow._projectRenderer.call(gantt,e);return ysy.view.bars.insertCanvas(a,s),s},cashRenderer:function(e,t){var s=t||ysy.settings.cashflow,a={},n=-1,i="nothing",r=null,o=null,l=0;if("planned"===s.activeCashflow)var d=["_planned_expenses","_planned_revenues"];else d="real"===s.activeCashflow?["_real_expenses","_real_revenues"]:["_planned_expenses","_planned_revenues","_real_expenses","_real_revenues"];if("timeflow"===s.activeCashflow){var c=moment().format("YYYY-MM-DD");for(l=0;l<d.length;l++){for(o in r=e[i=d[l]])r.hasOwnProperty(o)&&(a[o]||(a[o]=0),"_planned_expenses"!==i&&"_planned_revenues"!==i||o>=c&&(a[o]+=r[o]*n),"_real_expenses"!==i&&"_real_revenues"!==i||o<c&&(a[o]+=r[o]*n));n*=-1}}else if("difference"===s.activeCashflow)for(l=0;l<d.length;l++){for(o in r=e[i=d[l]])r.hasOwnProperty(o)&&(a[o]||(a[o]=0),"_real_expenses"!==i&&"_real_revenues"!==i||(a[o]+=r[o]*n),"_planned_expenses"!==i&&"_planned_revenues"!==i||(a[o]-=r[o]*n));n*=-1}else for(l=0;l<d.length;l++){for(o in r=e[i=d[l]])r.hasOwnProperty(o)&&(a[o]||(a[o]=0),a[o]+=r[o]*n);n*=-1}return a},_projectRenderer:function(e){var t=ysy.pro.cashflow,s=e.widget&&e.widget.model,a=ysy.view.bars.canvasListBuilder();a.build(e,this);var n=ysy.pro.cashflow.cashRenderer(s);"day"!==ysy.settings.zoom.zoom?$.proxy(t._projectWeekRenderer,this)(e,n,a,s._shift):$.proxy(t._projectDayRenderer,this)(e,n,a,s._shift);var i=a.getElement();return i.className+=" project",i},_projectDayRenderer:function(e,t,s,a){var n=ysy.pro.cashflow;for(var i in t)if(t.hasOwnProperty(i)&&t[i]){var r=t[i];if(a){var o=moment(i).add(a,"days");if(!s.inRange(o))continue;i=o.format("YYYY-MM-DD")}else if(!s.inRange(i))continue;s.fillFormattedTextAt(i,n.noHtmlFormatter,r,r<0?n.styles.negative:n.styles.positive)}},_projectWeekRenderer:function(e,t,s,a){var n=ysy.pro.cashflow,i=n.weekCashSummer(t,ysy.settings.zoom.zoom,e.start_date,e.end_date,a);for(var r in i)if(i.hasOwnProperty(r)){var o=i[r];s.fillFormattedTextAt(r,n.noHtmlFormatter,o,o<0?n.styles.negative:n.styles.positive)}},weekCashSummer:function(e,t,s,a,n){var i=ysy.view.bars,r=s.valueOf(),o=moment(a).add(1,"days").valueOf(),l={};for(var d in e)if(e.hasOwnProperty(d)){var c=i.getFromDateCache(d),y=e[d];if(n&&(d=(c=moment(c).add(n,"days")).format("YYYY-MM-DD")),!(+c<r)&&!(+c>o)&&y){var f=moment(c).startOf("week"===t?"isoWeek":t).toISOString();l[f]===undefined?l[f]=y:l[f]+=y}}return l},initToolbar:function(e){var t=new ysy.view.CashFlowPanel;t.init(ysy.settings.cashflow),e.children.push(t)},tooltipOut:function(e,t,s,a,n){n=n||moment().format("YYYY-MM-DD");a=a||ysy.settings.cashflow;var i=ysy.pro.cashflow.cashRenderer(e,a),r={},o={};"planned"===a.activeCashflow&&(r=e._planned_expenses,o=e._planned_revenues),"real"===a.activeCashflow&&(r=e._real_expenses,o=e._real_revenues);var l=[],d=[],c=e._shift;c&&t.add(c,"days");for(var y=0,f=0,u=0,h=moment(t).startOf("week"===s?"isoweek":s),g=moment(h).add(1,s);h.isBefore(g);){var p=h.format("YYYY-MM-DD");if(i[p]){var _=0,m=0;"planned"!==a.activeCashflow&&"real"!==a.activeCashflow||(r&&r[p]&&(_+=r[p]),o&&o[p]&&(m+=o[p])),"timeflow"===a.activeCashflow&&(e._planned_expenses[p]&&n<p&&(_+=e._planned_expenses[p]),e._real_expenses[p]&&p<=n&&(_+=e._real_expenses[p]),e._planned_revenues[p]&&n<p&&(m+=e._planned_revenues[p]),e._real_revenues[p]&&p<=n&&(m+=e._real_revenues[p])),"difference"===a.activeCashflow&&(e._planned_expenses[p]&&(u-=e._planned_expenses[p]),e._real_expenses[p]&&(f-=e._real_expenses[p]),e._planned_revenues[p]&&(u+=e._planned_revenues[p]),e._real_revenues[p]&&(f+=e._real_revenues[p]));var v=i[p];if(y+=v,(_||m)&&(l.push({date:h.format("DD MMMM YYYY"),expense:_,revenue:m,fullPrice:v,positiveNegativeClass:v<0?"negative":"positive"}),1===l.length&&(l[0].first=!0)),"difference"===a.activeCashflow){var w=null;"day"===s&&(w=h.format("DD MMMM YYYY")),"week"===s&&(w=h.isoWeek()+" week"),"month"===s&&(w=h.format("MMMM YYYY"))}h.add(1,"day")}else h.add(1,"day")}if("difference"===a.activeCashflow){if(0===f&&0===u)return;return{date:w,realCashflow:f,realPositiveNegativeClass:f<0?"negative":"positive",plannedCashflow:u,plannedPositiveNegativeClass:u<0?"negative":"positive",difference:y,differencePositiveNegativeClass:y<0?"negative":"positive"}}var b={},x={},k={},C={};if("day"===s)return{dates:l};if("week"===s)return{dates:l,total:y};if("month"===s){for(var D=0;D<l.length;D++){var M=l[D],S=moment(M.date,"DD MMMM YYYY").isoWeek();_=M.expense,m=M.revenue,v=M.fullPrice,b[S]||(b[S]=0),_&&(b[S]+=_),x[S]||(x[S]=0),m&&(x[S]+=m),k[S]||(k[S]=0),k[S]+=v,C[S]||(C[S]=[]),C[S].push({date:M.date,expense:_,revenue:m,fullPrice:v,positiveNegativeClass:v<0?"negative":"positive"})}for(S in k)d.push({weekNumber:S,weekExpenses:b[S],weekRevenues:x[S],weekFullPrice:k[S],weekPositiveNegativeClass:k[S]<0?"negative":"positive",dates:C[S]});return{weeks:d,totalPrice:y,totalPositiveNegativeClass:y<0?"negative":"positive"}}}}),ysy.view=ysy.view||{},ysy.view.CashFlowPanel=function(){ysy.view.Widget.call(this)},ysy.main.extender(ysy.view.Widget,ysy.view.CashFlowPanel,{name:"CashFlowPanelWidget",templateName:"CashFlowPanel",_repaintCore:function(){var e=ysy.settings.cashflow,t=this.$target;e.active?t.show():t.hide(),this.toolbar(),this.tideFunctionality()},tideFunctionality:function(){var e=this;this.$target.find("#cashflow_planned").off("click").on("click",function(){ysy.pro.cashflow.showCashflow("planned"),e.toolbar()}),this.$target.find("#cashflow_real").off("click").on("click",function(){ysy.pro.cashflow.showCashflow("real"),e.toolbar()}),this.$target.find("#cashflow_timeflow").off("click").on("click",function(){ysy.pro.cashflow.showCashflow("timeflow"),e.toolbar()}),this.$target.find("#cashflow_difference").off("click").on("click",function(){ysy.pro.cashflow.showCashflow("difference"),e.toolbar()}),this.$target.find("#button_cashflow_help").off("click").on("click",ysy.proManager.showHelp)},toolbar:function(){var e=ysy.settings.cashflow,t=this.$target;"planned"===e.activeCashflow?t.find("#cashflow_planned").addClass("active"):t.find("#cashflow_planned").removeClass("active"),"real"===e.activeCashflow?t.find("#cashflow_real").addClass("active"):t.find("#cashflow_real").removeClass("active"),"timeflow"===e.activeCashflow?t.find("#cashflow_timeflow").addClass("active"):t.find("#cashflow_timeflow").removeClass("active"),"difference"===e.activeCashflow?t.find("#cashflow_difference").addClass("active"):t.find("#cashflow_difference").removeClass("active")}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.cashflow=ysy.pro.cashflow||{},EasyGem.extend(ysy.pro.cashflow,{_resetProjects:function(){for(var e=ysy.settings.cashflow,t=ysy.data.projects.getArray(),s=0;s<t.length;s++)delete t[s]._planned_expenses,delete t[s]._planned_revenues,delete t[s]._real_revenues,delete t[s]._real_revenues;e.setSilent({plannedLoaded:!1,realLoaded:!1,activeCashflow:"nothing"})},showCashflow:function(e){var t=ysy.settings.cashflow,s=!1;if(t.activeCashflow!==e){var a=ysy.data.projects.getArray();t.setSilent("activeCashflow",e),!t.plannedLoaded&&"planned"===t.activeCashflow||!t.realLoaded&&"real"===t.activeCashflow?this._handleCashflow():t.open||(s=!0);for(var n=0;n<a.length;n++){var i=a[n];if(s&&i.cashflow){let e=i.cashflow;e.cashflowStartDate&&i.start_date.isAfter(e.cashflowStartDate)&&i.setSilent("start_date",e.cashflowStartDate),e.originEndDate&&i.end_date.isBefore(e.cashflowEndDate)&&i.setSilent("end_date",e.cashflowEndDate)}i._fireChanges(this,"CashFlow")}t.setSilent("open",!0)}},_handleCashflow:function(){var e=ysy.data.projects.getArray().map(function(e){return e.id});ysy.gateway.polymorficPostJSON(ysy.settings.paths.cashflow,{project_ids:e,include_planned:this._loadDataFor("planned")?1:0,include_real:this._loadDataFor("real")?1:0},$.proxy(this._loadProjects,this),function(){ysy.log.error("Error: Unable to load data")})},_loadDataFor:function(e){var t=null;"planned"===e?t="real":"real"===e&&(t="planned");var s=ysy.settings.cashflow;return!s[e+"Loaded"]&&s.activeCashflow!==t},_loadProjects:function(e){if(e){for(var t=ysy.data.projects,s=ysy.settings.cashflow,a=!1,n=!1,i=Object.getOwnPropertyNames(e),r=0;r<i.length;r++){var o=i[r],l=t.getByID(o),d=e[o],c={startDate:"9999-12-31",endDate:"0000-01-01"};d.planned_expenses&&(l._planned_expenses=d.planned_expenses,this.findLimits(d.planned_expenses,c),a=!0),d.planned_revenues&&(l._planned_revenues=d.planned_revenues,this.findLimits(d.planned_revenues,c),a=!0),d.real_expenses&&(l._real_expenses=d.real_expenses,this.findLimits(d.real_expenses,c),n=!0),d.real_revenues&&(l._real_revenues=d.real_revenues,this.findLimits(d.real_revenues,c),n=!0);var y=moment(c.startDate),f=moment(c.endDate);l.cashflow=l.cashflow||{};var u=l.cashflow;l.start_date.isAfter(y)&&(u.originStartDate||(l.cashflow.originStartDate=l.start_date),u.cashflowStartDate=y,l.setSilent("start_date",y)),l.end_date.isBefore(f)&&(f._isEndDate=!0,u.originEndDate||(l.cashflow.originEndDate=l.end_date),u.cashflowEndDate=f,l.setSilent("end_date",f)),ysy.log.debug("cashflow loaded",s.activeCashflow),l._fireChanges(this,"CashFlow")}a&&s.setSilent("plannedLoaded",!0),n&&s.setSilent("realLoaded",!0)}},findLimits:function(e,t){var s=Object.getOwnPropertyNames(e).sort();t.startDate>s[0]&&(t.startDate=s[0]);var a=s.length-1;t.endDate<s[a]&&(t.endDate=s[a])}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.unfixRelations=ysy.pro.unfixRelations||{},EasyGem.extend(ysy.pro.unfixRelations,{name:"UnfixRelations",buttonExtendee:{id:"unfix_relations",bind(){this.model=ysy.settings.unfixRelations,this._register(ysy.settings.resource),this.isOn()&&ysy.pro.unfixRelations.open()},func(){this.isOn()?ysy.pro.unfixRelations.close():ysy.pro.unfixRelations.open(),ysy.data.storage.savePersistentData("unfixRelations",ysy.settings.unfixRelations.active)},isOn:()=>ysy.main.checkForStorageValue("unfixRelations",ysy.settings.unfixRelations.active)},patch(){$("#easy_gantt_menu").find("#button_unfix_relations").length?(ysy.settings.unfixRelations=new ysy.data.Data,ysy.settings.unfixRelations.init({_name:"UnfixRelations",active:!1}),ysy.pro.toolPanel.registerButton(this.buttonExtendee)):ysy.pro.unfixRelations=null},open(){const e=ysy.settings.unfixRelations;if(e.setSilent("active",!0)){const t=gantt.getLinks();t.length>0&&t.forEach(e=>{this.addUnfix(e)}),e._fireChanges(this,"toggle")}},close(){const e=ysy.settings.unfixRelations;this.removeUnfixRelations(),e.setSilent("active",!1)&&e._fireChanges(this,"toggle")},removeUnfixRelations(){gantt.getLinks().forEach(e=>{this.removeUnfix(e)})},removeUnfix(e){const t=e.widget.model,s=ysy.pro.relations.getMinimizedDelay(t);s>=t._old.delay&&ysy.settings.unfixRelations.active?t.set({delay:t._old.delay,_unlocked:!1,history:!1}):t.set({delay:s,_unlocked:!1})},addUnfix(e){const t=e.widget.model;ysy.settings.unfixRelations.active&&t.set({delay:0,_unlocked:!0,history:!1})}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.baseline={name:"Baseline PRO",initToolbar:function(e){var t=new ysy.view.BaselinePanel;t.init(ysy.data.baselines,ysy.settings.baseline),e.children.push(t)},patch:function(){var e=ysy.pro.baseline;ysy.proManager.register("initToolbar",this.initToolbar),ysy.proManager.register("close",this.close),ysy.proManager.register("ganttConfig",this.ganttConfig),ysy.view.AllButtons.prototype.extendees.baseline={bind:function(){this.model=ysy.settings.baseline,this._register(ysy.settings.resource)},func:function(){ysy.proManager.closeAll(e);var t=ysy.settings.baseline;t.setSilent("open",!t.open),t._fireChanges(this,"toggle")},isOn:function(){return ysy.settings.baseline.open},isHidden:function(){return ysy.settings.resource.open},icon:"projects"},ysy.view.columnBuilders=ysy.view.columnBuilders||{},ysy.view.columnBuilders.baseline_start_date=function(e){var t=ysy.pro.baseline._getBaselineForTask(e);if(t&&t.start_date)return t.start_date.isSame(e.start_date)?"<span>"+ysy.settings.labels.baselines.label_same+"</span>":"<span >"+t.start_date.format(gantt.config.date_format)+"</span>"},ysy.view.columnBuilders.baseline_end_date=function(e){var t=ysy.pro.baseline._getBaselineForTask(e);if(t&&t.end_date)return t.end_date.isSame(e.end_date)?"<span>"+ysy.settings.labels.baselines.label_same+"</span>":"<span >"+t.end_date.format(gantt.config.date_format)+"</span>"},ysy.view.Gantt.prototype.addBaselineLayer=function(){e.addLayer()},ysy.settings.baseline.register(this.settingWatcher,this)},settingWatcher:function(){var e=ysy.settings.baseline;if(e.open&&e.active){var t=e.active;if(!ysy.data.baselines.getByID(t).loaded)return ysy.log.debug("loadBaseline "+t,"baseline"),void ysy.data.baselines.getByID(t).fetch()}if(e.open&&!e.headerLoaded)return ysy.log.debug("loadBaselineHeader","baseline"),ysy.gateway.loadBaselineHeader(function(t){for(var s=ysy.data.baselines,a=s.getArray(),n=0;n<a.length;n++)a[n]._deleted=!0;s.clearCache();var i=t.easy_baselines;for(n=0;n<i.length;n++){var r=i[n],o=s.getByID(r.id);o||(o=new ysy.data.Baseline),o.init(r,ysy.data.baselines),o._deleted=!1,s.pushSilent(o)}if(s._fireChanges(ysy.settings.baseline,"header loaded"),!e.active&&s.getArray().length){var l=s.getArray(),d=l[l.length-1];e.setSilent("active",d.id),ysy.log.debug("last baseline ID="+d.id+" active","baseline"),d.fetch()}}),void(e.headerLoaded=!0);ysy.log.debug("Baseline: gantt.render()","baseline"),ysy.view.initGantt(),ysy.settings.baseline.open?$("#gantt_cont").addClass("gantt-baselines"):$("#gantt_cont").removeClass("gantt-baselines"),gantt.render()},close:function(){var e=ysy.settings.baseline;e.setSilent("open",!1)&&e._fireChanges(this,"close")},resetHeader:function(){ysy.settings.baseline.setSilent("headerLoaded",!1),ysy.settings.baseline.setSilent("active",!1),ysy.settings.baseline._fireChanges(this,"reload after saveBaseline")},_getBaselineForTask:function(e){var t=ysy.data.baselines.getByID(ysy.settings.baseline.active);if(t&&t.loaded){if(ysy.log.debug("baseline drawn","baseline_render"),e.type===gantt.config.types.milestone)var s=t.versions[e.real_id];else gantt._get_safe_type(e.type)===gantt.config.types.task&&(s=t.issues[e.real_id]);return s}},addLayer:function(){if(ysy.settings.baseline.open){var e=gantt.addTaskLayer(function(e){if(ysy.settings.baseline.open&&ysy.settings.baseline.active){var t=ysy.pro.baseline._getBaselineForTask(e);if(t){var s=t.start_date,a=t.end_date;ysy.log.debug("start="+e.start_date.format("DD.MM.YYYY")+" bstart="+t.start_date.format("DD.MM.YYYY"),"baseline_render");var n=gantt.getTaskPosition(e,s,a),i="gantt-baseline";if("milestone"===e.type){var r=n.height;n.width=r,n.left-=r/2+1,i+=" gantt_milestone-type"}else n.width-=2,delete n.height;var o=document.createElement("div");return o.className=i,o.style.left=n.left+"px",n.height&&(o.style.height=n.height+"px"),o.style.width=n.width+"px",o.style.top=n.top+gantt.config.task_height+13+"px",o}}});ysy.log.debug("TaskLayer ID="+e+" created","baseline")}},ganttConfig:function(e){if(ysy.settings.baseline.open){var t=ysy.settings.labels.baselines,s=[{name:"baseline_start_date",title:t.baseline+" "+t.startDate},{name:"baseline_end_date",title:t.baseline+" "+t.dueDate}],a=gantt.config.columns;a=a.concat(ysy.view.leftGrid.constructColumns(s)),$.extend(e,{columns:a,task_height:16,row_height:40})}}},ysy.view.BaselinePanel=function(){ysy.view.Widget.call(this)},ysy.main.extender(ysy.view.Widget,ysy.view.BaselinePanel,{name:"BaselinePanelWidget",templateName:"BaselineOption",_repaintCore:function(){var e=ysy.settings.baseline,t=this.$target;if(e.open){if(t.show(),!this.template){var s=ysy.view.getTemplate(this.templateName);if(!s)return!0;this.template=s}var a=[],n=this.model.getArray();if(0===n.length)t.find("#baseline_select").hide(),t.find("#baseline_delete").hide();else{for(var i=0;i<n.length;i++)a.push({name:n[i].name,id:n[i].id,selected:n[i].id===e.active?" selected":""});var r=Mustache.render(this.template,{baselines:a});t.find("#baseline_select").show().html(r),t.find("#baseline_delete").show()}this.tideFunctionality()}else t.hide()},tideFunctionality:function(){var e=ysy.pro.baseline,t=this;this.$target.find("#baseline_select").off("change").on("change",function(){var e=parseInt($(this).val());ysy.settings.baseline.setSilent("active",e),ysy.settings.baseline._fireChanges(t,"select")}),this.$target.find("#baseline_create:not(.disabled)").off("click").on("click",function(){ysy.log.debug("Create baseline button pressed","baseline"),ysy.history.isEmpty()?e.openCreateModal():dhtmlx.message(ysy.settings.labels.baselines.error_not_saved,"error")}),this.$target.find("#baseline_delete:not(.disabled)").off("click").on("click",function(){ysy.log.debug("Delete baseline button pressed","baseline");var t=ysy.data.baselines.getByID(ysy.settings.baseline.active);if(t){var s=$(this).data("confirmation");window.confirm(s)&&ysy.gateway.deleteBaseline(t.id,function(){ysy.log.debug("deleteBaseline callback","baseline"),e.resetHeader()},function(e){if(403===e.status)s=ysy.settings.labels.baselines.error_missing_delete_permission;else{var t=e.responseJSON;if(t&&t.errors)var s=t.errors.join(", ")}dhtmlx.message(ysy.view.getLabel("baselines","delete_failed")+": "+s,"error")})}}),this.$target.find("#button_baseline_help").off("click").on("click",ysy.proManager.showHelp)}}),ysy.pro.baseline.openCreateModal=function(){var e=moment().format(gantt.config.date_format+" HH:mm")+" "+ysy.settings.project.name,t=ysy.main.getModal("form-modal","50%"),s=function(){var e=t.find("#baseline_modal_name").val();ysy.gateway.saveBaseline(e,function(){ysy.log.debug("saveBaseline callback","baseline"),ysy.pro.baseline.resetHeader(),addLocalizedEasyBaselineNotice()},function(e){var t=e.responseText;try{var s=JSON.parse(t);s.errors.length&&(t=s.errors.join(", "))}catch(a){}dhtmlx.message(ysy.view.getLabel("baselineCreateModal").request_failed+": "+t,"error")}),t.dialog("close")},a=ysy.view.getTemplate("baselineCreateModal"),n=$.extend({},ysy.view.getLabel("baselineCreateModal"),{generic:e}),i=Mustache.render(a,n);t.html(i),showModal("form-modal","auto"),t.dialog({position:{my:"center",at:"center",of:window},buttons:[{id:"baseline_modal_submit",text:ysy.settings.labels.buttons.button_submit,"class":"button-1 button-positive",click:s},{id:"baseline_modal_cancel",text:ysy.settings.labels.buttons.button_cancel,"class":"button-2",click:function(){t.dialog("close")}}]})},ysy.data.Baseline=function(){ysy.data.Data.call(this)},ysy.main.extender(ysy.data.Data,ysy.data.Baseline,{_name:"Baseline",fetch:function(){var e=this;ysy.log.debug("baseline "+this.id+" fetch","baseline"),this.loaded?ysy.settings.baseline._fireChanges(this,"baseline active and loaded"):(this.isLoading||ysy.gateway.loadBaselineData(this.id,function(t){e.construct(t.easy_baseline_gantt),e.loaded=!0,e.isLoading=!1,e.fetch()}),this.isLoading=!0)},construct:function(e){this.issues={};for(var t=0;t<e.issues.length;t++){var s=e.issues[t],a={start_date:s.start_date?moment(s.start_date,"YYYY-MM-DD"):moment().startOf("day"),end_date:s.due_date?moment(s.due_date,"YYYY-MM-DD"):moment().startOf("day"),done_ratio:s.done_ratio,id:s.connected_to_issue_id};a.start_date.isAfter(a.end_date)&&(s.start_date?a.end_date=moment(a.start_date):a.start_date=moment(a.end_date)),a.end_date._isEndDate=!0,this.issues[a.id]=a}for(this.versions={},t=0;t<e.versions.length;t++)s=e.versions[t],(a={start_date:moment(s.start_date,"YYYY-MM_DD"),id:s.connected_to_version_id}).start_date._isEndDate=!0,this.versions[a.id]=a}}),ysy.gateway===undefined&&(ysy.gateway={}),EasyGem.extend(ysy.gateway,{loadBaselineHeader:function(e){var t=ysy.settings.paths.baselineRoot;this.polymorficGetJSON(t,null,e)},loadBaselineData:function(e,t){var s=ysy.settings.paths.baselineGET.replace(":baselineID",e);this.polymorficGetJSON(s,null,t)},saveBaseline:function(e,t,s){ysy.log.debug("Create baseline request","baseline");var a=null;e&&(a={easy_baseline:{name:e}});var n=ysy.settings.paths.baselineRoot;this.polymorficPost(n,null,a,t,s)},deleteBaseline:function(e,t,s){ysy.log.debug("Delete baseline ID="+e+" request","baseline");var a=ysy.settings.paths.baselineDELETE.replace(":baselineID",e);this.polymorficDelete(a,null,t,s)}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.addTask={_name:"AddTask",initToolbar:function(e){var t=new ysy.view.AddTaskPanel;t.init(ysy.settings.addTask),e.children.push(t)},patch:function(){ysy.proManager.register("initToolbar",this.initToolbar),ysy.proManager.register("close",this.close);var e=ysy.proManager,t=ysy.pro.addTask;ysy.view.AllButtons.prototype.extendees.add_task={bind:function(){if(this.model=ysy.settings.addTask,this._register(ysy.settings.resource),this.isOn()){e.closeAll(t);var s=ysy.settings.addTask;s.setSilent("open",!s.open),s._fireChanges(this,"toggle")}},func:function(){e.closeAll(t);var s=ysy.settings.addTask;s.setSilent("open",!s.open),ysy.settings.critical.open=!1,
ysy.settings.cashflow&&(ysy.settings.cashflow.active=!1,ysy.data.storage.savePersistentData("cashflow",ysy.settings.cashflow.active)),ysy.data.storage.savePersistentData("criticalType",ysy.settings.critical.open),ysy.data.storage.savePersistentData("addTask",s.open),s._fireChanges(this,"toggle")},isOn:function(){return ysy.main.checkForStorageValue("addTask",ysy.settings.addTask.open)},isHidden:function(){return ysy.settings.resource.open}},ysy.proManager.register("onDragStart",function(e,t){return e.addTask=ysy.settings.addTask.open,!!e.addTask&&(e.addType=ysy.settings.addTask.type,e.startDate=gantt.dateFromPos(t.getRelativePos().x),e.lastScroll=gantt.getCachedScroll(),!0)}),ysy.proManager.register("onDragMove",function(e,s){return!!e.addTask&&(e.endDate=gantt.dateFromPos(s.getRelativePos().x),"milestone"===e.addType?e.line=t.modifyMileMarker(s.config.marker,{start_date:moment(e.endDate)},s.config.offset,e.lastScroll):e.line=t.modifyIssueMarker(s.config.marker,{start_date:moment(e.startDate),end_date:moment(e.endDate),type:e.addType},s.config.offset,e.lastScroll),!0)}),ysy.proManager.register("onDragEnd",function(e,s){if(!e.addTask)return!1;if(s.config.started){ysy.log.debug("start: "+e.startDate.toString()+" end: "+e.endDate.toString(),"taskModal");var a={start_date:moment(e.startDate),end_date:moment(e.endDate)};t.roundDates(a,"milestone"!==e.addType);var n={start_date:a.start_date.format("YYYY-MM-DD"),due_date:a.end_date.format("YYYY-MM-DD"),project_id:ysy.settings.projectID};ysy.log.debug("line="+e.line,"taskModal");var i=t.getParentByLine(e.line,e.addType);n.parent={id:i.real_id,type:i.type,project_id:i.widget.model.project_id,fixed_version_id:i.widget.model.fixed_version_id},t.openModal(e.addType,n)}return!0})},close:function(){var e=ysy.settings.addTask;e.setSilent("open",!1)&&e._fireChanges(this,"close")}},ysy.view.AddTaskPanel=function(){ysy.view.Widget.call(this)},ysy.main.extender(ysy.view.Widget,ysy.view.AddTaskPanel,{name:"AddTaskPanelWidget",templateName:"AddTaskPanel",buttons:["issue","milestone"],_repaintCore:function(){var e=ysy.settings.addTask,t=this.$target;e.open?(t.show(),t.find(".add_task_type").removeClass("active"),t.find("#add_task_"+e.type).addClass("active"),this.tideFunctionality()):t.hide()},tideFunctionality:function(){for(var e=this.buttons,t=this.$target,s=this.model,a=this,n=function(e){t.find("#add_task_"+e).off("click").on("click",function(){s.type===e?ysy.pro.addTask.openModal(e):(s.setSilent("type",e),s._fireChanges(a,"toggle"))})},i=0;i<e.length;i++)n(e[i])}}),EasyGem.extend(ysy.pro.addTask,{openModal:function(e,t){if(t===undefined&&(t={project_id:ysy.settings.projectID}),"milestone"===e&&(t.due_date=moment(t.due_date).add(1,"days").format("YYYY-MM-DD")),t.parent){var s=t.parent;if(s.id>1e12)return void dhtmlx.message(ysy.settings.labels.errors2.unsaved_parent,"error");t.project_id=s.project_id,t.fixed_version_id="milestone"===s.type?s.id:s.fixed_version_id,"task"===s.type&&(t.parent_issue_id=s.id),delete t.parent}var a=ysy.main.getModal("form-modal","90%"),n=function(){var t=ysy.pro.addTask;if(window.fillFormTextAreaFromCKEditor&&(window.fillFormTextAreaFromCKEditor("issue_description"),window.fillFormTextAreaFromCKEditor("version_description")),$(this).is("form"))var s=$(this).serializeArray();else s=a.find("form").serializeArray();var n=t.collectErrors(a,s);if(n.length)return dhtmlx.message(n.join("<br>"),"error"),$("#content").find(".flash").appendTo("body"),!1;var i=t.transformData(s,e);return"milestone"===e?t.createMilestone(i):t.createIssue(i),a.dialog("close"),!1};"milestone"===e?ysy.gateway.polymorficGet(ysy.settings.paths.newMilestonePath.replace(":projectID",t.project_id),{version:t},function(e){var t=$(e).find("#content");t.length?a.html(t.html()):a.html(e);var s=a.find("#version_project_id").val(),i=a.find("h2");if(i.replaceWith($("<h3 class='title'></h3>").html(i.html())),showModal("form-modal"),a.find("input[type=submit], .form-actions").hide(),a.find("#new_version").submit(n),a.dialog({buttons:[{id:"add_milestone_modal_submit","class":"button-1 button-positive",text:ysy.settings.labels.buttons.create,click:n}]}),a.find("#version_name").focus(),ysy.settings.easyRedmine){window.initEasyAutocomplete();var r=a.find("#version_project_id_autocomplete");r.val(r.attr("value")),a.find("#version_project_id").val(s)}}):ysy.gateway.polymorficGet(ysy.settings.paths.newIssuePath,{issue:t},function(e){a.html(e);var s=a.find("h2");s.replaceWith($("<h3 class='title'></h3>").html(s.html())),showModal("form-modal"),a.find("input[type=submit], .form-actions").hide(),a.dialog({buttons:[{id:"add_issue_modal_submit","class":"button-1 button-positive",text:ysy.settings.labels.buttons.create,click:n}]});const i=$("#form-modal #issue-form");i.length&&i.on("new-issue-attribute-reloaded",ysy.pro.addTask.setRequiredFields.bind(null,a)),ysy.pro.addTask.setRequiredFields(a),a.find("#issue-form").submit(n),0===a.find("#project_id").length&&a.find("#issue-form").append($('<input id="project_id" type="hidden" name="issue[project_id]" value="'+t.project_id+'" />')),window.initEasyAutocomplete(),a.find("#issue_subject").focus()})},setRequiredFields:function(e){const t=e[0],s=document.createElement("span");s.classList.add("required"),s.innerHTML=" *";const a=t.querySelector("#start_date_area > label");a&&(a.classList.add("required"),a.appendChild(s),a.required=!0);const n=t.querySelector("#due_date_area > label");n&&(n.classList.add("required"),n.appendChild(s),n.required=!0)},collectErrors:function(e,t){var s=[],a={};for(var n in ysy.settings.easyRedmine&&(e.find("label.required").each(function(){var e=$(this),t=e.next(),s=t.filter("[name]");0===s.length&&(s=t.find("[name]"));var n=e.text();"*"===n.charAt(n.length-1)&&(n=n.substring(0,n.length-2)),a[s.attr("name")]=n}),e.find("input[required],textarea[required],select[required]").each(function(){var e=$(this);a[e.attr("name")]=e.attr("placeholder")})),e.find("label > span.required").each(function(){var e=$(this).parent("label"),t=e.parent().find("#"+e.attr("for")),s=e.text(),n=t.attr("name");n&&(a[n]=s.substring(0,s.length-2))}),a)if(a.hasOwnProperty(n)){for(var i=!1,r=0;r<t.length;r++)if(t[r].name===n){""!==t[r].value&&(i=!0);break}i||s.push(a[n]+" "+ysy.view.getLabel("addTask","error_blank"))}return s},transformData:function(e,t){var s=ysy.main.formToJson(e);if("issue"==t)var a=s.issue;else a="milestone"==t?s.version:{};for(var n={project_id:ysy.settings.project?ysy.settings.project.id:null},i=function(e){return""===e?null:parseInt(e)},r={is_private:i,tracker_id:i,status_id:i,priority_id:i,project_id:i,assigned_to_id:i,fixed_version_id:i,easy_version_category_id:i,old_fixed_version_id:i,parent_issue_id:i,effective_date:function(e){return n.start_date=e,null},estimated_hours:function(e){return""===e?null:parseFloat(e)},done_ratio:i,activity_id:i},o=Object.getOwnPropertyNames(a),l=0;l<o.length;l++){var d=o[l];if(r.hasOwnProperty(d))var c=r[d](a[d],d);else c=a[d];n[d]=c}return n},roundDates:function(e,t){if(e.end_date){if(t&&e.end_date<e.start_date){e.end_date.add(12,"hours");var s=e.end_date;e.end_date=e.start_date,e.start_date=s}else e.end_date.add(-12,"hours");e.end_date._isEndDate=!0,gantt.date.date_part(e.end_date)}gantt.date.date_part(e.start_date)},createIssue:function(e){ysy.log.debug("creating issue "+JSON.stringify(e),"taskModal"),$.extend(e,{id:dhtmlx.uid(),name:e.subject,columns:{subject:e.subject},permissions:{editable:!0},css:"fresh"});var t=new ysy.data.Issue;t.init(e),ysy.data.issues.push(t),gantt._selected_task=t.getID()},createMilestone:function(e){ysy.log.debug("creating milestone "+JSON.stringify(e),"taskModal"),$.extend(e,{id:dhtmlx.uid(),permissions:{editable:!0},css:"fresh"});var t=new ysy.data.Milestone;t.init(e),ysy.data.milestones.push(t),gantt._selected_task=t.getID()},modifyIssueMarker:function(e,t,s,a){this.roundDates(t,!0);var n=gantt.posFromDate(t.start_date),i=gantt.config,r=gantt._get_task_height(),o=i.row_height,l=Math.floor((o-r)/2),d=parseFloat(e.style.top)-s.top;d=Math.max(d,a.y);var c=Math.floor(d/o),y=Math.min(Math.max(c,0),gantt._order.length-1)*o+l,f=gantt.posFromDate(t.end_date)-n;e.className="gantt_task_line planned gantt_"+t.type+"-type",e.innerHTML='<div class="gantt_task_content"></div>';var u=["left:"+(n+s.left)+"px","top:"+(y+s.top)+"px","height:"+r+"px","width:"+f+"px"];return e.style.cssText=u.join(";"),c},modifyMileMarker:function(e,t,s,a){gantt._working_time_helper.round_date(t.start_date);var n=gantt.posFromDate(t.start_date),i=gantt.config.row_height,r=gantt._get_task_height(),o=Math.floor((i-r)/2),l=parseFloat(e.style.top)-s.top;l=Math.max(l,a.y);var d=Math.floor(l/i),c=Math.min(Math.max(d,0),gantt._order.length-1)*i+o;e.className="gantt_task_line planned gantt_milestone-type",e.innerHTML='<div class="gantt_task_content"></div>';var y=["left:"+(n+s.left-Math.floor(r/2)-1)+"px","top:"+(c+s.top)+"px","height:"+r+"px","line-height:"+r+"px","width:"+r+"px"];return e.style.cssText=y.join(";"),d},allowedParent:{issue:["task","milestone","project"],milestone:["project"],reservation:["assignee","project"]},getParentByLine:function(e,t){var s=this.allowedParent[t],a=gantt._order;if(e<0||e>=a.length)return ysy.log.debug("wrong line number","taskModal"),null;var n=a[e],i=gantt.getTask(n);if(!i)return ysy.log.debug("task not found","taskModal"),null;for(var r=0;r<s.length;r++)if(gantt._get_safe_type(i.type)===s[r])return i;return this.getParentByLine(e-1,t)}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.emptyGantt={name:"emptyGantt",patch:function(){ysy.data.loader.register(this.newGantt,this)},newGantt:function(){if(this.isEmpty()&&!ysy.settings.resource_on){var e=ysy.settings.addTask;e.setSilent("open",!0),e._fireChanges(this,"toggle")}},isEmpty:function(){var e=ysy.data;return!(e.projects.array.length>1)&&(!(e.issues.array.length>0)&&!(e.milestones.array.length>0))}},window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.critical={name:"CriticalPath",patch:function(){"disabled"!==ysy.settings.criticalType?(ysy.proManager.register("extendGanttTask",this.extendGanttTask),ysy.proManager.register("close",this.close),ysy.proManager.register("initToolbar",this.initToolbar),$.extend(ysy.view.AllButtons.prototype.extendees,{critical:{bind:function(){this.model=ysy.settings.critical,this._register(ysy.settings.resource),this.isOn()&&(ysy.proManager.closeAll(ysy.pro.critical),this.model.setSilent("open",!this.model.open),ysy.pro.critical.toggle(this.model.open))},func:function(){ysy.proManager.closeAll(ysy.pro.critical);var e=ysy.settings.critical;e.setSilent("open",!e.open),ysy.pro.critical.toggle(e.open),ysy.settings.addTask.open=!1,ysy.settings.cashflow&&(ysy.settings.cashflow.active=!1,ysy.data.storage.savePersistentData("cashflow",ysy.settings.cashflow.active)),ysy.data.storage.savePersistentData("addTask",ysy.settings.addTask.open),ysy.data.storage.savePersistentData("criticalType",e.open)},isOn:function(){return ysy.main.checkForStorageValue("criticalType",ysy.settings.critical.open)},isHidden:function(){return ysy.settings.resource.open}},show_only_critical:{bind:function(){this.model=ysy.settings.critical},func:function(){this.model.show_only_critical=!this.model.show_only_critical,ysy.pro.critical.updateRegistration(this.model.show_only_critical),this.model._fireChanges(this,"click")},isOn:function(){return this.model.show_only_critical}}})):ysy.pro.critical=null},byLongestPath:{critie_arr:null,crities:null,_construct:function(){for(var e=ysy.data.issues.getArray(),t=ysy.data.relations.getArray(),s={},a=[],n=0;n<e.length;n++){var i=e[n],r={issue:i,duration:i.getDuration("days"),source:[],target:[],longest:null};s[i.id]=r,a.push(r)}for(n=0;n<t.length;n++){var o=t[n];if(!o.isSimple){var l=s[o.source_id],d=s[o.target_id];l&&d?(l.source.push(o),d.target.push(o)):(l||ysy.log.debug("source_critie "+o.source_id+" missing","critical"),d||ysy.log.debug("target_critie "+o.target_id+" missing","critical"))}}for(this.crities=s,this.critie_arr=a,n=0;n<a.length;n++)r=a[n],this._resolve(r);return this.crities},_resolve:function(e){if(null===e.longest){for(var t=0,s=0;s<e.target.length;s++){var a=e.target[s],n=this.crities[a.source_id];if(n){this._resolve(n);var i=n.longest+a.delay-("start_to_finish"===a.type||"finish_to_finish"===a.type?e.duration:0)-("start_to_start"===a.type||"start_to_finish"===a.type?n.duration:0);i>t&&(e.prevMain=n,t=i)}else ysy.log.warning("nextCritie missing")}e.longest=t+e.duration}},findPath:function(){this.critie_arr||this._construct();for(var e=null,t=0,s=0;s<this.critie_arr.length;s++){var a=this.critie_arr[s];t<a.longest&&(t=a.longest,e=a)}var n={},i=null;if(e){for(;e.prevMain;)n[i=e.issue.id]=!0,e=e.prevMain;n[i=e.issue.id]=!0,n.last=i}return this.reset(),ysy.log.debug("findPath() path="+JSON.stringify(n),"critical"),n},reset:function(){this.critie_arr=null,this.crities=null,this.path=null}},byLastIssue:{findPath:function(){for(var e=ysy.data.issues.getArray(),t=[],s=null,a=0;a<e.length;a++){var n=e[a];if(n._end_date.isValid()){if(null!==s){if(s.isAfter(n._end_date))continue;s.isBefore(n._end_date)&&(t=[])}s=n._end_date,t.push(n)}}if(0===t.length)return{};var i={},r=t[0];for(a=0;a<t.length;a++){i[(n=t[a]).id]=n,r._start_date.isAfter(n._start_date)&&(r=n);var o=this._resolve(n,i);null!==o&&o._start_date.isBefore(r._start_date)&&(r=o)}return i.last=r.id,i},_resolve:function(e,t){for(var s=ysy.data.relations.getArray(),a=null,n=0;n<s.length;n++){var i=s[n];if(!i.isSimple&&i.getTarget()===e){var r=i.getActDelay()-i.delay,o=i.getSource();if(o!==undefined&&!(r>0)){t[o.id]=o,(null===a||o._start_date.isBefore(a._start_date))&&(a=o);var l=this._resolve(o,t);null===l||null!==a&&!l._start_date.isBefore(a._start_date)||(a=l)}}}return a}},findPath:function(){return"last"===ysy.settings.criticalType?this.byLastIssue.findPath():"longest"===ysy.settings.criticalType?this.byLongestPath.findPath():{}},getPath:function(){var e,t=ysy.settings.critical;if(!1===t.open)return null;if(!1===t.active)return null;if(t._cache)return t._cache;if(e=ysy.pro.critical.findPath(),t._cache=e,t._prevCache){for(var s in t._prevCache)t._prevCache.hasOwnProperty(s)&&(e[s]||gantt.refreshTask(s));for(s in e)e.hasOwnProperty(s)&&(t._prevCache[s]||gantt.refreshTask(s))}return t._prevCache=e,window.setTimeout(function(){t._cache=null},0),e},updateRegistration:function(e){e?ysy.proManager.register("filterTask",this.filterTask):ysy.proManager.unregister("filterTask",this.filterTask)},filterTask:function(e,t){if("task"===t.type){var s=ysy.pro.critical.getPath();return!(!s||!s[t.real_id])}return!0},toggle:function(e){var t=ysy.settings.critical;if(t.setSilent("active",e===undefined?!t.active:e),t.active){var s=ysy.pro.critical.getPath().last;gantt.isTaskExists(s)?gantt.selectTask(s):gantt._selected_task=s}t._fireChanges(this,"toggle")},close:function(){var e=ysy.settings.critical;e.setSilent("open",!1)&&(ysy.pro.critical.updateRegistration(!1),e._fireChanges(this,"close"))},initToolbar:function(e){var t=new ysy.view.CriticalPanel;t.init(ysy.settings.critical),e.children.push(t)},extendGanttTask:function(e,t){var s=ysy.pro.critical.getPath();s&&s[e.id]&&(t.css+=" critical")}},ysy.view=ysy.view||{},ysy.view.CriticalPanel=function(){ysy.view.Widget.call(this)},ysy.main.extender(ysy.view.Widget,ysy.view.CriticalPanel,{name:"CriticalPanelWidget",templateName:"CriticalPanel",_repaintCore:function(){var e=ysy.settings.critical,t=this.$target;e.open?t.show():t.hide(),e.active?t.find("#critical_show").addClass("active"):t.find("#critical_show").removeClass("active"),this.tideFunctionality()},tideFunctionality:function(){this.$target.find("#critical_show").off("click").on("click",function(){ysy.log.debug("Show Critical path button pressed","critical"),ysy.pro.critical.toggle()}),this.$target.find("#button_critical_help").off("click").on("click",ysy.proManager.showHelp)}}),window.ysy=window.ysy||{},ysy.pro=ysy.pro||{},ysy.pro.grid_context=ysy.pro.grid_context||{},EasyGem.extend(ysy.pro.grid_context,{_name:"Grid context",patch:function(){var e=new ysy.data.Data;ysy.settings.grid_context=e,this.setting=e,e.init({_name:"Grid_context",bulk:!1}),ysy.pro.toolPanel.registerButton({id:"bulk_edit",bind:function(){this.model=e},func:function(){this.isOn()?this.close():this.open()},isOn:function(){return this.model.bulk},open:function(){this.model.setSilent("bulk",!0)&&(this.model._fireChanges(this,"toggle"),$(".gantt-grid-form").addClass("bulk-edit-mode"))},close:function(){this.model.setSilent("bulk",!1)&&(this.model._fireChanges(this,"toggle"),$(".gantt-grid-form").removeClass("bulk-edit-mode"))},isRemoved:function(){}}),ysy.proManager.register("ganttConfig",this.ganttConfig),gantt.attachEvent("onGanttReady",$.proxy(this.initForm,this)),gantt.attachEvent("onTaskClick",function(e,t){if(t.target.className.indexOf("gantt-grid-checkbox-cont")>-1||t.target.parentElement.className.indexOf("gantt-grid-checkbox-cont")>-1){var s=$(t.target).find("input");return s.prop("checked",!s.prop("checked")),!1}return"INPUT"!==t.target.nodeName}),gantt.attachEvent("onContextMenu",function(e,t,s){if(!e)return!0;if(t)return!0;var a=$(s.target).closest(".gantt_row.task-type");if(0===a.length)return!0;var n=ysy.pro.grid_context;ysy.settings.grid_context.bulk||n.unselectAll(),a.find(".gantt-grid-checkbox").prop("checked",!0),n.contextMenuCreate(),$(document).on("click.grid_context_menu",n.contextHide),n.contextMenuShow(s)})},initForm:function(){this.$grid_data=$(".gantt_grid_data"),this.$grid_data.wrap($("<form class='gantt-grid-form context-menu-container'></form>"))},checkboxBuilder:function(e){return"project"===e.$rendered_type?"":'<div class="gantt-grid-checkbox-cont"><input class="gantt-grid-checkbox" type="checkbox" name="ids[]" value="'+e.id+'"></div>'},ganttConfig:function(e){if(e.columns&&"subject"===e.columns[0].name){var t=e.columns[0].template,s=ysy.pro.grid_context.checkboxBuilder;e.columns[0].template=function(e){return t(e)+s(e)}}},contextMenuCreate:function(){if($("#context-menu").length<1){var e=document.createElement("div");e.setAttribute("id","context-menu"),e.setAttribute("style","display:none;"),document.body.appendChild(e)}},contextMenuShow:function(e){var t,s,a,n,i,r,o=e.pageX,l=e.pageY,d=o,c=l,y=this,f=$("#context-menu").css("left",d+"px").css("top",c+"px").html(""),u=$(e.target).closest("form").first().find(".gantt-grid-checkbox"),h=[];if(u.each(function(){this.checked&&h.push(parseInt(this.value))}),0!==h.length){var g=this.prepareUrls(h),p=function(e,u,g){if(u.length>0)return y.displayErrors(u);var p=y.prepareContextOut(e,g);if(0!==p.length){var _=ysy.view.templates.gridContext,m=Mustache.render(_,{menu:p});f.html(m),t=f.width(),s=f.height(),i=o+2*t,r=l+s-$(window).scrollTop();var v=y.window_size();a=v.width,n=v.height,i>a?(d-=t,f.addClass("reverse-x")):f.removeClass("reverse-x"),r>n?(c-=s,f.addClass("reverse-y")):f.removeClass("reverse-y"),d<=0&&(d=1),c<=0&&(c=1),f.css("left",d+"px").css("top",c+"px").show(),ysy.pro.grid_context.setting.ids=h,y.bindEvents(f,p)}else window.showFlashMessage("warning",ysy.settings.labels.warnings.no_permission_edit)};this.orderDataAndWait(g,p,h)}},prepareUrls:function(e){for(var t,s=[],a=[],n=0;n<e.length;n++)if(e[n]>1e9){var i=gantt._pull[e[n]];if(!i)continue;var r=i.widget&&i.widget.model.project_id;if(!r)continue;-1===a.indexOf(r)&&(a.push(r),t=ysy.settings.paths.projectFormFields.replace("__projectId",r),s.push(t))}else t=ysy.settings.paths.issueFormFields.replace("__issueId",e[n]),s.push(t);return s},displayErrors:function(e){if(e.length>0){if(1===e.length)return void showFlashMessage("error",e[0]);for(var t=$("<ul>"),s=0;s<e.length;s++)t.append($("<li>").text(e[s]));showFlashMessage("error",t.html())}},prepareContextOut:function(e,t){var s=[],a=[];for(r=0;r<t.length;r++){var n=ysy.data.issues.getByID(t[r]);a.push(n)}for(var i=Object.getOwnPropertyNames(this.propertyProcessors),r=0;r<i.length;r++){var o=i[r];if(!this.skipContextMenuItem(o,t)){var l=this.propertyProcessors[o],d=e[o];if(d&&0!==d.order.length){var c={hasMenu:!0,name:ysy.settings.labels.properties[o],property:o,folder:[],icon:l.icon?"icon "+l.icon:"",search:!!l.search},y=this.allIssuesValue(a,o,l);l.nullAllowed&&(h={name:" ---\u200b ",value:null},c.folder.push(h),h.isChecked=y.isSame&&!y.value,h.isDisabled=h.isChecked);for(var f=0;f<d.order.length;f++){var u=d.order[f];if(d.inner[u]){var h=d.inner[u];h.isChecked=y.isSame&&h.value===y.value,h.isDisabled=h.isChecked}else{if(!d.outer[u])continue;(h=d.outer[u]).isDisabled=!0}c.folder.push(h)}s.push(c)}}}return s},allIssuesValue:function(e,t,s){if(null==e||0===e.length)return{isSame:!1,value:null};var a=e[0][s.key||t+"_id"];if(a===undefined&&(a=null),1===e.length)return{isSame:!0,value:a};for(var n=1;n<e.length;n++){var i=e[n][s.key||t+"_id"];if(i===undefined&&(i=null),a!==i)return{isSame:!1,value:null}}return{isSame:!0,value:a}},orderDataAndWait:function(e,t,s){for(var a=0,n={},i=[],r=this,o=0;o<e.length;o++)$.ajax({url:e[o],success:function(e){r.combineAvailable(n,e)},error:function(e){if(e.responseJSON&&e.responseJSON.errors)for(var t=e.responseJSON.errors,s=0;s<t.length;s++)i.push(t[s])},complete:function(){++a===e.length&&t(n,i,s)}})},combineAvailable:function(e,t){var s=Object.getOwnPropertyNames(this.propertyProcessors),a=t.form_attributes.issue;const n=gantt.getTask(a.id);if(n&&n.readonly)return{};for(var i=0;i<s.length;i++){var r=s[i];if(a.hasOwnProperty(r)&&0!==a[r].length){var o=this.propertyProcessors[r],l=t.form_attributes[o.form||"available_"+r+"s"];if(o.optionBuilder&&(l=o.optionBuilder(l)),l&&0!==l.length){var d=e[r];if(d){var c=[];for(u=0;u<l.length;u++)h=l[u].name,d.inner[h]||d.outer[h]||(d.outer[h]=l[u]),c.push(h);var y=Object.getOwnPropertyNames(d.inner);for(u=0;u<y.length;u++){h=y[u];var f=c.indexOf(h);-1!==f&&l[f].value===d.inner[h].value||(d.outer[h]=d.inner[h],delete d.inner[h])}d.order=this.mergeOrder(d.order,c)}else{e[r]=d={},d.inner={},d.outer={},d.order=[];for(var u=0;u<l.length;u++){var h=l[u].name;d.inner[h]=l[u],d.order.push(h)}}}}}return e},mergeOrder:function(e,t){for(var s=[];e.length>0;){var a=e.shift(),n=t.indexOf(a);if(n>-1){var i=t.splice(0,n+1);s=s.concat(i)}else s.push(a)}return s=s.concat(t)},propertyProcessors:{status:{icon:"icon-issue-status",form:"available_statuses"},priority:{form:"available_priorities",icon:"icon-list"},done_ratio:{key:"done_ratio",optionBuilder:function(){return[{value:0,name:"0 %"},{value:10,name:"10 %"},{value:20,name:"20 %"},{value:30,name:"30 %"},{value:40,name:"40 %"},{value:50,name:"50 %"},{value:60,name:"60 %"},{value:70,name:"70 %"},{value:80,name:"80 %"},{value:90,name:"90 %"},{value:100,name:"100 %"}]}},assigned_to:{nullAllowed:!0,icon:"icon-user",search:!0,form:"available_assignees",optionBuilder:function(e){if(e){for(var t=[],s=0;s<e.length;s++)e[s]&&(t=t.concat(e[s].values));return t}}},category:{form:"available_categories"},fixed_version:{nullAllowed:!0,form:"available_fixed_versions",icon:"icon-stack"},activity:{form:"available_activities"}},bindEvents:function(e,t){e.find(".gantt-context-leaf:not(.disabled)").on("click",this.changeObjectOnClick),this.initAutocomplete(e,t,"assigned_to")},initAutocomplete:function(e,t,s){var a=t.filter(function(e){return e.property===s});if(0!==a.length){var n=a[0].folder,i=[];for(var r in n)if(n.hasOwnProperty(r)){var o=n[r];i.push({name:o.name,key:s,value:o.value})}var l=e.find("#easy_gantt_search_"+s);l.ganttcomplete({minLength:0,select:function(e,t){ysy.pro.grid_context.changeObjectOnClick(t.item)},source:function(e,t){var s=new RegExp($.ui.autocomplete.escapeRegex(e.term),"i");t($.map(i,function(t){if(!e.term||s.test(t.name))return t}))}}),l.on("click",function(){l.ganttcomplete("search","")})}},changeObjectOnClick:function(e){var t=$(this),s=ysy.pro.grid_context.setting.ids,a=t.closest("ul").data("property")||e.key,n=null==t.data("value")?e.value:t.data("value"),i=ysy.pro.grid_context.propertyProcessors[a].key||a+"_id",r=ysy.data.issues;ysy.history.openBrack();for(var o=0;o<s.length;o++){var l=r.getByID(s[o]);if(l){var d={};d[i]=n,l.columns&&(d.columns=$.extend({},l.columns),d.columns[a]=""!=t.text().length?t.text():e.name),l.set(d)}}ysy.history.closeBrack(),ysy.pro.grid_context.contextHide()},contextHide:function(e){if(e&&$(e.target).closest("#context-menu").length>0)return;$("#context-menu").hide(),$(document).off("click.grid_context_menu"),ysy.pro.grid_context.unselectAll()},unselectAll:function(){$(".gantt-grid-checkbox").prop("checked",!1)},window_size:function(){var e,t;return window.innerWidth?(e=window.innerWidth,t=window.innerHeight):document.documentElement?(e=document.documentElement.clientWidth,t=document.documentElement.clientHeight):(e=document.body.clientWidth,t=document.body.clientHeight),{width:e,height:t}},skipContextMenuItem:function(e,t){if("done_ratio"===e)return this.skipDoneRatio(t)},skipDoneRatio:function(e){const t=ysy.settings.appSettings;return t.useStatusForIssueDoneRatio||!this.allIssuesAreLeaves(e)&&t.issueDoneRatioDerived},allIssuesAreLeaves:function(e){let t=!0;for(let s=0;s<e.length;s++){if(!!gantt._branches[e[s]]){t=!1;break}}return t}}),EasyGem.schedule.require(function(){$.widget("gantt.ganttcomplete",$.ui.autocomplete,{_create:function(){this._super()},_renderMenu:function(e,t){var s=this;$.each(t,function(t,a){s._renderItemData(e,a)}),$(e).attr("data-property","assigned_to")},_renderItem:function(e,t){var s=document.createElement("a"),a="gantt-context-leaf";return t.isChecked&&(a+=" icon-checked"),t.isDisabled&&(a+=" disabled"),s.setAttribute("class",a),s.setAttribute("href","javascript:void(0);"),s.innerHTML=ysy.main.escapeText(t.name),$("<li>").html(s).appendTo(e)}})},"jQueryUI");