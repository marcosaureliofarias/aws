!function(e){function t(t,s){var n=this;this.elements=t,this.options=s,this.preloadBits=function(t,s){e(n.elements.bitsBox).ajaxStop(function(){n.options.ajax.bits.allLoaded(n)}),t.val()?(n.options.ajax.bits.loading(n),e.ajax({url:n.options.ajax.bits.url,method:n.options.ajax.bits.method,data:n.options.ajax.bits.data(t,n),dataType:n.options.ajax.bits.dataType,success:function(t){t.length>0&&e.each(t,function(){n.addItemToBits(this)})},complete:function(){n.options.ajax.bits.loaded(n),s&&s()}})):s&&s()},this.showSuggestionsOrReloadIfChanged=function(e){n.textHasChanged()||n.bitsHaveChanged()||n.dependenciesHaveChanged()?n.loadAndShowSuggestions(e):n.hasSuggestions()&&n.showSuggestionsBox(e)},this.loadAndShowSuggestions=function(t){var s=n.elements.textBox.val();s&&""!=s?(n.options.ajax.suggestions.loading(n),n.options.prepopulated?(n.clearAndHideSuggestionsBox(),n.options.ajax.suggestions.loaded(n),t&&t()):e.ajax({url:n.options.ajax.suggestions.url,method:n.options.ajax.suggestions.method,data:n.options.ajax.suggestions.data(s,n),dataType:n.options.ajax.suggestions.dataType,success:function(e){e.length>0?(n.clearSuggestionsBox(),n.populateSuggestionsBox(e),n.showSuggestionsBox()):n.hideSuggestionsBox()},complete:function(){n.options.ajax.suggestions.loaded(n),n.elements.textBox.focus(),t&&t()}}),n.elements.textBox.data("oldValue",s)):(n.clearAndHideSuggestionsBox(t),n.elements.textBox.data("oldValue",null)),n.elements.bitsBox.data("changed",!1),n.elements.inputContainer.data("dependenciesChanged",!1)},this.populateSuggestionsBox=function(t){e.each(t,function(e){var t=n.createSuggestion(this);t.appendTo(n.elements.suggestionsBox).mouseover(function(){n.selectSuggestion(e,!1)}).mouseout(function(){n.unselectAllSuggestions()}).click(function(){n.addSuggestionToBits(t)})})},this.selectSuggestion=function(t,s){var o=n.elements.suggestionsBox.children(),i=null;i=s?(t%o.length+o.length)%o.length:t<0?0:t>=o.length?o.length-1:t,n.elements.suggestionsBox.data("selected",i),o.removeClass(n.options.classes.suggestionFocus),e(o[i]).addClass(n.options.classes.suggestionFocus)},this.selectSuggestionDiff=function(e,t){var s=n.elements.suggestionsBox.data("selected")+e;n.selectSuggestion(s,t)},this.unselectAllSuggestions=function(){n.elements.suggestionsBox.data("selected",-1),n.elements.suggestionsBox.children().removeClass(n.options.classes.suggestionFocus)},this.hasSuggestions=function(){return n.elements.suggestionsBox.children().length>0},this.hasSelectedSuggestion=function(){return n.elements.suggestionsBox.data("selected")>=0},this.selectedSuggestion=function(){var t=n.elements.suggestionsBox.data("selected");return(!t||t<0)&&(t=0),e(n.elements.suggestionsBox.children()[t])},this.showSuggestionsBox=function(e){n.elements.suggestionsBox.is(":visible")?e&&e():(n.unselectAllSuggestions(),n.elements.suggestionsBox.css({top:n.elements.inputWrapper.outerHeight(),width:n.elements.inputWrapper.parent().width()}),n.elements.suggestionsBox.fadeIn("fast",function(){e&&e()}))},this.hideSuggestionsBox=function(e){n.elements.suggestionsBox.fadeOut("fast",function(){n.unselectAllSuggestions(),e&&e()})},this.clearSuggestionsBox=function(e){n.elements.suggestionsBox.children().remove(),e&&e()},this.clearAndHideSuggestionsBox=function(e){n.elements.suggestionsBox.fadeOut("fast",function(){n.clearSuggestionsBox(),n.unselectAllSuggestions(),e&&e()})},this.addItemToBits=function(e,t){var s=this.createBit(e);s&&s.appendTo(n.elements.bitsBox),t&&t()},this.addSuggestionToBits=function(e,t){return n.elements.bitsBox.data("changed",!0),n.addItemToBits(e.data("record")),this.resetTextBox(),this.clearAndHideSuggestionsBox(function(){n.elements.textBox.focus(),t&&t()}),!1},this.addSelectedSuggestionToBits=function(){n.addSuggestionToBits(n.selectedSuggestion())},this.removeItemFromBits=function(e,t){e.remove(),n.elements.bitsBox.data("changed",!0),n.loadAndShowSuggestions(t)},this.recordIdsInBits=function(t){var s=[],n=0;return t.children().each(function(){s[n++]=e(this).data("record").id}),s},this.resetTextBox=function(){n.elements.textBox.data("oldValue",null).val("")},this.bitsHaveChanged=function(){return n.elements.bitsBox.data("changed")},this.textHasChanged=function(){return n.elements.textBox.data("oldValue")!=n.elements.textBox.val()},this.createBit=function(t){var s=e("<li />",{"class":n.options.classes.bit});return e("<input />",{type:"hidden",name:n.elements.inputName,value:n.options.primaryKeyFromRecord(t)}).appendTo(s),!!n.options.layout.items(n).createBit.call(s,t)&&(s.data("record",t),s)},this.createBitFromSelectOption=function(e){var t={id:e.val()};return n.options.layout.items(n).bitRecordFromOption.call(t,e),this.createBit(t)},this.createSuggestion=function(t){var s=e("<li />",{"class":n.options.classes.suggestion});return n.options.layout.items(n).createSuggestion.call(s,t),s.data("record",t),s},this.detectDependencyChange=function(){var t=n.options.dependencies(n);t&&e.each(t,function(){this&&this.length>0&&this.on("change",function(){n.elements.inputContainer.data("dependenciesChanged",!0)})})},this.dependenciesHaveChanged=function(){return n.elements.inputContainer.data("dependenciesChanged")}}e.suggestible=function(){},e.extend(e.suggestible,{ajax:{bits:{url:null,method:"get",dataType:"json",data:function(){return null},loading:function(){},loaded:function(){}},suggestions:{url:null,method:"get",dataType:"json",data:function(){return null},loading:function(){},loaded:function(){},allLoaded:function(){}}},primaryKeyFromRecord:function(){return null},primaryKeyFromSelectOption:function(){return null},classes:{inputContainer:"input_container suggestible",inputWrapper:"input",bitsBox:"bits",bit:"bit",textBox:null,suggestionsBox:"suggestions",suggestion:"suggestion",suggestionFocus:"focus"},layout:{containers:function(){return null},items:function(){return null}},dependencies:function(){return null},idPrefix:null,idSuffix:"_container",pageStep:5,prepopulated:!1,textBoxDelay:700});var s=function(e,t){var s=t.layout.containers(e,t),n=s.createInputContainer(),o=s.createInputWrapper(),i=s.createBitsBox(),a=s.createTextBox(),u=s.createSuggestionsBox();return i.appendTo(o),a.appendTo(o),o.appendTo(n),u.appendTo(n),{inputName:e.attr("name"),inputContainer:n,inputWrapper:o,bitsBox:i,textBox:a,textBoxTimeout:null,suggestionsBox:u}};e.fn.suggestible=function(n){n=e.extend(!0,{},e.suggestible,n);var o=[];return this.filter("select[multiple]").each(function(i){var a=e(this),u=s(a,n),g=new t(u,n);u.suggestionsBox.hide(),u.inputWrapper.click(function(){u.textBox.focus()}),n.ajax.bits.url&&g.preloadBits(a),a.replaceWith(u.inputContainer),g.detectDependencyChange(),u.textBox.keydown(function(e){switch(e.keyCode){case 8:return 0!=this.selectionStart||this.selectionStart!=this.selectionEnd||(g.removeItemFromBits(u.bitsBox.children(":last")),g.hideSuggestionsBox(),!1);case 9:case 13:var t=u.suggestionsBox.is(":hidden");if(g.hasSuggestions(u.suggestionsBox))if(g.hasSelectedSuggestion(u.suggestionsBox))g.addSelectedSuggestionToBits(),g.hideSuggestionsBox();else if(9==e.keyCode)return!0;return t;case 27:return g.hideSuggestionsBox(),!1;case 33:case 34:case 35:case 36:case 38:case 40:if(g.hasSuggestions(u.suggestionsBox))if(u.suggestionsBox.is(":visible"))switch(e.keyCode){case 33:u.suggestionsBox.data("selected")<=0?g.selectSuggestion(-1,!0):g.selectSuggestionDiff(-n.pageStep,!1);break;case 34:u.suggestionsBox.data("selected")<0||u.suggestionsBox.data("selected")==u.suggestionsBox.children().length-1?g.selectSuggestion(0,!1):g.selectSuggestionDiff(n.pageStep,!1);break;case 35:if(!g.hasSelectedSuggestion())return!0;g.selectSuggestion(-1,!0);break;case 36:if(!g.hasSelectedSuggestion())return!0;g.selectSuggestion(0,!1);break;case 38:u.suggestionsBox.data("selected")<0?g.selectSuggestion(-1,!0):g.selectSuggestionDiff(-1,!0);break;case 40:g.selectSuggestionDiff(1,!0)}else{if(35==e.keyCode||36==e.keyCode)return!0;g.showSuggestionsBox()}else if(35==e.keyCode||36==e.keyCode)return!0;return!1}}).keyup(function(){u.textBox.val()!=u.textBox.data("oldValue")&&(window.clearTimeout(u.textBoxTimeout),u.textBoxTimeout=window.setTimeout(function(){g.showSuggestionsOrReloadIfChanged()},n.textBoxDelay))}).focus(function(){u.inputContainer.trigger("focus"),g.showSuggestionsOrReloadIfChanged()}).blur(function(){u.inputContainer.trigger("blur"),g.hideSuggestionsBox()}),u.inputContainer.data("elements",u),u.inputContainer.data("helpers",g),o[i]=u.inputContainer[0]}),e(o)}}(jQuery);