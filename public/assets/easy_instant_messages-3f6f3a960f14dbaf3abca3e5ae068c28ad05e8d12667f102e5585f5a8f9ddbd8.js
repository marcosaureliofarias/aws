window.EasyInstantMessaging=function(e){var t,s=[],a=window.location.hostname+".EasyInstantMessenger_NotifiedMessageIDs";const n=window.urlPrefix||"";"localStorage"in window&&(s=JSON.parse(localStorage.getItem(a))||[],localStorage.removeItem(a)),this.id=randomKey(3);var i={checkMessageUrl:null,newChatUrl:null,readMessageUrl:null,apiKey:null,defaultTime:7e4,hyperTime:15e3,useRegularOrder:!0,soundEnabled:!0,audioTagId:"easy_instant_message_audio_notice",el:{wrapper:"#easy_instant_messages_wrapper",toggle:"#easy_instant_messages_toggle"}},o=$.extend({},i,e),c=document.getElementById(o.audioTagId);this.newMessagesCount=0,this.settings=function(e){return o[e]};var r=function(e){s.push(e),"localStorage"in window&&localStorage.setItem(a,JSON.stringify(s))},h=function(e){return-1!==(JSON.parse(localStorage.getItem(a))||[]).indexOf(e)};this.init=function(){this.interval=setInterval(this.checkMessages,o.defaultTime,this),this.chatWindow=!1,window.EASY?this.checkMessagesOnPageLoad():this.checkMessages(),this.watchEsc()},this.openChat=function(){this.chatWindow=!0,$(o.el.wrapper).removeClass("easyim__wrapper--hidden"),$(o.el.toggle).addClass("active")},this.closeChat=function(){this.chatWindow=!1,window.clearInterval(this.interval),this.interval=window.setInterval(this.checkMessages,o.defaultTime,this),$(o.el.wrapper).addClass("easyim__wrapper--hidden"),$(o.el.toggle).removeClass("active"),this.displayReceivedMessagesCount()},this.toggleChat=function(e){if(this.chatWindow)return e.stopImmediatePropagation(),e.preventDefault(),this.closeChat(),!1;this.openChat()},this.displayReceivedMessagesCount=function(){var e=$(o.el.toggle);if(this.newMessagesCount>0)if(e.hasClass("change-color-event"))e.children("span").text(this.newMessagesCount);else{e.addClass("change-color-event");var t=$("<span/>").attr("class","sign count").text(this.newMessagesCount);e.append(t)}else e.removeClass("change-color-event"),e.contents().remove(".sign")},this.receiveMessage=function(e){this.setupNotifications();var t=$("#easy_instant_messages_conversation_with_"+e.sender_id);this.chatWindow&&t.size()>0?(document.getElementById($(e.html).attr("id"))||this.pushMessageToChat(e.html),this.readMessage(e),this.newMessagesCount-=1):this.displayReceivedMessagesCount(),this.showNotification(e.sender,e)},this.readMessage=function(e){$.ajax({url:o.readMessageUrl,data:{id:e.id,key:o.apiKey},noLoader:!0,dataType:"json",type:"PUT"})},this.checkMessages=function(e){var t=e||this;$.ajax({url:o.checkMessageUrl,data:{key:o.apiKey},noLoader:!0,dataType:"json",success:function(e){var s=e.easy_instant_messages;t.newMessagesCount=s.length,t.newMessagesCount<=0?t.displayReceivedMessagesCount():$.each(s,function(e,s){t.receiveMessage(s)})}})},this.checkMessagesOnPageLoad=function(){const e=this;EASY.backgroundServices.add("easy_instant_messages",function(t){t&&t.count>0&&e.checkMessages()})},this.showNotification=function(e,s){h(s.id)||(t&&(this.notification=new Notification(e,{body:s.text,lang:s.language,tag:s.tag,icon:s.icon}),this.notification.onclick=function(){window.focus(),window.EasyInstantMessenger.openChat(),$.ajax({url:n+"/easy_instant_messages/"+s.sender_id+"/conversation",dataType:"script",type:"GET"})},c&&"function"==typeof c.play&&c.play()),r(s.id))},this.titleNotification=function(){document.title=document.title.replace(/\(\d+\)\s/,""),this.newMessagesCount>0&&(document.title="("+this.newMessagesCount+") "+document.title)},this.setupNotifications=function(){"Notification"in window&&(t="granted"==Notification.permission,Notification.requestPermission(function(e){Notification.permission!==e&&(Notification.permission=e,t="granted"==Notification.permission)}))},this.newChat=function(e,t){t&&-1!==t.className.indexOf("unread")&&(t.remove(),this.newMessagesCount=this.newMessagesCount-1),$.get(o.newChatUrl,{user_id:e})},this.observeKeyUpInChat=function(e){"13"==e.keyCode?$(e.target.form).submit():"27"==e.keyCode&&this.closeChat()},this.pushMessageToChat=function(e){var t=$("#easy_instant_messages_conversation_messages"),s=$(e);t.append(s);var a=$("#"+s.attr("id"));a.prev().hasClass("mine")||a.prev().find(".easyim__message__avatar").addClass("easyim__message__avatar--hidden"),o.useRegularOrder&&this.scrollToBottomOfChatWindow()},this.scrollToBottomOfChatWindow=function(){var e=document.getElementById("easy_instant_messages_conversation_messages");e&&$(e).scrollTop(e.scrollHeight)},this.supressNotificationFor=function(){localStorage.getItem()},this.watchEsc=function(){var e=this;$(document).keyup(function(t){27===t.keyCode&&e.closeChat()})},this.init(),this.watchSubmitInput=function(){var e=$("#new_easy_instant_message");e.find("#easy_instant_message_content").keypress(function(t){var s=t.keyCode?t.keyCode:t.which;13!=s&&10!=s||(t.preventDefault(),e.submit())})},this.focusSubmitInput=function(){$("#easy_instant_message_content").focus()},this.setDefaultInterval=function(){window.clearInterval(this.interval),this.interval=setInterval(this.checkMessages,o.defaultTime,this)},this.setHyperInterval=function(){window.clearInterval(this.interval),this.interval=setInterval(this.checkMessages,o.hyperTime,this)}},EASY.schedule.late(function(){$("#easy_instant_messages_toggle").click(function(e){EasyInstantMessenger.toggleChat(e)}),$("#easy_instant_messages_top_close").click(function(){EasyInstantMessenger.closeChat()}),$(document).one("focus.autoExpand","textarea.autoExpand",function(){var e=this.value;this.value="",this.baseScrollHeight=this.scrollHeight,this.value=e}).on("input.autoExpand","textarea.autoExpand",function(){var e=1;this.rows=e;var t=Math.ceil((this.scrollHeight-this.baseScrollHeight)/14);this.rows=e+t})});